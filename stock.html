<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trina Designs Stock Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- html2pdf library for direct downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --brand-primary: #4f46e5;
            --brand-secondary: #10b981;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #eff6ff 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.03), 0 8px 10px -6px rgba(0, 0, 0, 0.03);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-item {
            position: relative;
            transition: all 0.3s ease;
        }

        .nav-item::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: #818cf8;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-item:hover::after {
            width: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }

        input, select, textarea {
            transition: all 0.2s ease;
            border: 1px solid transparent !important;
        }

        input:focus, select:focus, textarea:focus {
            background: white !important;
            border-color: #818cf8 !important;
            box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.1) !important;
        }

        .category-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        /* Hide the hidden capture container */
        #pdf-capture-area {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 800px;
            background: white;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-900 antialiased">

    <!-- Container for PDF Generation (Hidden from UI) -->
    <div id="pdf-capture-area"></div>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Navigation -->
        <nav class="bg-slate-900/95 backdrop-blur-md text-white sticky top-0 z-50 border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <div class="flex items-center gap-8">
                        <div class="flex items-center group cursor-pointer" onclick="setView('dashboard')">
                            <div class="bg-indigo-600 p-2 rounded-xl mr-3 group-hover:rotate-12 transition-transform">
                                <i class="fas fa-gem text-white"></i>
                            </div>
                            <span class="text-xl font-extrabold tracking-tight">TRINA DESIGNS</span>
                        </div>
                        <div class="hidden lg:flex items-center space-x-1">
                            <button onclick="setView('dashboard')" class="nav-item px-4 py-2 text-sm font-medium hover:text-indigo-300">Dashboard</button>
                            <button onclick="setView('staff')" class="nav-item px-4 py-2 text-sm font-medium hover:text-indigo-300">Staff Dispatch</button>
                            <button onclick="setView('customers')" class="nav-item px-4 py-2 text-sm font-medium hover:text-indigo-300">External Sales</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <div class="flex items-center bg-white/5 border border-white/10 rounded-2xl px-2 sm:px-3 py-1.5 focus-within:bg-white/10 transition-colors">
                            <i class="fas fa-calendar-alt text-indigo-400 mr-1 sm:mr-2 text-xs sm:text-sm"></i>
                            <input type="date" id="datePicker" class="bg-transparent text-white border-none p-0 focus:ring-0 outline-none text-xs sm:text-sm cursor-pointer w-24 sm:w-32">
                        </div>
                        <button onclick="downloadPDF()" id="downloadBtn" class="hidden sm:flex items-center bg-white text-slate-900 px-5 py-2.5 rounded-2xl font-bold text-sm hover:bg-indigo-50 transition-all shadow-xl active:scale-95">
                            <i class="fas fa-file-pdf mr-2 text-red-500"></i>Download PDF
                        </button>
                        <button onclick="toggleMobileMenu()" class="lg:hidden text-xl p-2"><i class="fas fa-bars"></i></button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div id="mobileMenu" class="hidden fixed inset-0 z-40 bg-slate-900/90 backdrop-blur-xl lg:hidden no-print">
            <div class="flex flex-col items-center justify-center h-full space-y-8 text-2xl font-bold text-white">
                <button onclick="setView('dashboard')">Dashboard</button>
                <button onclick="setView('staff')">Staff Dispatch</button>
                <button onclick="setView('customers')">External Sales</button>
                <button onclick="downloadPDF()" class="text-lg bg-white text-slate-900 px-6 py-2 rounded-xl">Download PDF</button>
                <button onclick="toggleMobileMenu()" class="text-white/40 text-sm font-medium uppercase tracking-widest">Close Menu</button>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-grow px-4 py-8 md:p-10 max-w-7xl mx-auto w-full">
            
            <!-- Dashboard View -->
            <div id="dashboardView" class="animate-fade-in">
                <div class="flex flex-col md:flex-row md:items-end justify-between mb-10 gap-4 border-b border-slate-100 pb-8">
                    <div>
                        <span class="text-indigo-600 font-bold tracking-widest text-xs uppercase mb-2 block">System Analytics</span>
                        <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight" id="currentDateDisplay">Today</h1>
                        <p class="text-slate-500 mt-1 no-print">Real-time inventory and logistics monitoring.</p>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div id="summaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10"></div>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                    <!-- Left: Procurement -->
                    <div class="lg:col-span-4 space-y-8">
                        <div class="glass-card rounded-[2rem] p-8 animate-fade-in stagger-1">
                            <div class="flex items-center justify-between mb-6">
                                <h2 class="text-xl font-bold">Procurement</h2>
                                <button onclick="openProcurementModal()" class="no-print bg-indigo-50 text-indigo-600 hover:bg-indigo-100 p-2 rounded-xl transition-all">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div class="space-y-4" id="procurementDisplay">
                                <!-- Rendered dynamically -->
                            </div>
                        </div>

                        <!-- Verification -->
                        <div class="glass-card rounded-[2rem] p-8 bg-indigo-900 text-white animate-fade-in stagger-2">
                            <h2 class="text-lg font-bold mb-4 flex items-center">
                                <i class="fas fa-check-double mr-2 text-indigo-400"></i> Day Verification
                            </h2>
                            <div class="space-y-4">
                                <label class="flex items-center group cursor-pointer">
                                    <input type="checkbox" id="confirmCheckbox" onchange="saveConfirmation()" class="hidden peer">
                                    <div class="w-6 h-6 border-2 border-white/20 rounded-md flex items-center justify-center mr-3 peer-checked:bg-indigo-500 peer-checked:border-indigo-500 transition-all">
                                        <i class="fas fa-check text-xs text-white"></i>
                                    </div>
                                    <span class="text-sm font-medium text-white/80 group-hover:text-white transition-colors">Stock verified as correct</span>
                                </label>
                                <textarea id="confirmComment" oninput="saveConfirmation()" placeholder="Any discrepancies or notes..." class="w-full p-4 bg-white rounded-2xl border-none text-slate-800 placeholder:text-slate-400 text-sm h-24 outline-none resize-none font-medium shadow-inner focus:ring-2 focus:ring-indigo-400 transition-all"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Activity Ledger -->
                    <div class="lg:col-span-8 animate-fade-in stagger-3">
                        <div class="glass-card rounded-[2rem] p-8 min-h-full flex flex-col">
                            <div class="flex items-center justify-between mb-8">
                                <h2 class="text-xl font-bold">Activity Ledger</h2>
                                <div class="flex gap-2 no-print">
                                    <span class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold" id="activityCount">0 items</span>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto custom-scroll flex-grow">
                                <table class="w-full text-left ledger-table">
                                    <thead>
                                        <tr class="text-[11px] font-bold uppercase text-slate-400 tracking-widest border-b border-slate-100">
                                            <th class="pb-4 px-2">Recipient</th>
                                            <th class="pb-4 px-2">Channel</th>
                                            <th class="pb-4 px-2">Category</th>
                                            <th class="pb-4 px-2">Qty</th>
                                            <th class="pb-4 px-2 text-right no-print"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="dispatchList" class="divide-y divide-slate-50"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Staff View -->
            <div id="staffView" class="hidden animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                    <div class="lg:col-span-7">
                        <div class="glass-card rounded-[2rem] p-10">
                            <h2 class="text-3xl font-extrabold text-slate-900 mb-2">Internal Dispatch</h2>
                            <p class="text-slate-500 mb-10">Record stock issued to your constant team members.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Staff Member</label>
                                    <select id="staffSelect" class="w-full p-4 bg-slate-50 rounded-2xl font-medium appearance-none">
                                        <option value="">Choose Recipient</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Category</label>
                                    <select id="staffCategorySelect" multiple class="w-full p-4 bg-slate-50 rounded-2xl font-medium appearance-none">
                                        <option value="cotton">Cotton Dresses</option>
                                        <option value="sweater">Sweater Dresses</option>
                                        <option value="mother">Mother's Dresses</option>
                                        <option value="kimono">Kimonos</option>
                                        <option value="2pcs">2 Pcs</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2 space-y-2">
                                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Quantity Issued</label>
                                    <input type="number" id="staffQtyInput" placeholder="Enter amount" class="w-full p-4 bg-slate-50 rounded-2xl text-lg font-bold">
                                </div>
                            </div>
                            <button onclick="addDispatch('internal')" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-extrabold text-lg hover:bg-indigo-700 hover:shadow-2xl hover:shadow-indigo-200 transition-all active:scale-95">
                                <i class="fas fa-paper-plane mr-2"></i>Issue to Staff
                            </button>
                        </div>
                    </div>
                    <div class="lg:col-span-5">
                        <div class="glass-card rounded-[2rem] p-10 bg-slate-900 text-white h-full">
                            <h2 class="text-xl font-bold mb-8">Team Registry</h2>
                            <div class="flex gap-2 mb-8">
                                <input type="text" id="newStaffName" placeholder="New staff name..." class="flex-grow p-4 bg-white/10 rounded-2xl border-none outline-none text-white placeholder:text-white/30 font-medium">
                                <button onclick="addStaffMember()" class="bg-indigo-500 hover:bg-indigo-400 px-6 rounded-2xl transition-colors font-bold">Add</button>
                            </div>
                            <div id="staffList" class="space-y-3 overflow-y-auto max-h-[400px] pr-2 custom-scroll"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customers View -->
            <div id="customersView" class="hidden animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                    <div class="lg:col-span-7">
                        <div class="glass-card rounded-[2rem] p-10 border-emerald-100 border-2 shadow-emerald-50 shadow-2xl">
                            <div class="flex items-center gap-4 mb-2">
                                <div class="bg-emerald-100 p-2 rounded-xl">
                                    <i class="fas fa-shopping-basket text-emerald-600"></i>
                                </div>
                                <h2 class="text-3xl font-extrabold text-slate-900">External Sale</h2>
                            </div>
                            <p class="text-slate-500 mb-10">Record purchases from one-time or repeat external customers.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Buyer Profile</label>
                                    <select id="customerSelect" class="w-full p-4 bg-slate-50 rounded-2xl font-medium appearance-none"></select>
                                </div>
                                <div class="space-y-2">
                                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Category</label>
                                    <select id="custCategorySelect" multiple class="w-full p-4 bg-slate-50 rounded-2xl font-medium appearance-none">
                                        <option value="cotton">Cotton Dresses</option>
                                        <option value="sweater">Sweater Dresses</option>
                                        <option value="mother">Mother's Dresses</option>
                                        <option value="kimono">Kimonos</option>
                                        <option value="2pcs">2 Pcs</option>
                                    </select>
                                </div>
                                <div class="md:col-span-2 space-y-2">
                                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Quantity Sold</label>
                                    <input type="number" id="custQtyInput" placeholder="Pieces sold" class="w-full p-4 bg-slate-50 rounded-2xl text-lg font-bold">
                                </div>
                            </div>
                            <button onclick="addDispatch('external')" class="w-full bg-emerald-600 text-white py-5 rounded-2xl font-extrabold text-lg hover:bg-emerald-700 hover:shadow-2xl hover:shadow-emerald-200 transition-all active:scale-95">
                                <i class="fas fa-cash-register mr-2"></i>Complete Sale
                            </button>
                        </div>
                    </div>
                    <div class="lg:col-span-5">
                        <div class="glass-card rounded-[2rem] p-10">
                            <h2 class="text-xl font-bold mb-6">Customer Database</h2>
                            <div class="space-y-4 mb-10 p-6 bg-slate-50 rounded-[1.5rem] border border-slate-100">
                                <input type="hidden" id="editCustomerId">
                                <div class="space-y-4">
                                    <input type="text" id="custName" placeholder="Full Name" class="w-full p-4 bg-white rounded-xl shadow-sm outline-none">
                                    <input type="text" id="custPhone" placeholder="Mobile Contact" class="w-full p-4 bg-white rounded-xl shadow-sm outline-none">
                                    <button onclick="saveCustomer()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-800 transition-all">Save Customer Profile</button>
                                </div>
                            </div>
                            <div id="customerRegistryList" class="space-y-3 max-h-[300px] overflow-y-auto pr-2 custom-scroll"></div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Modal: Procurement Entry -->
        <div id="procurementModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4">
            <div class="glass-card w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-extrabold">Update Stock</h2>
                    <button onclick="closeProcurementModal()" class="text-slate-400 hover:text-slate-900"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="space-y-4 mb-8">
                    <div class="relative">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1 tracking-wider">Cotton Dresses</label>
                        <input type="number" id="in-cotton" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold text-lg" placeholder="0">
                    </div>
                    <div class="relative">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1 tracking-wider">Sweater Dresses</label>
                        <input type="number" id="in-sweater" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold text-lg" placeholder="0">
                    </div>
                    <div class="relative">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1 tracking-wider">Mother's Dresses</label>
                        <input type="number" id="in-mother" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold text-lg" placeholder="0">
                    </div>
                    <div class="relative">
                        <label class="text-[11px] font-bold text-slate-400 uppercase ml-1 tracking-wider">Kimonos</label>
                        <input type="number" id="in-kimono" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold text-lg" placeholder="0">
                    </div>
                </div>
                <button onclick="saveProcurementBatch()" id="btnSaveProc" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-extrabold text-lg hover:bg-slate-800 transition-all flex items-center justify-center gap-2 active:scale-95 shadow-xl">
                    <i class="fas fa-save mr-1"></i> Update Registry
                </button>
            </div>
        </div>

        <footer class="p-10 text-center text-slate-400 text-sm no-print">
            <div class="flex justify-center space-x-6 mb-4">
                <i class="fab fa-instagram"></i>
                <i class="fab fa-facebook"></i>
                <i class="fas fa-envelope"></i>
            </div>
            <p class="font-medium">TRINA DESIGNS • PREMIER STOCK ENGINE &copy; 2024</p>
            <p class="text-[10px] mt-1 opacity-50">DESIGNED FOR EXCELLENCE</p>
        </footer>
    </div>

    <script>
        // --- State Management ---
        let currentDate = new Date().toISOString().split('T')[0];
        let state = {
            procurement: JSON.parse(localStorage.getItem('trina_proc_v2')) || {},
            dispatches: JSON.parse(localStorage.getItem('trina_disp_v2')) || [],
            staff: JSON.parse(localStorage.getItem('trina_staff_v2')) || [],
            customers: JSON.parse(localStorage.getItem('trina_cust_v2')) || [],
            verifications: JSON.parse(localStorage.getItem('trina_verify_v2')) || {}
        };

        const CATEGORIES = {
             cotton: { label: "Cotton Dresses", color: "#6366f1", bg: "#eef2ff", text: "#4338ca" },
             sweater: { label: "Sweater Dresses", color: "#ec4899", bg: "#fdf2f8", text: "#be185d" },
             mother: { label: "Mother's Dresses", color: "#10b981", bg: "#ecfdf5", text: "#047857" },
            kimono: { label: "Kimonos", color: "#f59e0b", bg: "#fffbeb", text: "#b45309" },
            "2pcs": { label: "2 Pcs", color:"#0ea5e9", bg:"#e0f2fe", text:"#0369a1"}
        };


        window.onload = () => {
            const dp = document.getElementById('datePicker');
            dp.value = currentDate;
            dp.addEventListener('change', (e) => {
                currentDate = e.target.value;
                render();
            });
            render();
        };

        async function downloadPDF() {
            const btn = document.getElementById('downloadBtn');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            btn.disabled = true;

            const captureArea = document.getElementById('pdf-capture-area');
            const dateStr = new Date(currentDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            const summary = calculateStock();
            const verification = state.verifications[currentDate] || { checked: false, text: '' };
            const proc = state.procurement[currentDate] || {};

            // Construct a fancy, single-page Dashboard summary for the PDF
            captureArea.innerHTML = `
                <div style="padding: 40px; font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px; margin-bottom: 30px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 800; margin: 0; color: #0f172a;">STOCK AUDIT REPORT</h1>
                            <p style="font-size: 12px; font-weight: 700; color: #4f46e5; margin: 5px 0 0 0; letter-spacing: 2px; text-transform: uppercase;">Trina Designs Operations</p>
                        </div>
                        <div style="text-align: right;">
                            <p style="font-size: 10px; font-weight: 700; color: #94a3b8; margin: 0; text-transform: uppercase;">Audit Date</p>
                            <p style="font-size: 16px; font-weight: 700; margin: 0;">${dateStr}</p>
                        </div>
                    </div>

                    <h2 style="font-size: 14px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 15px; letter-spacing: 1px;">Live Inventory Levels</h2>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 40px;">
                        ${Object.keys(CATEGORIES).map(cat => `
                            <div style="background: #f8fafc; border: 1px solid #f1f5f9; padding: 15px; border-radius: 12px;">
                                <p style="font-size: 9px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin: 0 0 8px 0;">${CATEGORIES[cat].label}</p>
                                <p style="font-size: 24px; font-weight: 900; color: ${CATEGORIES[cat].color}; margin: 0;">${summary[cat]} <span style="font-size: 10px; color: #cbd5e1;">PCS</span></p>
                            </div>
                        `).join('')}
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div>
                            <h2 style="font-size: 14px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 15px; letter-spacing: 1px;">Procurement Inflow</h2>
                            <div style="background: #ffffff; border: 1px solid #f1f5f9; border-radius: 16px; padding: 15px;">
                                ${Object.keys(CATEGORIES).map(cat => `
                                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f8fafc;">
                                        <span style="font-size: 11px; font-weight: 600; color: #475569;">${CATEGORIES[cat].label}</span>
                                        <span style="font-size: 12px; font-weight: 800; color: #1e293b;">+${proc[cat] || 0} items</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div>
                            <h2 style="font-size: 14px; font-weight: 800; text-transform: uppercase; color: #64748b; margin-bottom: 15px; letter-spacing: 1px;">Audit & Verification</h2>
                            <div style="background: ${verification.checked ? '#f0fdf4' : '#fef2f2'}; border: 1px solid ${verification.checked ? '#dcfce7' : '#fee2e2'}; border-radius: 16px; padding: 20px;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="width: 10px; height: 10px; border-radius: 50%; background: ${verification.checked ? '#22c55e' : '#ef4444'}; margin-right: 8px;"></div>
                                    <span style="font-size: 12px; font-weight: 800; color: ${verification.checked ? '#166534' : '#991b1b'};">
                                        ${verification.checked ? 'STOCK VERIFIED AS ACCURATE' : 'PENDING VERIFICATION'}
                                    </span>
                                </div>
                                <p style="font-size: 12px; color: #475569; line-height: 1.6; font-style: italic; margin: 0;">
                                    "${verification.text || 'No discrepancies or additional notes were recorded for this cycle.'}"
                                </p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 50px; border-top: 1px solid #f1f5f9; padding-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <p style="font-size: 9px; color: #94a3b8; font-weight: 600;">GENERATED VIA TRINA DESIGNS STOCK ENGINE • ${new Date().toLocaleString()}</p>
                        <div style="width: 120px; height: 2px; background: #1e293b;"></div>
                    </div>
                </div>
            `;

            const opt = {
                margin: 0,
                filename: `Stock_Audit_${currentDate}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            try {
                await html2pdf().set(opt).from(captureArea).save();
            } catch (err) {
                console.error("PDF generation failed:", err);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                captureArea.innerHTML = ''; // Clean up
            }
        }

        function saveState() {
            localStorage.setItem('trina_proc_v2', JSON.stringify(state.procurement));
            localStorage.setItem('trina_disp_v2', JSON.stringify(state.dispatches));
            localStorage.setItem('trina_staff_v2', JSON.stringify(state.staff));
            localStorage.setItem('trina_cust_v2', JSON.stringify(state.customers));
            localStorage.setItem('trina_verify_v2', JSON.stringify(state.verifications));
            render();
        }

        function setView(view) {
            ['dashboard', 'staff', 'customers'].forEach(v => {
                const el = document.getElementById(`${v}View`);
                if(el) el.classList.add('hidden');
            });
            document.getElementById(`${view}View`).classList.remove('hidden');
            document.getElementById('mobileMenu').classList.add('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        }

        function calculateStock() {
            const summary = { cotton: 0, sweater: 0, mother: 0, kimono: 0 };
            Object.values(state.procurement).forEach(day => {
                Object.keys(CATEGORIES).forEach(cat => summary[cat] += (Number(day[cat]) || 0));
            });
            state.dispatches.forEach(d => {
                if(summary[d.category] !== undefined) summary[d.category] -= (Number(d.qty) || 0);
            });
            return summary;
        }

        function openProcurementModal() {
            const daily = state.procurement[currentDate] || {};
            Object.keys(CATEGORIES).forEach(cat => {
                document.getElementById(`in-${cat}`).value = daily[cat] || "";
            });
            document.getElementById('procurementModal').classList.remove('hidden');
        }

        function closeProcurementModal() {
            document.getElementById('procurementModal').classList.add('hidden');
        }

        function saveProcurementBatch() {
            if (!state.procurement[currentDate]) state.procurement[currentDate] = {};
            Object.keys(CATEGORIES).forEach(cat => {
                const input = document.getElementById(`in-${cat}`);
                state.procurement[currentDate][cat] = Number(input.value) || 0;
            });
            closeProcurementModal();
            saveState();
        }

        function addStaffMember() {
            const name = document.getElementById('newStaffName').value.trim();
            if(!name) return;
            state.staff.push({ id: Date.now(), name });
            document.getElementById('newStaffName').value = '';
            saveState();
        }

        function deleteStaff(id) {
            state.staff = state.staff.filter(s => s.id !== id);
            saveState();
        }

        function addDispatch(type) {
    let recipient, categories, qty;

    if (type === 'internal') {
        recipient = document.getElementById('staffSelect').value;
        categories = Array.from(
            document.getElementById('staffCategorySelect').selectedOptions
        ).map(o => o.value);
        qty = document.getElementById('staffQtyInput').value;
    } else {
        recipient = document.getElementById('customerSelect').value;
        categories = Array.from(
            document.getElementById('custCategorySelect').selectedOptions
        ).map(o => o.value);
        qty = document.getElementById('custQtyInput').value;
    }

    if (!recipient || !categories.length || !qty || qty <= 0) return;

    categories.forEach(category => {
        state.dispatches.push({
            id: Date.now() + Math.random(),
            date: currentDate,
            recipient,
            type,
            category,
            qty: Number(qty)
        });
    });

    document.getElementById('staffQtyInput').value = '';
    document.getElementById('custQtyInput').value = '';

    setView('dashboard');
    saveState();
}

        function deleteDispatch(id) {
            state.dispatches = state.dispatches.filter(d => d.id !== id);
            saveState();
        }

        function saveCustomer() {
            const id = document.getElementById('editCustomerId').value;
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            if(!name) return;
            if(id) {
                const idx = state.customers.findIndex(c => c.id == id);
                state.customers[idx] = { ...state.customers[idx], name, phone };
            } else {
                state.customers.push({ id: Date.now(), name, phone });
            }
            document.getElementById('editCustomerId').value = '';
            document.getElementById('custName').value = '';
            document.getElementById('custPhone').value = '';
            saveState();
        }

        function editCustomer(id) {
            const c = state.customers.find(c => c.id == id);
            document.getElementById('editCustomerId').value = c.id;
            document.getElementById('custName').value = c.name;
            document.getElementById('custPhone').value = c.phone;
        }

        function deleteCustomer(id) {
            state.customers = state.customers.filter(c => c.id != id);
            saveState();
        }

        function saveConfirmation() {
            const checked = document.getElementById('confirmCheckbox').checked;
            const text = document.getElementById('confirmComment').value;
            state.verifications[currentDate] = { checked, text };
            localStorage.setItem('trina_verify_v2', JSON.stringify(state.verifications));
        }

        function render() {
            const dateObj = new Date(currentDate);
            const dateStr = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            document.getElementById('currentDateDisplay').innerText = dateStr;

            const summary = calculateStock();
            const container = document.getElementById('summaryCards');
            if (container) {
                container.innerHTML = '';
                Object.keys(CATEGORIES).forEach(cat => {
                    const c = CATEGORIES[cat];
                    container.innerHTML += `
                        <div class="glass-card rounded-3xl p-6 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-indigo-500/5 rounded-full -mr-10 -mt-10 group-hover:scale-150 transition-transform duration-700"></div>
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-3 flex items-center">
                                <span class="category-dot" style="background: ${c.color}"></span> ${c.label}
                            </p>
                            <div class="flex items-baseline gap-2">
                                <span class="text-4xl font-black" style="color: ${c.color}">${summary[cat]}</span>
                                <span class="text-xs font-bold text-slate-400">PCS</span>
                            </div>
                        </div>
                    `;
                });
            }

            const daily = state.procurement[currentDate] || {};
            const procDisplay = document.getElementById('procurementDisplay');
            if (procDisplay) {
                procDisplay.innerHTML = '';
                Object.keys(CATEGORIES).forEach(cat => {
                    const c = CATEGORIES[cat];
                    const val = daily[cat] || 0;
                    procDisplay.innerHTML += `
                        <div class="flex justify-between items-center bg-white/50 p-4 rounded-2xl border border-slate-100">
                            <div>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${c.label}</p>
                                <p class="text-lg font-black text-slate-800">${val} <span class="text-xs text-slate-400">Items</span></p>
                            </div>
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: ${c.bg}">
                                <i class="fas fa-box text-sm" style="color: ${c.text}"></i>
                            </div>
                        </div>
                    `;
                });
                if (Object.keys(daily).length === 0) {
                    procDisplay.innerHTML = `
                        <div class="py-10 text-center">
                            <p class="text-sm text-slate-400 font-medium mb-4">No procurement logged for today.</p>
                            <button onclick="openProcurementModal()" class="px-6 py-2 bg-slate-900 text-white rounded-xl text-xs font-bold">Add Today's Stock</button>
                        </div>
                    `;
                }
            }

            const dailyLog = state.dispatches.filter(d => d.date === currentDate);
            const countEl = document.getElementById('activityCount');
            if (countEl) countEl.innerText = `${dailyLog.length} Records`;
            
            const listEl = document.getElementById('dispatchList');
            if (listEl) {
                listEl.innerHTML = dailyLog.length ? '' : '<tr><td colspan="5" class="py-20 text-center text-slate-400 font-medium">No activity for this date</td></tr>';
                dailyLog.forEach(d => {
                    const isInternal = d.type === 'internal';
                    const c = CATEGORIES[d.category];
                    listEl.innerHTML += `
                        <tr class="group hover:bg-white/40 transition-colors">
                            <td class="py-5 px-2">
                                <div class="font-bold text-slate-800">${d.recipient}</div>
                            </td>
                            <td class="py-5 px-2">
                                <span class="text-[10px] font-black uppercase px-2 py-1 rounded-md ${isInternal ? 'bg-indigo-50 text-indigo-600' : 'bg-emerald-50 text-emerald-600'}">
                                    ${isInternal ? 'Team' : 'Customer'}
                                </span>
                            </td>
                            <td class="py-5 px-2">
                                <span class="text-xs font-bold px-3 py-1 rounded-full" style="background: ${c.bg}; color: ${c.text}">
                                    ${c.label}
                                </span>
                            </td>
                            <td class="py-5 px-2 font-black text-slate-700">${d.qty}</td>
                            <td class="py-5 px-2 text-right no-print">
                                <button onclick="deleteDispatch(${d.id})" class="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            const staffSel = document.getElementById('staffSelect');
            if (staffSel) staffSel.innerHTML = '<option value="">Choose Recipient</option>' + state.staff.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            
            const custSel = document.getElementById('customerSelect');
            if (custSel) custSel.innerHTML = '<option value="">Choose Profile</option>' + state.customers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            const sList = document.getElementById('staffList');
            if (sList) {
                sList.innerHTML = state.staff.map(s => `
                    <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 hover:bg-white/10 transition-colors">
                        <span class="font-bold">${s.name}</span>
                        <button onclick="deleteStaff(${s.id})" class="text-white/20 hover:text-red-400 transition-colors"><i class="fas fa-times"></i></button>
                    </div>
                `).join('') || '<p class="text-center text-white/20 py-10">No staff members</p>';
            }

            const custReg = document.getElementById('customerRegistryList');
            if (custReg) {
                custReg.innerHTML = state.customers.map(c => `
                    <div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-sm border border-slate-100 group">
                        <div>
                            <div class="font-bold text-slate-900">${c.name}</div>
                            <div class="text-[10px] font-bold text-slate-400">${c.phone || 'NO CONTACT'}</div>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editCustomer(${c.id})" class="p-2 text-indigo-400 hover:bg-indigo-50 rounded-lg"><i class="fas fa-edit text-sm"></i></button>
                            <button onclick="deleteCustomer(${c.id})" class="p-2 text-red-300 hover:bg-red-50 rounded-lg"><i class="fas fa-trash text-sm"></i></button>
                        </div>
                    </div>
                `).join('') || '<p class="text-center text-slate-400 py-10 font-medium">Registry Empty</p>';
            }

            const verify = state.verifications[currentDate] || { checked: false, text: '' };
            const chk = document.getElementById('confirmCheckbox');
            const comm = document.getElementById('confirmComment');
            if (chk) chk.checked = verify.checked;
            if (comm) comm.value = verify.text;
        }
    </script>
</body>
</html>
