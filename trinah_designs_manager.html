<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinah Designs Business Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load jsPDF for Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.7);
        }
        /* PDF loader styles */
        #pdf-loader { position: fixed; inset: 0; z-index: 60; display: flex; align-items: center; justify-content: center; }
        .pdf-loader-backdrop { position: absolute; inset: 0; background: rgba(15,23,42,0.6); }
        .pdf-loader-box {
            position: relative; z-index: 61; width: 320px; padding: 18px 20px;
            border-radius: 12px; background: #ffffff;
            box-shadow: 0 10px 30px rgba(2,6,23,0.5);
            display: flex; gap: 12px; align-items: center;
        }
        .pdf-spinner {
            width: 38px; height: 38px; border-radius: 50%;
            border: 4px solid #e6edf8; border-top-color: #1E3A8A;
            animation: pdfspin 1s linear infinite;
        }
        @keyframes pdfspin { to { transform: rotate(360deg); } }
        .pdf-loader-text { font-weight:600; font-size:14px; color: #0f172a; }
        
        /* Mobile Menu Transitions */
        #mobile-menu { transition: transform 0.3s ease-in-out; }
        .translate-x-full { transform: translateX(100%); }
        .translate-x-0 { transform: translateX(0); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen"></div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 transform opacity-0 -translate-y-full" style="display: none;"></div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- PDF Loader -->
    <div id="pdf-loader" style="display:none;">
        <div class="pdf-loader-backdrop"></div>
        <div class="pdf-loader-box">
            <div class="pdf-spinner"></div>
            <div class="pdf-loader-text">Generating report — please wait...</div>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        const BUY_PRICE = 120;
        const SELL_PRICE = 200;
        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const REPORT_TYPES = ["Daily", "Weekly", "Monthly", "Quarterly", "Yearly"];

        // Local Storage Keys
        const DB_KEY = "trinah_users_db";
        const SESSION_KEY = "trinah_active_session";

        // View States
        const VIEW_DASHBOARD = 'dashboard';
        const VIEW_USERS = 'users';

        // Global State Variables
        let currentUser = null;
        let currentView = VIEW_DASHBOARD;
        let history = []; 
        let archive = []; 
        let startingPressure = 0; 
        let selectedDayIndex = 0;
        let selectedReport = "Daily"; 
        
        // Auth State
        let isLogin = true;
        let authError = "";
        let authLoading = false;

        const appElement = document.getElementById('app');
        const notificationContainer = document.getElementById('notification-container');
        const modalContainer = document.getElementById('modal-container');

        // --- Utility Functions ---

        function renderIcon(name, attributes = {}) {
            if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                const icons = lucide.createIcons();
                if (icons && icons[name]) {
                    return icons[name].toSvg(attributes);
                }
            }
            return `<i data-lucide="${name}" class="${attributes.class || ''}"></i>`;
        }

        function refreshIcons() {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }

        function saveData(phone) {
            localStorage.setItem(`trinah_current_week_${phone}`, JSON.stringify(history));
            localStorage.setItem(`trinah_archive_${phone}`, JSON.stringify(archive));
            localStorage.setItem(`trinah_starting_pressure_${phone}`, startingPressure.toString());
        }

        function loadData(user) {
            const phone = user.phone;
            const savedHistory = localStorage.getItem(`trinah_current_week_${phone}`);
            if (savedHistory) history = JSON.parse(savedHistory);
            
            const savedArchive = localStorage.getItem(`trinah_archive_${phone}`);
            if (savedArchive) archive = JSON.parse(savedArchive);
            
            const savedPressure = localStorage.getItem(`trinah_starting_pressure_${phone}`);
            startingPressure = savedPressure ? Number(savedPressure) : 0;

            if (history.length === 0 && archive.length > 0) {
                startingPressure = archive[archive.length - 1].remaining;
            }

            // Set default day to today
            const jsDay = new Date().getDay();
            const mappedDay = jsDay === 0 ? 6 : jsDay - 1;
            selectedDayIndex = mappedDay;
            
            renderApp();
        }

        function showNotification(msg) {
            notificationContainer.innerHTML = `
                <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-medium flex items-center gap-2">
                    ${msg.includes("Locked") ? renderIcon('lock', { class: 'w-4 h-4' }) : ''}
                    ${msg}
                </div>`;
            notificationContainer.style.display = 'block';
            
            requestAnimationFrame(() => {
                notificationContainer.classList.remove('opacity-0', '-translate-y-full');
                notificationContainer.classList.add('opacity-100', 'translate-y-5');
                refreshIcons();
            });

            setTimeout(() => {
                notificationContainer.classList.remove('opacity-100', 'translate-y-5');
                notificationContainer.classList.add('opacity-0', '-translate-y-full');
                setTimeout(() => notificationContainer.style.display = 'none', 300);
            }, 3000);
        }

        function formatCurrency(val) {
            return `KES ${val.toLocaleString()}`;
        }

        function getFullHistory() {
            return [...archive, ...history];
        }

        function isEntryLocked(entry) {
            if (!entry) return false;
            const entryTime = new Date(entry.id);
            const deadline = new Date(entryTime);
            deadline.setDate(deadline.getDate() + 1);
            deadline.setHours(9, 0, 0, 0); 
            return new Date() > deadline;
        }

        function getFilteredHistory() {
            const fullHistory = getFullHistory();
            const now = new Date();
            const nowLocaleDate = now.toLocaleDateString();

            return fullHistory.filter(entry => {
                // Ensure date object is created from the stored fullDate (the date the transaction happened)
                const entryFullDateObj = new Date(entry.fullDate);

                // Skip if date is invalid
                if (isNaN(entryFullDateObj)) return false;

                // Strip time components for accurate day-level comparison by setting time to 00:00:00
                const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const entryMidnight = new Date(entryFullDateObj.getFullYear(), entryFullDateObj.getMonth(), entryFullDateObj.getDate());
                
                switch (selectedReport) {
                    case "Daily": 
                        // Only show entries for the current calendar day
                        return entry.fullDate === nowLocaleDate;

                    case "Weekly": {
                        // Show entries from the last 7 days (including today)
                        const oneWeekAgo = new Date(todayMidnight);
                        oneWeekAgo.setDate(todayMidnight.getDate() - 7);
                        return entryMidnight >= oneWeekAgo;
                    }
                    case "Monthly": {
                        // Show entries from the last 30 days
                        const oneMonthAgo = new Date(todayMidnight);
                        oneMonthAgo.setDate(todayMidnight.getDate() - 30);
                        return entryMidnight >= oneMonthAgo;
                    }
                    case "Quarterly": {
                        // Show entries from the last 90 days
                        const ninetyDaysAgo = new Date(todayMidnight);
                        ninetyDaysAgo.setDate(todayMidnight.getDate() - 90);
                        return entryMidnight >= ninetyDaysAgo;
                    }
                    case "Yearly": {
                        // Show entries from the last 365 days
                        const oneYearAgo = new Date(todayMidnight);
                        oneYearAgo.setFullYear(todayMidnight.getFullYear() - 1);
                        return entryMidnight >= oneYearAgo;
                    }
                    default: return true;
                }
            });
        }


        // --- Navigation ---

        function setView(view) {
            currentView = view;
            renderApp();
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const overlay = document.getElementById('mobile-menu-overlay');
            if (menu && overlay) {
                const isClosed = menu.classList.contains('translate-x-full');
                if (isClosed) {
                    menu.classList.remove('translate-x-full');
                    menu.classList.add('translate-x-0');
                    overlay.classList.remove('hidden');
                } else {
                    menu.classList.add('translate-x-full');
                    menu.classList.remove('translate-x-0');
                    overlay.classList.add('hidden');
                }
            }
        }

        // --- Auth ---

        function handleLogin(user) {
            authError = "";
            authLoading = false;
            currentUser = user;
            localStorage.setItem(SESSION_KEY, JSON.stringify(user));
            loadData(user);
            setView(VIEW_DASHBOARD);
        }

        function handleLogout() {
            if (currentUser) saveData(currentUser.phone);
            currentUser = null;
            localStorage.removeItem(SESSION_KEY);
            history = [];
            archive = [];
            startingPressure = 0;
            renderApp();
        }

        function handleSwitchUser(user) {
            if (currentUser) saveData(currentUser.phone);
            handleLogin(user);
        }

        function toggleAuthMode(login) {
            isLogin = login;
            authError = '';
            renderAuthScreen();
        }

        function authHandler(e) {
            e.preventDefault();
            const phone = document.getElementById('auth-phone').value.trim();
            const password = document.getElementById('auth-password').value.trim();
            
            if (!phone || !password) {
                authError = "Please enter both phone number and password.";
                renderAuthScreen();
                return;
            }

            authLoading = true;
            renderAuthScreen();

            setTimeout(() => {
                let users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
                let user = null;
                authError = ""; 

                if (isLogin) {
                    user = users.find(u => u.phone === phone && u.password === password);
                    if (user) {
                        handleLogin(user);
                    } else {
                        authError = "Invalid phone number or password.";
                    }
                } else { 
                    const exists = users.find(u => u.phone === phone);
                    if (exists) {
                        authError = "User already exists. Please log in.";
                    } else {
                        const newUser = { 
                            phone, 
                            password, 
                            name: `User ${phone.substring(phone.length - 4)}` 
                        };
                        users.push(newUser);
                        localStorage.setItem(DB_KEY, JSON.stringify(users));
                        handleLogin(newUser);
                    }
                }
                
                authLoading = false;
                if (!currentUser) renderAuthScreen();
            }, 800);
        }

        // --- Core Logic ---

        function handleSubmit() {
            const dispatchInput = document.getElementById('dispatch-input');
            const salesInput = document.getElementById('sales-input');

            const numDispatch = Number(dispatchInput.value) || 0;
            const numSales = Number(salesInput.value) || 0;

            if (numDispatch === 0 && numSales === 0) {
                showNotification("Please enter dispatch or sales amount.");
                return;
            }

            const now = new Date();
            const jsDay = now.getDay(); 
            const mappedDay = jsDay === 0 ? 6 : jsDay - 1; 

            // Allow Today (mappedDay) or any Past Day (selectedDayIndex < mappedDay)
            // Block Future Days (selectedDayIndex > mappedDay)
            if (selectedDayIndex > mappedDay) {
                showNotification("Cannot add future entries.");
                return;
            }

            // Determine the correct date for the entry based on selection
            // Calculate the difference in days
            const dayDiff = mappedDay - selectedDayIndex;
            const targetDate = new Date();
            targetDate.setDate(now.getDate() - dayDiff); // Correctly sets the calendar date

            const currentDayName = DAYS[selectedDayIndex];
            const fullDateString = targetDate.toLocaleDateString();

            const prevRemaining = getFullHistory().length > 0
                    ? getFullHistory()[getFullHistory().length - 1].remaining
                    : startingPressure;

            const newRemaining = prevRemaining + numDispatch - numSales;

            if (newRemaining < 0) {
                showNotification("Error: Sales cannot exceed inventory.");
                return;
            }

            const record = {
                id: Date.now(), // Unique ID (Timestamp of creation)
                date: currentDayName, // Day of the week
                fullDate: fullDateString, // Actual calendar date (e.g., "11/24/2025")
                dispatched: numDispatch,
                sold: numSales,
                remaining: newRemaining,
                profit: numSales * (SELL_PRICE - BUY_PRICE),
            };

            history.push(record);
            startingPressure = newRemaining;

            dispatchInput.value = "";
            salesInput.value = "";

            saveData(currentUser.phone);

            if (currentDayName === "Sunday") {
                renderWeekCompleteModal();
                renderDashboard();
                return;
            }

            let notificationMessage = `Saved entry for ${currentDayName} (${fullDateString})!`;

            // Auto-advance only if we are not at the current day limit
            if (selectedDayIndex < mappedDay) {
                // If we submit for yesterday, automatically switch to today's entry tab
                selectedDayIndex = selectedDayIndex + 1;
                notificationMessage += ` Switched to ${DAYS[selectedDayIndex]}.`;
            }

            showNotification(notificationMessage);
            renderDashboard();
        }

        function handleStartNewWeek() {
            const modal = document.getElementById('week-complete-modal');
            if (modal) modal.remove();

            const finalPressure = getFullHistory().length > 0 ? getFullHistory()[getFullHistory().length - 1].remaining : startingPressure;
            
            archive = [...archive, ...history];
            history = []; 
            startingPressure = finalPressure; 
            selectedDayIndex = 0; 
            
            saveData(currentUser.phone);
            showNotification("New week started!");
            renderDashboard();
        }

        function handleDeleteLast() {
            const fullHistory = getFullHistory();
            const lastEntry = history[history.length - 1]; 

            if (!lastEntry) return;

            if (isEntryLocked(lastEntry)) {
                showNotification("Locked: 9AM deadline passed.");
                return;
            }

            history.pop();
            
            const newLastEntry = getFullHistory()[getFullHistory().length - 1];
            startingPressure = newLastEntry 
                ? newLastEntry.remaining
                : archive.length > 0 ? archive[archive.length - 1].remaining : 0;
            
            const dayIndex = DAYS.indexOf(lastEntry.date);
            if (dayIndex !== -1) selectedDayIndex = dayIndex;

            saveData(currentUser.phone);
            showNotification(`Entry deleted.`);
            renderDashboard();
        }

        // --- PDF Generation ---
        
        async function downloadReport(data = getFilteredHistory(), reportName = selectedReport) {
            if (data.length === 0) {
                showNotification(`No data found for ${reportName} report.`);
                return;
            }

            const loader = document.getElementById('pdf-loader');
            if (loader) loader.style.display = 'flex';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

                const PRIMARY = "#1E3A8A";
                const SECONDARY = "#3B82F6";
                const MARGIN_LEFT = 40;
                const PAGE_WIDTH = doc.internal.pageSize.getWidth();
                const PAGE_HEIGHT = doc.internal.pageSize.getHeight();

                const totalProfit = data.reduce((sum, r) => sum + (Number(r.profit) || 0), 0);
                const totalSold = data.reduce((sum, r) => sum + (Number(r.sold) || 0), 0);
                const totalDispatch = data.reduce((sum, r) => sum + (Number(r.dispatched) || 0), 0);

                let y = 40;
                
                // Header
                doc.setFillColor(PRIMARY);
                doc.rect(0, 0, PAGE_WIDTH, 60, 'F');
                doc.setTextColor("#ffffff");
                doc.setFontSize(16);
                doc.setFont("Helvetica", "bold");
                doc.text(`Trinah Designs — ${reportName} Report`, MARGIN_LEFT, 38);
                
                doc.setFontSize(10);
                doc.setFont("Helvetica", "normal");
                doc.text(`Account: ${currentUser ? currentUser.name : "N/A"}`, MARGIN_LEFT, 100);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, MARGIN_LEFT, 115);

                y = 150;

                // Summary Stats
                doc.setTextColor("#0f172a");
                doc.setFontSize(12);
                doc.setFont("Helvetica", "bold");
                doc.text("Summary Overview", MARGIN_LEFT, y);
                y += 20;
                
                doc.setFont("Helvetica", "normal");
                doc.setFontSize(11);
                doc.text(`Total Sales: ${totalSold} units`, MARGIN_LEFT, y); y += 15;
                doc.text(`Total Dispatch: ${totalDispatch} units`, MARGIN_LEFT, y); y += 15;
                doc.text(`Total Profit: KES ${totalProfit.toLocaleString()}`, MARGIN_LEFT, y); y += 30;

                // Table Header
                doc.setFillColor(SECONDARY);
                doc.rect(MARGIN_LEFT, y, PAGE_WIDTH - (MARGIN_LEFT*2), 25, 'F');
                doc.setTextColor("#ffffff");
                doc.setFont("Helvetica", "bold");
                doc.text("Date", MARGIN_LEFT + 10, y + 17);
                doc.text("Sold", MARGIN_LEFT + 120, y + 17);
                doc.text("Rem.", MARGIN_LEFT + 200, y + 17);
                doc.text("Profit (KES)", MARGIN_LEFT + 280, y + 17);
                
                y += 45;
                doc.setTextColor("#000000");
                doc.setFont("Helvetica", "normal");

                data.forEach(item => {
                    doc.text(item.fullDate, MARGIN_LEFT + 10, y);
                    doc.text(String(item.sold), MARGIN_LEFT + 120, y);
                    doc.text(String(item.remaining), MARGIN_LEFT + 200, y);
                    doc.text(item.profit.toLocaleString(), MARGIN_LEFT + 280, y);
                    y += 20;
                });

                doc.save(`Trinah_${reportName}_Report.pdf`);
                showNotification("PDF Downloaded!");

            } catch (err) {
                console.error("PDF Error", err);
                showNotification("Failed to generate PDF.");
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }

        // --- Renderers ---

        function renderWeekCompleteModal() {
            const finalPressure = history.length > 0 ? history[history.length - 1].remaining : startingPressure;
            const weekData = history;
            
            const modalHTML = `
                <div id="week-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 transition-opacity" onclick="document.getElementById('week-complete-modal').remove()"></div>
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm relative z-10 text-center">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Week Completed!</h2>
                        <p class="text-slate-600 mb-4 text-sm">
                            Final Inventory: <span class="font-bold text-orange-600"> ${finalPressure} units </span> 
                        </p>
                        <div class="space-y-3">
                            <button onclick="downloadReport(history, 'Weekly_Completed'); document.getElementById('week-complete-modal').remove();" class="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold">Download Report</button>
                            <button onclick="handleStartNewWeek()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Start New Week</button>
                            <button onclick="document.getElementById('week-complete-modal').remove()" class="w-full py-3 bg-slate-100 text-slate-600 rounded-xl">Close</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
        }

        function renderHeader() {
            return `
                <header class="sticky top-0 z-40 w-full bg-white/80 backdrop-blur-md border-b border-slate-200 shadow-sm">
                    <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">T</div>
                            <div class="flex flex-col">
                                <span class="text-lg font-bold text-indigo-900 leading-none">Trinah Designs</span>
                                <span class="text-[10px] text-slate-500">${currentUser ? currentUser.name : ''}</span>
                            </div>
                        </div>

                        <!-- Desktop Nav -->
                        <nav class="hidden md:flex items-center gap-4">
                            <button onclick="setView('${VIEW_USERS}')" class="text-sm font-medium text-slate-600 hover:text-indigo-600 flex items-center gap-2">
                                ${renderIcon('users', {class:'w-4 h-4'})} Users
                            </button>
                            <button onclick="downloadReport()" class="text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg hover:bg-indigo-100 flex items-center gap-2">
                                ${renderIcon('download', {class:'w-4 h-4'})} Download ${selectedReport}
                            </button>
                            <button onclick="handleLogout()" class="text-sm font-medium text-red-500 hover:text-red-700">Logout</button>
                        </nav>

                        <!-- Mobile Menu Button -->
                        <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-slate-600 hover:bg-slate-100 rounded-lg">
                            ${renderIcon('menu', { class: 'w-6 h-6' })}
                        </button>
                    </div>
                </header>

                <!-- Mobile Menu Overlay -->
                <div id="mobile-menu-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-40 hidden"></div>

                <!-- Mobile Menu Sidebar -->
                <div id="mobile-menu" class="fixed right-0 top-0 h-full w-72 bg-white shadow-2xl z-50 p-6 flex flex-col gap-6 translate-x-full">
                    <div class="flex justify-between items-center border-b border-slate-100 pb-4">
                        <span class="text-lg font-bold text-slate-800">Menu</span>
                        <button onclick="toggleMobileMenu()" class="p-2 hover:bg-slate-100 rounded-full text-slate-500">
                            ${renderIcon('x', { class: 'w-6 h-6' })}
                        </button>
                    </div>
                    <div class="space-y-3">
                        <button onclick="setView('${VIEW_DASHBOARD}'); toggleMobileMenu();" class="flex items-center gap-3 w-full p-3 rounded-xl bg-slate-50 text-slate-700">
                            ${renderIcon('home', {class:'w-5 h-5'})} Dashboard
                        </button>
                         <button onclick="setView('${VIEW_USERS}'); toggleMobileMenu();" class="flex items-center gap-3 w-full p-3 rounded-xl bg-slate-50 text-slate-700">
                            ${renderIcon('users', {class:'w-5 h-5'})} Manage Users
                        </button>
                        <button onclick="downloadReport(); toggleMobileMenu();" class="flex items-center gap-3 w-full p-3 rounded-xl bg-indigo-50 text-indigo-700">
                            ${renderIcon('download', {class:'w-5 h-5'})} Download ${selectedReport}
                        </button>
                        <button onclick="handleLogout()" class="flex items-center gap-3 w-full p-3 rounded-xl bg-red-50 text-red-600 mt-auto">
                            ${renderIcon('log-out', {class:'w-5 h-5'})} Log Out
                        </button>
                    </div>
                </div>
            `;
        }

        function renderStatCard(title, value, iconName, colorClass) {
            return `
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-4 flex items-center justify-between">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">${title}</p>
                        <p class="text-xl font-bold ${colorClass}">${value}</p>
                    </div>
                    <div class="p-2 rounded-lg bg-white shadow-sm">
                        ${renderIcon(iconName, { class: `w-5 h-5 ${colorClass}` })}
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const fullHistory = getFullHistory();
            const lastEntry = fullHistory.length > 0 ? fullHistory[fullHistory.length - 1] : null;
            const currentPressure = lastEntry ? lastEntry.remaining : startingPressure;
            
            const now = new Date();
            const today = now.toLocaleDateString();

            const filledDays = history.filter(entry => entry.fullDate === today).map(entry => entry.date);
            const filteredData = getFilteredHistory();
            const totalProfit = filteredData.reduce((sum, entry) => sum + entry.profit, 0);
            
            // Only count today's sales specifically
            const todaysSales = history
                .filter(entry => entry.fullDate === today)
                .reduce((sum, entry) => sum + entry.sold, 0);

            appElement.innerHTML = `
                ${renderHeader()}
                <main class="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${renderStatCard("Pressure", currentPressure, "gauge", "text-orange-600")}
                        ${renderStatCard("Profit", formatCurrency(totalProfit), "dollar-sign", "text-emerald-600")}
                        ${renderStatCard("Today Sold", todaysSales, "trending-up", "text-amber-600")}
                        ${renderStatCard("Entries", filteredData.length, "file-text", "text-purple-600")}
                    </div>

                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Input Section -->
                        <div class="md:col-span-1 space-y-6">
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                                <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    ${renderIcon('plus-circle', {class:'w-5 h-5 text-indigo-600'})} New Entry
                                </h2>

                                <!-- Day Selection -->
                                <div class="grid grid-cols-4 gap-2 mb-4">
                                    ${DAYS.map((d, i) => {
                                        const jsDay = now.getDay();
                                        const mappedDay = jsDay === 0 ? 6 : jsDay - 1;
                                        
                                        // Lock future days
                                        const isLocked = i > mappedDay;
                                        
                                        return `
                                            <button 
                                                onclick="selectedDayIndex = ${i}; renderDashboard();"
                                                ${isLocked ? 'disabled' : ''}
                                                class="text-[10px] p-2 rounded-lg text-center font-bold transition-all
                                                ${selectedDayIndex === i ? 'bg-indigo-600 text-white shadow-md' : 
                                                  (isLocked ? 'bg-slate-100 text-slate-300 cursor-not-allowed' : 'bg-white border border-slate-200 text-slate-600 hover:bg-slate-50')}">
                                                ${d.substring(0,3)}
                                            </button>
                                        `;
                                    }).join('')}
                                </div>

                                <div class="space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-slate-500">DISPATCH</label>
                                        <input type="number" id="dispatch-input" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500" placeholder="0">
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500">SOLD</label>
                                        <input type="number" id="sales-input" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500" placeholder="0">
                                    </div>
                                    <button onclick="handleSubmit()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Add Record</button>
                                </div>
                            </div>

                            <!-- Last Entry Control -->
                            ${lastEntry ? `
                            <div class="bg-white rounded-2xl shadow p-4 border border-slate-100">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs font-bold text-slate-400">LAST ENTRY</span>
                                    <span class="text-xs font-bold text-slate-600">${lastEntry.date} (${lastEntry.fullDate})</span>
                                </div>
                                <button onclick="handleDeleteLast()" class="w-full py-2 bg-red-50 text-red-600 rounded-lg text-sm font-bold hover:bg-red-100 flex items-center justify-center gap-2">
                                    ${renderIcon('trash-2', {class:'w-4 h-4'})} Delete Last
                                </button>
                            </div>` : ''}
                        </div>

                        <!-- Report Section (Replaces Graph) -->
                        <div class="md:col-span-2">
                            <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 h-full">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <h2 class="text-lg font-bold text-slate-800">Business Reports</h2>
                                        <p class="text-sm text-slate-500">Select a timeframe to view and download.</p>
                                    </div>
                                    <div class="flex bg-slate-100 p-1 rounded-lg">
                                        ${REPORT_TYPES.map(type => `
                                            <button onclick="selectedReport='${type}'; renderDashboard();" 
                                                class="px-3 py-1 text-xs font-bold rounded-md transition ${selectedReport === type ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}">
                                                ${type}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="overflow-y-auto max-h-[400px]">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                                            <tr>
                                                <th class="px-4 py-3 rounded-l-lg">Date</th>
                                                <th class="px-4 py-3">Dispatch</th>
                                                <th class="px-4 py-3">Sold</th>
                                                <th class="px-4 py-3">Profit</th>
                                                <th class="px-4 py-3 rounded-r-lg">Rem.</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100">
                                            ${filteredData.length > 0 ? filteredData.map(d => `
                                                <tr class="hover:bg-slate-50">
                                                    <td class="px-4 py-3 font-medium text-slate-900">${d.fullDate} <span class="text-slate-400 text-xs block">${d.date.substring(0,3)}</span></td>
                                                    <td class="px-4 py-3 text-slate-600">${d.dispatched}</td>
                                                    <td class="px-4 py-3 text-emerald-600 font-bold">${d.sold}</td>
                                                    <td class="px-4 py-3 text-slate-600">${d.profit}</td>
                                                    <td class="px-4 py-3 text-orange-600 font-bold">${d.remaining}</td>
                                                </tr>
                                            `).reverse().join('') : `
                                                <tr>
                                                    <td colspan="5" class="text-center py-8 text-slate-400">
                                                        No records found for ${selectedReport} view.
                                                    </td>
                                                </tr>
                                            `}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-slate-100 flex justify-end">
                                    <button onclick="downloadReport()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2">
                                        ${renderIcon('file-down', {class:'w-4 h-4'})} Download ${selectedReport} PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            `;
            
            refreshIcons();
        }

        function renderAuthScreen() {
            appElement.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4">T</div>
                            <h1 class="text-2xl font-bold text-slate-800">Trinah Designs</h1>
                        </div>

                        <!-- Login / Sign Up Toggle -->
                        <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                            <button onclick="window.toggleAuthMode(true)" class="flex-1 py-2 text-sm font-bold rounded-lg transition ${isLogin ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}">Login</button>
                            <button onclick="window.toggleAuthMode(false)" class="flex-1 py-2 text-sm font-bold rounded-lg transition ${!isLogin ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}">Sign Up</button>
                        </div>

                        <form onsubmit="window.authHandler(event)" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500">PHONE</label>
                                <input type="text" id="auth-phone" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500" placeholder="0712 345 678">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500">PASSWORD</label>
                                <input type="password" id="auth-password" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500" placeholder="••••••••">
                            </div>
                            ${authError ? `<p class="text-red-500 text-sm text-center bg-red-50 p-2 rounded-lg">${authError}</p>` : ''}
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition" ${authLoading ? 'disabled' : ''}>
                                ${authLoading ? 'Processing...' : (isLogin ? 'Access Dashboard' : 'Create Account')}
                            </button>
                        </form>
                    </div>
                </div>
            `;
            refreshIcons();
        }

        function renderUserManagementScreen() {
            const storedUsers = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            appElement.innerHTML = `
                ${renderHeader()}
                <main class="max-w-xl mx-auto p-4 md:p-6 space-y-6">
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Manage Accounts</h2>
                        <p class="text-sm text-slate-500 mb-6">You can switch between existing accounts or log out.</p>

                        <div class="space-y-3">
                            ${storedUsers.map(user => {
                                const isActive = user.phone === currentUser.phone;
                                return `
                                    <div onclick="${!isActive ? `handleSwitchUser({phone:'${user.phone}', password:'${user.password}', name:'${user.name}'})` : ''}" 
                                         class="p-4 rounded-xl border flex justify-between items-center cursor-pointer ${isActive ? 'bg-indigo-50 border-indigo-200' : 'hover:bg-slate-50 border-slate-200'}">
                                        <div class="flex items-center gap-3">
                                            <div class="p-2 rounded-full ${isActive ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-600'}">
                                                ${renderIcon('user', {class:'w-4 h-4'})}
                                            </div>
                                            <div>
                                                <p class="font-bold text-slate-800">${user.name}</p>
                                                <p class="text-xs text-slate-500">${user.phone}</p>
                                            </div>
                                        </div>
                                        ${isActive ? `<span class="text-xs font-bold text-indigo-600">Active</span>` : `<span class="text-xs font-bold text-slate-400">Switch</span>`}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <button onclick="handleLogout()" class="mt-6 w-full py-3 border-2 border-slate-100 text-slate-600 rounded-xl font-bold hover:bg-slate-50">Log Out</button>
                    </div>
                </main>
            `;
            refreshIcons();
        }

        function renderApp() {
            if (!currentUser) renderAuthScreen();
            else if (currentView === VIEW_DASHBOARD) renderDashboard();
            else if (currentView === VIEW_USERS) renderUserManagementScreen();
            
            refreshIcons();
        }

        // --- Init ---
        window.toggleAuthMode = toggleAuthMode;
        window.authHandler = authHandler;
        window.handleSwitchUser = handleSwitchUser;
        window.handleLogout = handleLogout;
        window.downloadReport = downloadReport;
        window.handleSubmit = handleSubmit;
        window.handleDeleteLast = handleDeleteLast;
        window.handleStartNewWeek = handleStartNewWeek;
        
        window.onload = function() {
            // Check session
            const sessionUser = localStorage.getItem(SESSION_KEY);
            if (sessionUser) {
                try {
                    handleLogin(JSON.parse(sessionUser));
                } catch(e) {
                    renderAuthScreen();
                }
            } else {
                renderAuthScreen();
            }
        };
    </script>
</body>
</html>
