<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinah Designs Admin (Cloud)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs (Compat for easier standalone usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.7); }
        /* Loaders */
        .spinner {
            width: 24px; height: 24px; border-radius: 50%;
            border: 3px solid #e2e8f0; border-top-color: #4f46e5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Mobile Menu */
        #mobile-menu { transition: transform 0.3s ease-in-out; }
        .translate-x-full { transform: translateX(100%); }
        .translate-x-0 { transform: translateX(0); }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen"></div>

    <!-- Global Notification -->
    <div id="notification-container" class="fixed top-0 left-1/2 -translate-x-1/2 z-[70] transition-all duration-300 transform opacity-0 -translate-y-full" style="display: none;"></div>

    <!-- Modals -->
    <div id="modal-container"></div>

    <script>
        // --- 1. CONFIGURATION & STATE ---

        // >>> FIREBASE SETUP <<<
        // We use the environment's config if available, otherwise fallback to placeholders
        // This fixes the "Script Error" caused by empty API keys
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "trinah-designs.firebaseapp.com",
            projectId: "trinah-designs",
            storageBucket: "trinah-designs.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // Initialize Primary App (for current user)
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Initialize Secondary App (for Admin to create Staff accounts without logging out)
        // We wrap this in a try-catch because initializing a second app with the same config can sometimes warn
        let secondaryApp;
        try {
            secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
        } catch (e) {
            // If it already exists, use it
            secondaryApp = firebase.app("Secondary");
        }

        // --- CONSTANTS ---
        // Use dynamic APP_ID from environment or fallback
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'trinah_designs_v2'; 
        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        
        // --- GLOBAL STATE ---
        let currentUserDoc = null; // Firestore data for logged in user
        let currentUserAuth = null; // Firebase Auth object
        let managedUser = null; // For Admin drilling down
        let currentView = 'loading'; // loading, auth, dashboard, users
        
        // Data Cache (Updated via onSnapshot)
        let cachedUsers = [];
        let cachedHistory = [];
        let cachedProcurement = {};
        
        let selectedDayIndex = 0;
        let selectedReport = "Daily";
        let selectedProcurementDate = new Date();
        let listeners = []; // Store unsubscribe functions

        const appElement = document.getElementById('app');
        const notifEl = document.getElementById('notification-container');
        const modalEl = document.getElementById('modal-container');

        // --- 2. AUTHENTICATION LOGIC ---

        function initApp() {
            // Main Auth Listener
            auth.onAuthStateChanged(async (user) => {
                currentUserAuth = user;
                if (user) {
                    // Fetch User Profile
                    const docRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(user.uid);
                    try {
                        const snap = await docRef.get();
                        if (snap.exists) {
                            currentUserDoc = snap.data();
                            currentUserDoc.uid = user.uid; // Ensure UID is attached
                            
                            // Initialize Realtime Listeners
                            setupListeners();
                            
                            // Route based on role
                            if (currentUserDoc.role === 'admin') {
                                managedUser = null;
                            } else {
                                managedUser = currentUserDoc;
                                loadDataForManagedUser();
                            }
                            setView('dashboard');
                        } else {
                            // Auth exists but no Firestore doc (Rare edge case)
                            console.error("User authenticated but no profile found.");
                            // If we are stuck here, we might need to force logout to reset
                            // auth.signOut(); 
                            // OR, if it's the very first admin creating their profile post-auth:
                            checkSystemInit();
                        }
                    } catch (e) {
                        console.error("Error fetching profile", e);
                        showNotification("Network Error: Could not fetch profile.");
                    }
                } else {
                    // No User -> Check if system is initialized (Admin exists)
                    checkSystemInit();
                }
            });
        }

        async function checkSystemInit() {
            setView('loading');
            try {
                // Check if ANY admin exists in the public collection
                const snap = await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users')
                    .where('role', '==', 'admin').limit(1).get();
                
                if (snap.empty) {
                    setView('setup'); // First run
                } else {
                    setView('auth'); // Normal Login
                }
            } catch (e) {
                console.error("Init check failed", e);
                // If offline or permission error, default to Auth screen usually
                setView('auth');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const input = document.getElementById('login-input').value.trim();
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('login-btn');
            const err = document.getElementById('login-error');

            if (!input || !pass) return;

            btn.innerHTML = `<div class="spinner border-white border-t-transparent mx-auto"></div>`;
            err.classList.add('hidden');

            try {
                // Determine if Email or Phone
                let email = input;
                if (!input.includes('@')) {
                    // Assume Staff Phone -> Map to system email
                    email = `${input}@trinah.app`;
                }

                await auth.signInWithEmailAndPassword(email, pass);
                // Listener handles redirection
            } catch (error) {
                console.error(error);
                btn.innerHTML = "Login";
                err.textContent = "Invalid credentials. Please try again.";
                err.classList.remove('hidden');
            }
        }

        async function handleSetup(e) {
            e.preventDefault();
            const name = document.getElementById('setup-name').value.trim();
            const email = document.getElementById('setup-email').value.trim();
            const pass = document.getElementById('setup-pass').value;

            if (pass.length < 6) {
                showNotification("Password must be at least 6 characters.");
                return;
            }

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                // Create Admin Profile
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(cred.user.uid).set({
                    name: name,
                    email: email,
                    role: 'admin',
                    createdAt: new Date().toISOString()
                });
                showNotification("System Initialized!");
                // Listener will auto-redirect
            } catch (e) {
                showNotification("Setup Failed: " + e.message);
            }
        }

        async function handleLogout() {
            listeners.forEach(unsub => unsub()); // Detach listeners
            listeners = [];
            await auth.signOut();
            window.location.reload();
        }

        async function handleRecovery(e) {
            e.preventDefault();
            const email = document.getElementById('rec-email').value.trim();
            if (!email) {
                showNotification("Please enter your email.");
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                document.getElementById('recovery-form').innerHTML = `
                    <div class="bg-emerald-50 text-emerald-800 p-6 rounded-xl text-center">
                        <div class="mx-auto w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-2">
                            ${renderIcon('check', {class:'w-6 h-6'})}
                        </div>
                        <p class="font-bold mb-2">Check your Email</p>
                        <p class="text-sm">A password reset link has been sent to <strong>${email}</strong>.</p>
                        <button onclick="setView('auth')" class="mt-4 text-emerald-700 font-bold underline">Back to Login</button>
                    </div>
                `;
            } catch (e) {
                showNotification("Error: " + e.message);
            }
        }

        // --- 3. FIRESTORE DATA LOGIC ---

        function setupListeners() {
            // Listen to Users Collection (For Admin Overview)
            const usersRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users');
            const unsubUsers = usersRef.onSnapshot(snap => {
                cachedUsers = snap.docs.map(d => ({...d.data(), uid: d.id}));
                if (currentView === 'dashboard' || currentView === 'users') {
                    renderApp(); // Re-render on update
                }
            });
            listeners.push(unsubUsers);

            // Listen to Procurement
            const procRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('procurement');
            const unsubProc = procRef.onSnapshot(snap => {
                cachedProcurement = {};
                snap.docs.forEach(d => {
                    cachedProcurement[d.id] = d.data().amount;
                });
                if (currentView === 'dashboard') renderApp();
            });
            listeners.push(unsubProc);
        }

        function loadDataForManagedUser() {
            if (!managedUser) return;
            // Listen to this user's specific history
            // We store history in a root 'history' collection for easier querying, or a subcollection.
            // Let's use a root collection 'history' with a 'userId' field for better query capability later.
            
            const histRef = db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('history')
                .where('userId', '==', managedUser.uid); // No orderBy here to avoid index requirements for now
                
            const unsubHist = histRef.onSnapshot(snap => {
                let raw = snap.docs.map(d => ({...d.data(), docId: d.id}));
                // Sort in memory to avoid index errors
                raw.sort((a, b) => a.id - b.id); 
                cachedHistory = raw;
                
                // Also update pressure if needed (stored in user doc, already in cachedUsers)
                if (currentView === 'dashboard' && managedUser) {
                    renderApp();
                }
            });
            listeners.push(unsubHist);
        }

        async function handleAddEntry() {
            if (!managedUser) return;
            
            const btn = document.getElementById('save-btn');
            btn.textContent = "Saving...";
            btn.disabled = true;

            const dispatchDress = Number(document.getElementById('dispatch-dress').value) || 0;
            const dispatch2pc = Number(document.getElementById('dispatch-2pc').value) || 0;
            const soldDress = Number(document.getElementById('sales-dress').value) || 0;
            const sold2pc = Number(document.getElementById('sales-2pc').value) || 0;

            if (dispatchDress === 0 && dispatch2pc === 0 && soldDress === 0 && sold2pc === 0) {
                showNotification("Please enter amounts.");
                btn.textContent = "Add Record";
                btn.disabled = false;
                return;
            }

            const prices = managedUser.prices || {};
            const profit = (soldDress * ((prices.dressSell||0) - (prices.dressBuy||0))) + 
                           (sold2pc * ((prices.twoPcSell||0) - (prices.twoPcBuy||0)));

            const now = new Date();
            const currentDayName = DAYS[selectedDayIndex];
            
            // Calculate Date
            const jsDay = now.getDay(); 
            const mappedDay = jsDay === 0 ? 6 : jsDay - 1; 
            const dayDiff = mappedDay - selectedDayIndex;
            const targetDate = new Date();
            targetDate.setDate(now.getDate() - dayDiff);
            const fullDateString = targetDate.toLocaleDateString();

            // Calculate Remaining
            // Logic: Get last entry from cache or use user 'startingPressure'
            let prevRemDress = 0, prevRem2pc = 0;
            
            if (cachedHistory.length > 0) {
                const last = cachedHistory[cachedHistory.length - 1];
                prevRemDress = last.remDresses || 0;
                prevRem2pc = last.remTwoPcs || 0;
            } else {
                // From user profile
                const p = managedUser.startingPressure || {};
                prevRemDress = p.dresses || 0;
                prevRem2pc = p.twoPcs || 0;
            }

            const newRemDress = prevRemDress + dispatchDress - soldDress;
            const newRem2pc = prevRem2pc + dispatch2pc - sold2pc;

            if (newRemDress < 0 || newRem2pc < 0) {
                showNotification("Error: Negative Stock.");
                btn.textContent = "Add Record";
                btn.disabled = false;
                return;
            }

            const record = {
                userId: managedUser.uid,
                id: Date.now(), // timestamp ID
                date: currentDayName,
                fullDate: fullDateString,
                dispatchedDresses: dispatchDress,
                dispatchedTwoPcs: dispatch2pc,
                soldDresses: soldDress,
                soldTwoPcs: sold2pc,
                remDresses: newRemDress,
                remTwoPcs: newRem2pc,
                profit: profit
            };

            try {
                // Add History
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('history').add(record);
                
                // Update User Current Stock (Pressure) in Profile for quick access
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(managedUser.uid).update({
                   currentStock: { dresses: newRemDress, twoPcs: newRem2pc } 
                });

                showNotification("Saved to Cloud!");
                
                // Clear inputs
                document.getElementById('dispatch-dress').value = "";
                document.getElementById('dispatch-2pc').value = "";
                document.getElementById('sales-dress').value = "";
                document.getElementById('sales-2pc').value = "";
            } catch (e) {
                showNotification("Save Failed: " + e.message);
            } finally {
                btn.textContent = "Add Record";
                btn.disabled = false;
            }
        }

        async function handleStartNewWeek() {
            if (!confirm("Start New Week? This archives current history.")) return;
            
            // In Firestore, we don't 'archive' by moving, we just rely on dates.
            // But to reset the 'Week' view, we might want to flag old entries or just rely on the 'Weekly' filter logic.
            // However, the 'pressure' needs to be reset/confirmed.
            
            const last = cachedHistory[cachedHistory.length-1];
            if (!last) return;

            const newPressure = { dresses: last.remDresses, twoPcs: last.remTwoPcs };
            
            try {
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(managedUser.uid).update({
                    startingPressure: newPressure,
                    // We might add a 'lastWeekReset' timestamp to filter history query if we truly want to hide old data
                    // For now, simpler: Just update starting pressure. The 'Current Week' UI needs to filter by date.
                });
                
                // Ideally, we'd batch delete or mark 'archived' on the old history docs if we want to clear the list.
                // Let's implement a 'soft' archive by updating the user's 'activeWeekStart' timestamp.
                // But for simplicity in this single file, let's just clear the UI state and let the filter logic handle 'Current Week'.
                
                showNotification("New Week Started. Carryover stock updated.");
                selectedDayIndex = 0;
                renderApp();
            } catch(e) { showNotification("Error: " + e.message); }
        }

        // --- 4. STAFF MANAGEMENT (ADMIN) ---

        async function handleSaveStaff(e, mode, uid) {
            e.preventDefault();
            const name = document.getElementById('staff-name').value.trim();
            const phone = document.getElementById('staff-phone').value.trim();
            const pass = document.getElementById('staff-pass').value.trim();
            
            // Prices
            const prices = {
                dressBuy: Number(document.getElementById('price-dress-buy').value),
                dressSell: Number(document.getElementById('price-dress-sell').value),
                twoPcBuy: Number(document.getElementById('price-2pc-buy').value),
                twoPcSell: Number(document.getElementById('price-2pc-sell').value)
            };

            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerHTML = `<div class="spinner border-white border-t-transparent mx-auto"></div>`;

            try {
                if (mode === 'add') {
                    // Create Auth User using Secondary App (so Admin stays logged in)
                    const email = `${phone}@trinah.app`; // Map phone to email
                    const userCred = await secondaryApp.auth().createUserWithEmailAndPassword(email, pass);
                    const newUid = userCred.user.uid;
                    secondaryApp.auth().signOut(); // Immediately sign out the secondary instance

                    // Create Profile in Main DB
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(newUid).set({
                        name, phone, role: 'staff', prices,
                        startingPressure: { dresses: 0, twoPcs: 0 },
                        currentStock: { dresses: 0, twoPcs: 0 },
                        createdAt: new Date().toISOString()
                    });
                    showNotification(`Staff ${name} Created!`);
                } else {
                    // Update Existing Profile
                    await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(uid).update({
                        name, prices
                    });
                    
                    // Note: Cannot update password easily without Admin SDK.
                    // If password field is filled, we warn user.
                    if (pass) {
                        alert("Note: Password was not updated. Staff password resets must be done by deleting and re-creating, or by the staff using email recovery if they had a real email. Since they use phone-IDs, please Delete and Re-Create if password is lost.");
                    }
                    showNotification("Details Updated");
                }
                document.getElementById('add-staff-modal').remove();
            } catch (err) {
                console.error(err);
                showNotification("Error: " + err.message);
                if (err.code === 'auth/email-already-in-use') {
                    showNotification("This phone number is already registered.");
                }
            } finally {
                btn.innerHTML = mode === 'add' ? 'Create Account' : 'Save Changes';
            }
        }

        async function handleDeleteStaff(uid) {
            if (!confirm("Delete this staff member? They will lose access immediately.")) return;
            // We cannot delete Auth user from client SDK easily. 
            // Workaround: Delete their profile. Without a profile, they can't access data (UI guards).
            try {
                await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('users').doc(uid).delete();
                showNotification("Staff profile removed. Access revoked.");
            } catch (e) {
                showNotification("Error: " + e.message);
            }
        }

        // --- 5. UI RENDERERS ---

        function renderIcon(name, attrs = {}) {
            if (typeof lucide !== 'undefined') {
                return `<i data-lucide="${name}" class="${attrs.class||''}"></i>`;
            }
            return '';
        }

        function refreshIcons() {
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function setView(view) {
            currentView = view;
            renderApp();
        }

        function renderApp() {
            appElement.innerHTML = '';
            
            if (currentView === 'loading') {
                appElement.innerHTML = `
                    <div class="h-screen flex items-center justify-center bg-slate-50">
                        <div class="flex flex-col items-center gap-4">
                            <div class="spinner w-12 h-12 border-4 border-indigo-600 border-t-transparent"></div>
                            <p class="text-indigo-900 font-bold animate-pulse">Connecting to Cloud...</p>
                        </div>
                    </div>`;
            } 
            else if (currentView === 'setup') {
                renderSetupScreen();
            }
            else if (currentView === 'auth') {
                renderAuthScreen();
            }
            else if (currentView === 'recovery') {
                renderRecoveryScreen();
            }
            else if (currentView === 'dashboard') {
                if (currentUserDoc && currentUserDoc.role === 'admin' && !managedUser) {
                    renderAdminDashboard();
                } else {
                    renderStaffDashboard();
                }
            }
            else if (currentView === 'users') {
                renderUserManagement();
            }

            refreshIcons();
        }

        function renderAuthScreen() {
            appElement.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-50 to-slate-100">
                    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 border border-white/50 backdrop-blur">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4 shadow-lg shadow-indigo-200">T</div>
                            <h1 class="text-2xl font-bold text-slate-800">Trinah Designs</h1>
                            <p class="text-sm text-slate-500">Cloud Manager</p>
                        </div>
                        <form onsubmit="handleLogin(event)" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Phone or Email</label>
                                <input id="login-input" type="text" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition" placeholder="e.g. 0712345678">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase ml-1">Password</label>
                                <input id="login-pass" type="password" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition" placeholder="••••••••">
                            </div>
                            <div class="flex justify-between items-center pt-2">
                                <p id="login-error" class="text-red-500 text-xs hidden font-bold"></p>
                                <button type="button" onclick="setView('recovery')" class="text-xs font-bold text-indigo-600 hover:underline ml-auto">Forgot Password?</button>
                            </div>
                            <button id="login-btn" type="submit" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-xl shadow-indigo-200">Login</button>
                        </form>
                    </div>
                </div>`;
        }

        function renderSetupScreen() {
            appElement.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-slate-800">
                    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-8">
                        <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                            <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600">${renderIcon('shield', {class:'w-6 h-6'})}</div>
                            <div>
                                <h1 class="text-xl font-bold text-slate-800">System Setup</h1>
                                <p class="text-xs text-slate-500">Create the Main Admin Account</p>
                            </div>
                        </div>
                        <form onsubmit="handleSetup(event)" class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-500">ADMIN NAME</label>
                                <input id="setup-name" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200" required>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500">EMAIL (For Recovery)</label>
                                <input id="setup-email" type="email" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200" required placeholder="you@example.com">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500">PASSWORD</label>
                                <input id="setup-pass" type="password" class="w-full p-3 bg-slate-50 rounded-lg border border-slate-200" required placeholder="Min 6 chars">
                            </div>
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 mt-4">Initialize System</button>
                        </form>
                    </div>
                </div>`;
        }

        function renderRecoveryScreen() {
             appElement.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                        <button onclick="setView('auth')" class="mb-4 text-slate-400 hover:text-slate-600 flex items-center gap-1 text-sm font-bold">
                            ${renderIcon('arrow-left', {class:'w-4 h-4'})} Back
                        </button>
                        <h1 class="text-2xl font-bold text-slate-800 mb-2">Reset Password</h1>
                        <p class="text-sm text-slate-500 mb-6">Enter your email to receive a secure reset link.</p>
                        <form id="recovery-form" onsubmit="handleRecovery(event)" class="space-y-4">
                            <input id="rec-email" type="email" class="w-full p-4 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500" placeholder="admin@example.com">
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Send Reset Link</button>
                        </form>
                    </div>
                </div>`;
        }

        function renderHeader() {
            const isAdmin = currentUserDoc?.role === 'admin';
            return `
                <header class="bg-white border-b border-slate-200 sticky top-0 z-40">
                    <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 bg-indigo-600 rounded text-white flex items-center justify-center font-bold">T</div>
                            <span class="font-bold text-slate-800">Trinah<span class="text-indigo-600">Cloud</span></span>
                        </div>
                        <div class="flex items-center gap-4">
                            ${isAdmin && !managedUser ? `
                                <button onclick="setView('users')" class="text-sm font-bold text-slate-500 hover:text-indigo-600 flex items-center gap-1">
                                    ${renderIcon('users', {class:'w-4 h-4'})} Staff
                                </button>
                            ` : ''}
                            ${managedUser ? `
                                <button onclick="managedUser=null; setView('dashboard')" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded flex items-center gap-1">
                                    ${renderIcon('arrow-left', {class:'w-4 h-4'})} Admin View
                                </button>
                            ` : ''}
                            <button onclick="handleLogout()" class="text-sm font-bold text-red-500 hover:bg-red-50 px-3 py-1.5 rounded">Logout</button>
                        </div>
                    </div>
                </header>`;
        }

        function renderAdminDashboard() {
            // Aggregate Data from cachedUsers and cachedProcurement
            let totalStock = 0;
            let totalSales = 0;
            let totalProfit = 0;
            
            // Note: In a real large app, we'd use aggregation queries. 
            // For small business size, client-side calc of cachedUsers is fine and fast.
            cachedUsers.filter(u => u.role !== 'admin').forEach(u => {
                totalStock += (u.currentStock?.dresses || 0) + (u.currentStock?.twoPcs || 0);
                // Sales would need history aggregation which we don't load all at once for Admin yet to save bandwidth
                // We'll just show Stock for now.
            });
            
            const dateKey = selectedProcurementDate.toLocaleDateString();
            const procurementToday = cachedProcurement[dateKey] || 0;

            appElement.innerHTML = `
                ${renderHeader()}
                <main class="max-w-5xl mx-auto p-4 space-y-6">
                    <h1 class="text-2xl font-bold text-slate-800">Overview</h1>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <p class="text-xs font-bold text-slate-400 uppercase">Total Stock (All Staff)</p>
                            <p class="text-2xl font-bold text-indigo-600">${totalStock}</p>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                            <p class="text-xs font-bold text-slate-400 uppercase">Procurement (${dateKey})</p>
                            <p class="text-2xl font-bold text-emerald-600">${procurementToday}</p>
                        </div>
                    </div>

                    <!-- Procurement Input -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                        <input type="date" value="${selectedProcurementDate.toISOString().split('T')[0]}" 
                            onchange="selectedProcurementDate=new Date(this.value); renderApp()"
                            class="p-2 border rounded-lg bg-slate-50">
                        <input type="number" id="proc-in" placeholder="Qty" class="p-2 border rounded-lg w-24">
                        <button onclick="saveProcurement()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold">Save</button>
                    </div>

                    <h2 class="text-lg font-bold text-slate-800 mt-8">Staff Activity</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${cachedUsers.filter(u => u.role !== 'admin').map(user => `
                            <div onclick="managedUser=cachedUsers.find(u=>u.uid=='${user.uid}'); loadDataForManagedUser(); setView('dashboard')" 
                                class="bg-white p-5 rounded-2xl border border-slate-200 hover:border-indigo-400 cursor-pointer transition group">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold">
                                            ${renderIcon('user', {class:'w-5 h-5'})}
                                        </div>
                                        <div>
                                            <p class="font-bold text-slate-800 group-hover:text-indigo-600">${user.name}</p>
                                            <p class="text-xs text-slate-400">${user.phone}</p>
                                        </div>
                                    </div>
                                    ${renderIcon('chevron-right', {class:'w-4 h-4 text-slate-300'})}
                                </div>
                                <div class="bg-orange-50 p-2 rounded-lg text-center">
                                    <p class="text-xs font-bold text-orange-400 uppercase">Current Stock</p>
                                    <p class="font-bold text-orange-700">${(user.currentStock?.dresses||0)} / ${(user.currentStock?.twoPcs||0)}</p>
                                    <p class="text-[9px] text-orange-300">DRESS / 2PC</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </main>`;
        }

        async function saveProcurement() {
            const val = document.getElementById('proc-in').value;
            if (!val) return;
            const key = selectedProcurementDate.toLocaleDateString();
            await db.collection('artifacts').doc(APP_ID).collection('public').doc('data').collection('procurement').doc(key).set({ amount: Number(val) });
            showNotification("Procurement Saved");
        }

        function renderStaffDashboard() {
            if (!managedUser) return;
            
            // Filter history for "Current View" (e.g., Weekly)
            // For simplicity in this version, we just show latest 20 entries
            const recent = [...cachedHistory].reverse().slice(0, 50);

            appElement.innerHTML = `
                ${renderHeader()}
                <main class="max-w-4xl mx-auto p-4 space-y-4">
                    <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl flex justify-between items-center">
                        <div>
                            <p class="text-xs font-bold text-indigo-400 uppercase">Dashboard</p>
                            <h1 class="text-xl font-bold text-indigo-900">${managedUser.name}</h1>
                        </div>
                        <div class="text-right">
                             <p class="text-xs font-bold text-indigo-400 uppercase">Live Stock</p>
                             <p class="text-lg font-bold text-indigo-700">
                                ${(managedUser.currentStock?.dresses||0)} / ${(managedUser.currentStock?.twoPcs||0)}
                             </p>
                        </div>
                    </div>

                    <!-- Input Card -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-100">
                        <div class="flex justify-between items-center mb-4">
                             <h2 class="font-bold text-slate-700">New Entry (${DAYS[selectedDayIndex]})</h2>
                             <!-- Day Picker Small -->
                             <div class="flex gap-1">
                                ${DAYS.map((d,i) => {
                                    const active = selectedDayIndex === i;
                                    const locked = i > (new Date().getDay() === 0 ? 6 : new Date().getDay() - 1);
                                    return `<div onclick="if(!${locked}) {selectedDayIndex=${i}; renderApp()}" 
                                        class="w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold cursor-pointer
                                        ${active ? 'bg-indigo-600 text-white' : (locked ? 'bg-slate-100 text-slate-300' : 'bg-slate-200 text-slate-600')}">
                                        ${d[0]}
                                    </div>`;
                                }).join('')}
                             </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                             <div class="bg-slate-50 p-3 rounded-xl">
                                <p class="text-xs font-bold text-slate-400 mb-2">DRESSES</p>
                                <input id="dispatch-dress" type="number" placeholder="Dispatch" class="w-full mb-2 p-2 border rounded text-sm">
                                <input id="sales-dress" type="number" placeholder="Sold" class="w-full p-2 border rounded text-sm">
                             </div>
                             <div class="bg-slate-50 p-3 rounded-xl">
                                <p class="text-xs font-bold text-slate-400 mb-2">2 PIECES</p>
                                <input id="dispatch-2pc" type="number" placeholder="Dispatch" class="w-full mb-2 p-2 border rounded text-sm">
                                <input id="sales-2pc" type="number" placeholder="Sold" class="w-full p-2 border rounded text-sm">
                             </div>
                        </div>
                        <button id="save-btn" onclick="handleAddEntry()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">Add Record</button>
                    </div>

                    <!-- History Table -->
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">Recent History</h3>
                            <button onclick="handleStartNewWeek()" class="text-xs font-bold text-indigo-600 hover:underline">Start New Week</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-3">Date</th>
                                        <th class="px-4 py-3">Sold (D/2)</th>
                                        <th class="px-4 py-3">Rem (D/2)</th>
                                        <th class="px-4 py-3 text-right">Profit</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${recent.map(r => `
                                        <tr class="hover:bg-slate-50 transition">
                                            <td class="px-4 py-3">
                                                <span class="font-bold text-slate-700">${r.date.substr(0,3)}</span>
                                                <span class="text-xs text-slate-400 block">${r.fullDate}</span>
                                            </td>
                                            <td class="px-4 py-3 font-bold text-emerald-600">${r.soldDresses}/${r.soldTwoPcs}</td>
                                            <td class="px-4 py-3 font-bold text-orange-600">${r.remDresses}/${r.remTwoPcs}</td>
                                            <td class="px-4 py-3 text-right text-slate-600">${r.profit?.toLocaleString()}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </main>`;
        }

        function renderUserManagement() {
            appElement.innerHTML = `
                ${renderHeader()}
                <main class="max-w-2xl mx-auto p-4 space-y-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-xl font-bold text-slate-800">Manage Staff</h1>
                        <button onclick="showAddStaffModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-indigo-700 flex items-center gap-2">
                            ${renderIcon('plus', {class:'w-4 h-4'})} Add New
                        </button>
                    </div>

                    <div class="space-y-3">
                        ${cachedUsers.filter(u => u.role !== 'admin').map(user => `
                            <div class="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center shadow-sm">
                                <div class="flex items-center gap-3">
                                    <div class="bg-slate-100 p-2 rounded-lg text-slate-600">
                                        ${renderIcon('user', {class:'w-5 h-5'})}
                                    </div>
                                    <div>
                                        <p class="font-bold text-slate-800">${user.name}</p>
                                        <p class="text-xs text-slate-500">${user.phone}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="showAddStaffModal(true, '${user.uid}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg">
                                        ${renderIcon('pencil', {class:'w-4 h-4'})}
                                    </button>
                                    <button onclick="handleDeleteStaff('${user.uid}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg">
                                        ${renderIcon('trash-2', {class:'w-4 h-4'})}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </main>`;
        }

        function showAddStaffModal(isEdit = false, uid = null) {
            let u = null;
            if (isEdit) u = cachedUsers.find(x => x.uid === uid);
            
            modalEl.innerHTML = `
                <div id="add-staff-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0" onclick="document.getElementById('add-staff-modal').remove()"></div>
                    <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg relative z-10">
                        <h2 class="text-lg font-bold mb-4">${isEdit ? 'Edit Staff' : 'Add New Staff'}</h2>
                        <form onsubmit="handleSaveStaff(event, '${isEdit?'edit':'add'}', '${uid}')" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <input id="staff-name" value="${u?.name||''}" placeholder="Name" class="p-3 border rounded-lg" required>
                                <input id="staff-phone" value="${u?.phone||''}" placeholder="Phone (Login ID)" class="p-3 border rounded-lg" ${isEdit?'disabled':''} required>
                            </div>
                            <input id="staff-pass" type="text" placeholder="${isEdit ? 'New Password (Leave empty to keep)' : 'Password'}" class="w-full p-3 border rounded-lg" ${!isEdit?'required':''}>
                            
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <p class="text-xs font-bold text-slate-400 mb-2">PRICING CONFIG</p>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-bold text-indigo-600">DRESSES</p>
                                        <input id="price-dress-buy" type="number" value="${u?.prices?.dressBuy||120}" class="w-full p-2 text-sm border rounded">
                                        <input id="price-dress-sell" type="number" value="${u?.prices?.dressSell||200}" class="w-full p-2 text-sm border rounded">
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-bold text-purple-600">2 PIECES</p>
                                        <input id="price-2pc-buy" type="number" value="${u?.prices?.twoPcBuy||120}" class="w-full p-2 text-sm border rounded">
                                        <input id="price-2pc-sell" type="number" value="${u?.prices?.twoPcSell||200}" class="w-full p-2 text-sm border rounded">
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700">
                                ${isEdit ? 'Save Changes' : 'Create Account'}
                            </button>
                        </form>
                    </div>
                </div>`;
            refreshIcons();
        }

        function showNotification(msg) {
            notifEl.innerHTML = `<div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold">${msg}</div>`;
            notifEl.style.display = 'block';
            requestAnimationFrame(() => {
                notifEl.classList.remove('opacity-0', '-translate-y-full');
                notifEl.classList.add('opacity-100', 'translate-y-5');
            });
            setTimeout(() => {
                notifEl.classList.remove('opacity-100', 'translate-y-5');
                notifEl.classList.add('opacity-0', '-translate-y-full');
                setTimeout(() => notifEl.style.display = 'none', 300);
            }, 3000);
        }

        // --- INIT ---
        window.onload = initApp;

    </script>
</body>
</html>
