<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinah Designs Admin Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load jsPDF for Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load jsPDF AutoTable for easier tables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.7);
        }
        /* PDF loader styles */
        #pdf-loader { position: fixed; inset: 0; z-index: 60; background-color: rgba(255, 255, 255, 0.9); display: none; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom scrollbar for better look */
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Notification/Toast Message Area -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Modals -->
    <div id="add-staff-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center"></div>
    <div id="reports-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center"></div>
    <div id="reset-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center"></div>
    <div id="login-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center"></div>
    <div id="message-box" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center"></div>
    <div id="balance-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center"></div>

    <!-- PDF Loader -->
    <div id="pdf-loader">
        <div class="spinner"></div>
        <p class="mt-4 text-gray-700">Generating PDF Report...</p>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i data-lucide="scissors" class="w-6 h-6 mr-2 text-indigo-600"></i>
                    Trinah Designs Manager
                </h1>
                <div class="flex items-center space-x-4">
                    <button onclick="showBalanceModal()" class="flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out">
                        <i data-lucide="wallet" class="w-5 h-5 mr-1"></i>
                        View Balance
                    </button>
                    <button onclick="showReportsModal()" class="flex items-center text-sm font-medium text-indigo-600 hover:text-indigo-800 transition duration-150 ease-in-out">
                        <i data-lucide="printer" class="w-5 h-5 mr-1"></i>
                        Reports
                    </button>
                    <button onclick="showResetModal()" class="flex items-center text-sm font-medium text-red-600 hover:text-red-800 transition duration-150 ease-in-out">
                        <i data-lucide="settings-2" class="w-5 h-5 mr-1"></i>
                        Admin
                    </button>
                    <button onclick="logoutUser()" class="flex items-center text-sm font-medium text-gray-600 hover:text-gray-800 transition duration-150 ease-in-out">
                        <i data-lucide="log-out" class="w-5 h-5 mr-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="view-container">
                <!-- Content will be rendered here (e.g., Dashboard, Staff List, Procurement) -->
            </div>
        </main>
    </div>

    <!-- Recovery Screen Container -->
    <div id="recovery-container" class="hidden min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <!-- Recovery content will be rendered here -->
    </div>

    <!-- Authentication Screen Container -->
    <div id="auth-container" class="hidden min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <!-- Login/Signup content will be rendered here -->
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        // ============================================================
        // ======================== GLOBAL STATE ======================
        // ============================================================
        window.localDb = [];
        window.currentView = 'dashboard';
        window.currentUser = null;
        window.LAST_WEEK_BALANCE = 0;

        // Constants
        const SESSION_KEY = "TRINAH_SESSION_USER";
        const LOCAL_DB_KEY = "TRINAH_DESIGNS_DB";
        const SYSTEM_PIN = "1234"; // Default system pin

        // Initialize localDb from localStorage if it exists (for initial setup/migration)
        window.localDb = JSON.parse(localStorage.getItem(LOCAL_DB_KEY) || "[]");

        // Helper to safely parse JSON
        function jparse(s, defaultValue = null) {
            try {
                return JSON.parse(s);
            } catch {
                return defaultValue;
            }
        }

        // ============================================================
        // ================== UTILITY FUNCTIONS =======================
        // ============================================================
        
        // Notification/Toast Utility
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const color = {
                'info': 'bg-blue-500',
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500'
            }[type];

            const icon = {
                'info': 'info',
                'success': 'check-circle',
                'error': 'x-circle',
                'warning': 'alert-triangle'
            }[type];

            const notification = document.createElement('div');
            notification.className = `p-4 rounded-lg shadow-xl text-white ${color} flex items-center transition-opacity duration-300 opacity-0 transform translate-x-full`;
            notification.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-2"></i> ${message}`;
            
            container.appendChild(notification);
            lucide.createIcons(); // Render the icon

            // Animate in
            setTimeout(() => {
                notification.classList.remove('opacity-0', 'translate-x-full');
                notification.classList.add('opacity-100', 'translate-x-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                notification.classList.remove('opacity-100', 'translate-x-0');
                notification.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
        window.showNotification = showNotification; // Make available globally

        // Custom Message Box (Replaces alert/confirm)
        function showMessageBox(title, message, type = 'info', onConfirm = null) {
            const modal = document.getElementById('message-box');
            const isConfirm = typeof onConfirm === 'function';
            
            const color = {
                'info': 'text-blue-600',
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600'
            }[type];

            const icon = {
                'info': 'info',
                'success': 'check-circle',
                'error': 'x-circle',
                'warning': 'alert-triangle'
            }[type];

            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4 transform transition-all duration-300 scale-95">
                    <div class="flex items-start">
                        <i data-lucide="${icon}" class="w-8 h-8 mr-3 ${color}"></i>
                        <div>
                            <h3 class="text-lg leading-6 font-bold text-gray-900">${title}</h3>
                            <div class="mt-2 text-sm text-gray-500">
                                <p>${message}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse sm:space-x-2 sm:space-x-reverse">
                        <button type="button" id="confirm-btn" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition duration-150">
                            ${isConfirm ? 'Confirm' : 'Close'}
                        </button>
                        ${isConfirm ? `
                        <button type="button" id="cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm transition duration-150">
                            Cancel
                        </button>` : ''}
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();

            const close = () => {
                modal.classList.add('hidden');
                document.getElementById('confirm-btn').removeEventListener('click', confirmHandler);
                if (isConfirm) document.getElementById('cancel-btn').removeEventListener('click', cancelHandler);
            };

            const confirmHandler = () => {
                if (isConfirm) onConfirm();
                close();
            };

            const cancelHandler = () => {
                close();
            };

            document.getElementById('confirm-btn').addEventListener('click', confirmHandler);
            if (isConfirm) document.getElementById('cancel-btn').addEventListener('click', cancelHandler);
        }
        window.showMessageBox = showMessageBox;


        // Date Helpers
        function formatDate(dateString) {
            const date = dateString ? new Date(dateString) : new Date();
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }
        
        // ============================================================
        // ===================== DATA MANAGEMENT ======================
        // ============================================================

        function getLastDataEntry() {
            if (window.localDb.length === 0) return null;
            return window.localDb[window.localDb.length - 1];
        }

        function calculateBalance() {
            const lastEntry = getLastDataEntry();
            if (!lastEntry) return 0;
            
            const totalRevenue = lastEntry.entries.reduce((sum, entry) => sum + entry.revenue, 0);
            const totalWage = lastEntry.entries.reduce((sum, entry) => sum + entry.wage, 0);
            const totalProcurement = lastEntry.procurement.reduce((sum, item) => sum + item.cost, 0);

            const previousBalance = window.LAST_WEEK_BALANCE;
            const currentBalance = previousBalance + totalRevenue - totalWage - totalProcurement;
            return currentBalance;
        }

        // The saveData function will be overridden by the Firebase script to push to cloud.
        function saveData() {
            // Default local storage save (used until Firebase is ready)
            localStorage.setItem(LOCAL_DB_KEY, JSON.stringify(window.localDb));
            window.updateUI();
            console.warn("Using local storage save. Cloud save not initialized yet.");
        }
        window.saveData = saveData; // Make available globally


        // ============================================================
        // ======================= UI RENDERING =======================
        // ============================================================

        function updateUI() {
            // Re-render the current view
            switch (window.currentView) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'staff-list':
                    renderStaffList();
                    break;
                case 'procurement':
                    renderProcurement();
                    break;
                case 'manage-user':
                    renderManageUser();
                    break;
            }
            // Re-create icons for any new content
            lucide.createIcons();
        }
        window.updateUI = updateUI; // Make available globally

        // Main View Renderer
        function setView(viewName) {
            window.currentView = viewName;
            updateUI();
        }
        window.setView = setView;


        // ============================================================
        // ========================= DASHBOARD ========================
        // ============================================================

        function renderDashboard() {
            const container = document.getElementById('view-container');
            const lastEntry = getLastDataEntry();
            const currentBalance = calculateBalance();
            
            let dashboardContent = `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Weekly Dashboard</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Card 1: Current Balance -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100">
                        <div class="flex items-center">
                            <i data-lucide="wallet" class="w-8 h-8 text-indigo-500 mr-4"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Current Balance</p>
                                <p class="text-2xl font-bold text-gray-900">${formatCurrency(currentBalance)}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-xs text-gray-400">Calculated from the last completed week.</p>
                    </div>

                    <!-- Card 2: Last Week Revenue -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-green-100">
                        <div class="flex items-center">
                            <i data-lucide="trending-up" class="w-8 h-8 text-green-500 mr-4"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Last Week Revenue</p>
                                <p class="text-2xl font-bold text-gray-900">${formatCurrency(lastEntry ? lastEntry.entries.reduce((sum, entry) => sum + entry.revenue, 0) : 0)}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-xs text-gray-400">From ${lastEntry ? formatDate(lastEntry.startDate) : 'N/A'} to ${lastEntry ? formatDate(lastEntry.endDate) : 'N/A'}</p>
                    </div>

                    <!-- Card 3: Last Week Wages -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-red-100">
                        <div class="flex items-center">
                            <i data-lucide="users" class="w-8 h-8 text-red-500 mr-4"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-500">Last Week Wages</p>
                                <p class="text-2xl font-bold text-gray-900">${formatCurrency(lastEntry ? lastEntry.entries.reduce((sum, entry) => sum + entry.wage, 0) : 0)}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-xs text-gray-400">Total payments made to staff.</p>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Current Week's Entries</h3>
                    <button onclick="handleStartNewWeek()" class="flex items-center bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                        <i data-lucide="calendar-plus" class="w-5 h-5 mr-2"></i>
                        Start New Week
                    </button>
                </div>
            `;

            if (!lastEntry) {
                dashboardContent += `
                    <div class="text-center p-12 bg-gray-50 rounded-xl border border-dashed border-gray-300">
                        <i data-lucide="inbox" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <h4 class="text-lg font-medium text-gray-700">No Weekly Data Yet</h4>
                        <p class="text-sm text-gray-500 mt-1">Please start a new week to begin logging transactions.</p>
                        <button onclick="handleStartNewWeek()" class="mt-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition duration-150 ease-in-out">
                            Start First Week
                        </button>
                    </div>
                `;
            } else {
                dashboardContent += renderDashboardTable(lastEntry);
                dashboardContent += `
                    <div class="mt-8 flex justify-end space-x-4">
                        <button onclick="handleDeleteLast()" class="flex items-center text-sm font-medium text-red-600 hover:text-red-800 transition duration-150 ease-in-out">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i>
                            Delete Last Entry
                        </button>
                    </div>
                `;
            }

            container.innerHTML = dashboardContent;
            lucide.createIcons(); // Ensure icons are created for the new content
        }

        function renderDashboardTable(entry) {
            const allStaff = window.localDb.find(d => d.key === 'staffList')?.data || [];

            let tableRows = entry.entries.map((item, index) => {
                const staffName = allStaff.find(s => s.id === item.staffId)?.name || `ID: ${item.staffId}`;
                return `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-6 py-4 text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${staffName}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${item.item}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${formatCurrency(item.revenue)}</td>
                        <td class="px-6 py-4 text-sm text-gray-700">${formatCurrency(item.wage)}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                    <div class="p-4 bg-indigo-50 flex justify-between items-center">
                        <p class="text-sm font-semibold text-indigo-700">Week: ${formatDate(entry.startDate)} - ${formatDate(entry.endDate)}</p>
                        <button onclick="renderNewEntryForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-1.5 px-3 rounded-lg shadow transition duration-150 ease-in-out">
                            <i data-lucide="plus" class="w-4 h-4 inline-block mr-1"></i>
                            Add Entry
                        </button>
                    </div>
                    <div class="overflow-x-auto custom-scroll max-h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wage</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderNewEntryForm() {
            const container = document.getElementById('view-container');
            const lastEntry = getLastDataEntry();
            const staffList = window.localDb.find(d => d.key === 'staffList')?.data || [];

            if (!lastEntry) {
                return showMessageBox("Error", "Please start a new week before adding entries.", 'error');
            }
            if (staffList.length === 0) {
                return showMessageBox("No Staff", "Please add staff members in the Admin section before adding entries.", 'warning');
            }

            const staffOptions = staffList.map(staff => 
                `<option value="${staff.id}">${staff.name}</option>`
            ).join('');

            const formContent = `
                <div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-3">Add New Weekly Entry</h3>
                    <form onsubmit="handleSubmit(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="staffId" class="block text-sm font-medium text-gray-700">Staff Member</label>
                                <select id="staffId" name="staffId" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg shadow-sm">
                                    <option value="" disabled selected>Select staff member</option>
                                    ${staffOptions}
                                </select>
                            </div>
                            <div>
                                <label for="item" class="block text-sm font-medium text-gray-700">Item Description</label>
                                <input type="text" id="item" name="item" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="revenue" class="block text-sm font-medium text-gray-700">Revenue ($)</label>
                                    <input type="number" id="revenue" name="revenue" required min="0" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div>
                                    <label for="wage" class="block text-sm font-medium text-gray-700">Wage ($)</label>
                                    <input type="number" id="wage" name="wage" required min="0" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="setView('dashboard')" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                                Cancel
                            </button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                                Add Entry
                            </button>
                        </div>
                    </form>
                </div>
            `;
            container.innerHTML = formContent;
        }

        // ============================================================
        // ====================== HANDLERS ============================
        // ============================================================

        function handleSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const staffId = form.staffId.value;
            const item = form.item.value;
            const revenue = parseFloat(form.revenue.value);
            const wage = parseFloat(form.wage.value);

            const newEntry = {
                id: crypto.randomUUID(),
                staffId,
                item,
                revenue,
                wage,
                timestamp: new Date().toISOString()
            };

            const lastEntry = getLastDataEntry();
            if (lastEntry) {
                lastEntry.entries.push(newEntry);
                window.saveData();
                setView('dashboard');
                showNotification(`Entry for ${item} added successfully!`, 'success');
            } else {
                showMessageBox("Error", "Cannot add entry. Please start a new week first.", 'error');
            }
        }
        window.handleSubmit = handleSubmit;

        function handleDeleteLast() {
            showMessageBox(
                "Confirm Deletion", 
                "Are you sure you want to delete the last transaction entry? This action cannot be undone.", 
                'warning', 
                () => {
                    const lastEntry = getLastDataEntry();
                    if (lastEntry && lastEntry.entries.length > 0) {
                        const deleted = lastEntry.entries.pop();
                        window.saveData();
                        setView('dashboard');
                        showNotification(`Last entry (${deleted.item}) deleted.`, 'info');
                    } else {
                        showMessageBox("Error", "No entries to delete in the current week.", 'error');
                    }
                }
            );
        }
        window.handleDeleteLast = handleDeleteLast;

        function handleStartNewWeek() {
            showMessageBox(
                "Start New Week", 
                "Starting a new week will lock the current week's data and reset entries. Do you want to proceed?", 
                'info', 
                () => {
                    const now = new Date();
                    const nextWeek = new Date(now);
                    nextWeek.setDate(now.getDate() + 7);

                    const newWeekData = {
                        id: crypto.randomUUID(),
                        startDate: now.toISOString(),
                        endDate: nextWeek.toISOString(),
                        entries: [],
                        procurement: []
                    };
                    window.LAST_WEEK_BALANCE = calculateBalance(); // Update balance before starting new week

                    // Find or initialize weeklyData object
                    let weeklyData = window.localDb.find(d => d.key === 'weeklyData');
                    if (!weeklyData) {
                        weeklyData = { key: 'weeklyData', data: [] };
                        window.localDb.push(weeklyData);
                    }
                    weeklyData.data.push(newWeekData);

                    window.saveData();
                    setView('dashboard');
                    showNotification("New week successfully started!", 'success');
                }
            );
        }
        window.handleStartNewWeek = handleStartNewWeek;


        // ============================================================
        // ======================== STAFF LIST ========================
        // ============================================================

        function renderStaffList() {
            const container = document.getElementById('view-container');
            const staffList = window.localDb.find(d => d.key === 'staffList')?.data || [];

            let staffRows = staffList.map(staff => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${staff.name}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${staff.phone}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${staff.role}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        <button onclick="handleDeleteStaff('${staff.id}', '${staff.name}')" class="text-red-600 hover:text-red-900 transition duration-150">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-3xl font-extrabold text-gray-900">Staff List</h2>
                    <button onclick="showAddStaffModal()" class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                        <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                        Add Staff
                    </button>
                </div>

                <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                    <div class="overflow-x-auto custom-scroll">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${staffRows.length > 0 ? staffRows : `<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No staff added yet.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-8">
                    <button onclick="setView('dashboard')" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                        Back to Dashboard
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function showAddStaffModal() {
            const modal = document.getElementById('add-staff-modal');
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Add New Staff Member</h3>
                    <form onsubmit="handleSaveStaff(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="staffName" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="staffName" name="staffName" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="staffPhone" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                <input type="tel" id="staffPhone" name="staffPhone" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="staffRole" class="block text-sm font-medium text-gray-700">Role</label>
                                <select id="staffRole" name="staffRole" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg shadow-sm">
                                    <option value="Seamstress">Seamstress</option>
                                    <option value="Apprentice">Apprentice</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="document.getElementById('add-staff-modal').classList.add('hidden')" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                                Cancel
                            </button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                                Save Staff
                            </button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        window.showAddStaffModal = showAddStaffModal;
        
        function handleSaveStaff(event) {
            event.preventDefault();
            const form = event.target;
            const staff = {
                id: crypto.randomUUID(),
                name: form.staffName.value,
                phone: form.staffPhone.value,
                role: form.staffRole.value,
            };

            let staffData = window.localDb.find(d => d.key === 'staffList');
            if (!staffData) {
                staffData = { key: 'staffList', data: [] };
                window.localDb.push(staffData);
            }
            staffData.data.push(staff);

            window.saveData();
            document.getElementById('add-staff-modal').classList.add('hidden');
            setView('staff-list');
            showNotification(`${staff.name} added to staff list.`, 'success');
        }
        window.handleSaveStaff = handleSaveStaff;

        function handleDeleteStaff(staffId, staffName) {
            showMessageBox(
                "Confirm Deletion", 
                `Are you sure you want to remove ${staffName} from the staff list?`, 
                'warning', 
                () => {
                    let staffData = window.localDb.find(d => d.key === 'staffList');
                    if (staffData) {
                        staffData.data = staffData.data.filter(s => s.id !== staffId);
                        window.saveData();
                        setView('staff-list');
                        showNotification(`${staffName} removed.`, 'info');
                    }
                }
            );
        }
        window.handleDeleteStaff = handleDeleteStaff;


        // ============================================================
        // ======================== PROCUREMENT =======================
        // ============================================================

        function renderProcurement() {
            const container = document.getElementById('view-container');
            const lastEntry = getLastDataEntry();
            const procurementList = lastEntry ? lastEntry.procurement : [];

            let procurementRows = procurementList.map(item => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${formatDate(item.date)}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item.item}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item.supplier}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${formatCurrency(item.cost)}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">
                        <button onclick="handleDeleteProcurement('${item.id}')" class="text-red-600 hover:text-red-900 transition duration-150">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            const totalProcurementCost = procurementList.reduce((sum, item) => sum + item.cost, 0);

            container.innerHTML = `
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-3xl font-extrabold text-gray-900">Procurement & Inventory</h2>
                    <button onclick="renderProcurementForm()" class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                        <i data-lucide="package-plus" class="w-5 h-5 mr-2"></i>
                        Add Purchase
                    </button>
                </div>
                
                <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 rounded-lg">
                    <p class="font-bold">Total Procurement Cost (Current Week): ${formatCurrency(totalProcurementCost)}</p>
                    <p class="text-sm">Week: ${lastEntry ? formatDate(lastEntry.startDate) : 'N/A'} - ${lastEntry ? formatDate(lastEntry.endDate) : 'N/A'}</p>
                </div>

                <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                    <div class="overflow-x-auto custom-scroll max-h-96">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Purchased</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cost</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${procurementRows.length > 0 ? procurementRows : `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No procurement records for this week.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-8">
                    <button onclick="setView('dashboard')" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                        Back to Dashboard
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderProcurementForm() {
            const container = document.getElementById('view-container');
            const lastEntry = getLastDataEntry();

            if (!lastEntry) {
                return showMessageBox("Error", "Please start a new week before adding procurement entries.", 'error');
            }

            const formContent = `
                <div class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-2xl">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-3">Add New Purchase</h3>
                    <form onsubmit="handleProcurementSave(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="purchaseDate" class="block text-sm font-medium text-gray-700">Date of Purchase</label>
                                <input type="date" id="purchaseDate" name="purchaseDate" required onchange="handleProcurementDateChange(this.value)" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="purchaseItem" class="block text-sm font-medium text-gray-700">Item Description</label>
                                <input type="text" id="purchaseItem" name="purchaseItem" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="supplier" class="block text-sm font-medium text-gray-700">Supplier Name</label>
                                <input type="text" id="supplier" name="supplier" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="cost" class="block text-sm font-medium text-gray-700">Cost ($)</label>
                                <input type="number" id="cost" name="cost" required min="0" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="setView('procurement')" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                                Cancel
                            </button>
                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                                Record Purchase
                            </button>
                        </div>
                    </form>
                </div>
            `;
            container.innerHTML = formContent;
            
            // Set default date to today
            document.getElementById('purchaseDate').valueAsDate = new Date();
        }

        function handleProcurementDateChange(dateString) {
            const lastEntry = getLastDataEntry();
            if (lastEntry) {
                const purchaseDate = new Date(dateString);
                const startDate = new Date(lastEntry.startDate);
                const endDate = new Date(lastEntry.endDate);
                
                // Set time to start/end of day for accurate comparison
                startDate.setHours(0, 0, 0, 0);
                endDate.setHours(23, 59, 59, 999);

                if (purchaseDate < startDate || purchaseDate > endDate) {
                    showMessageBox("Date Warning", "The selected date is outside the current tracking week. This entry will still be recorded but verify the date.", 'warning');
                }
            }
        }
        window.handleProcurementDateChange = handleProcurementDateChange;

        function handleProcurementSave(event) {
            event.preventDefault();
            const form = event.target;
            const purchase = {
                id: crypto.randomUUID(),
                date: form.purchaseDate.value,
                item: form.purchaseItem.value,
                supplier: form.supplier.value,
                cost: parseFloat(form.cost.value),
                timestamp: new Date().toISOString()
            };

            const lastEntry = getLastDataEntry();
            if (lastEntry) {
                lastEntry.procurement.push(purchase);
                window.saveData();
                setView('procurement');
                showNotification(`Purchase of ${purchase.item} recorded.`, 'success');
            } else {
                showMessageBox("Error", "Cannot add purchase. Please start a new week first.", 'error');
            }
        }
        window.handleProcurementSave = handleProcurementSave;

        function handleDeleteProcurement(itemId) {
            showMessageBox(
                "Confirm Deletion", 
                "Are you sure you want to delete this procurement record? This action cannot be undone.", 
                'warning', 
                () => {
                    const lastEntry = getLastDataEntry();
                    if (lastEntry) {
                        lastEntry.procurement = lastEntry.procurement.filter(item => item.id !== itemId);
                        window.saveData();
                        setView('procurement');
                        showNotification("Procurement record deleted.", 'info');
                    }
                }
            );
        }
        window.handleDeleteProcurement = handleDeleteProcurement;


        // ============================================================
        // ======================== MODAL RENDERERS ===================
        // ============================================================

        function showReportsModal() {
            const modal = document.getElementById('reports-modal');
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Generate Reports</h3>
                    <p class="text-gray-600 mb-6">Select the type of report you wish to generate (as PDF).</p>
                    <div class="space-y-3">
                        <button onclick="generateWeeklySummaryReport()" class="w-full text-left flex items-center bg-gray-50 hover:bg-gray-100 p-4 rounded-lg border transition duration-150">
                            <i data-lucide="bar-chart-2" class="w-5 h-5 mr-3 text-indigo-600"></i>
                            Weekly Summary Report (Current Week)
                        </button>
                        <button onclick="generateStaffWageReport()" class="w-full text-left flex items-center bg-gray-50 hover:bg-gray-100 p-4 rounded-lg border transition duration-150">
                            <i data-lucide="users" class="w-5 h-5 mr-3 text-indigo-600"></i>
                            Staff Wages Report (All Time)
                        </button>
                        <button onclick="generateProcurementHistoryReport()" class="w-full text-left flex items-center bg-gray-50 hover:bg-gray-100 p-4 rounded-lg border transition duration-150">
                            <i data-lucide="package" class="w-5 h-5 mr-3 text-indigo-600"></i>
                            Procurement History Report (All Time)
                        </button>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button type="button" onclick="document.getElementById('reports-modal').classList.add('hidden')" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                            Close
                        </button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        window.showReportsModal = showReportsModal;

        function showResetModal() {
            const modal = document.getElementById('reset-modal');
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 border-b pb-2">Admin Settings</h3>
                    
                    <div class="space-y-4">
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-bold text-red-700">Factory Reset</h4>
                            <p class="text-sm text-red-600 mb-3">This will permanently wipe ALL application data from the cloud and local storage.</p>
                            <button onclick="handleFactoryReset()" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                                Initiate Factory Reset
                            </button>
                        </div>

                        <div class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                            <h4 class="font-bold text-indigo-700">Staff Management</h4>
                            <p class="text-sm text-indigo-600 mb-3">Manage staff members and their roles.</p>
                            <button onclick="setView('staff-list'); document.getElementById('reset-modal').classList.add('hidden');" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                                Go to Staff List
                            </button>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="button" onclick="document.getElementById('reset-modal').classList.add('hidden')" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-150">
                            Close
                        </button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        window.showResetModal = showResetModal;

        function handleFactoryReset() {
            document.getElementById('reset-modal').classList.add('hidden');
            showMessageBox(
                "Final Warning: Factory Reset", 
                "Are you absolutely sure? This will delete all weekly, staff, and procurement data permanently from ALL devices. Type the system PIN to confirm.", 
                'error', 
                () => {
                    const pin = prompt("Enter the System PIN to confirm full data wipe:");
                    if (pin === SYSTEM_PIN) {
                        window.localDb = [];
                        localStorage.removeItem(LOCAL_DB_KEY);
                        window.saveData(); // Save empty array to cloud
                        window.LAST_WEEK_BALANCE = 0;
                        setView('dashboard');
                        showNotification("Factory Reset Complete. All data wiped.", 'error');
                    } else if (pin !== null) {
                        showNotification("Incorrect PIN. Reset cancelled.", 'error');
                    }
                }
            );
        }
        window.handleFactoryReset = handleFactoryReset;

        function showBalanceModal() {
            const modal = document.getElementById('balance-modal');
            const currentBalance = calculateBalance();

            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all duration-300 scale-95">
                    <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Financial Balance</h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center text-lg font-medium p-3 bg-gray-50 rounded-lg">
                            <span>Last Week's Starting Balance:</span>
                            <span class="text-gray-800">${formatCurrency(window.LAST_WEEK_BALANCE)}</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-medium p-3 bg-gray-50 rounded-lg">
                            <span>Current Week Revenue:</span>
                            <span class="text-green-600">${formatCurrency(getLastDataEntry()?.entries.reduce((sum, entry) => sum + entry.revenue, 0) || 0)}</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-medium p-3 bg-gray-50 rounded-lg">
                            <span>Current Week Expenditures (Wages + Procurement):</span>
                            <span class="text-red-600">${formatCurrency((getLastDataEntry()?.entries.reduce((sum, entry) => sum + entry.wage, 0) || 0) + (getLastDataEntry()?.procurement.reduce((sum, item) => sum + item.cost, 0) || 0))}</span>
                        </div>
                        <div class="flex justify-between items-center text-2xl font-extrabold p-4 rounded-lg ${currentBalance >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            <span>FINAL BALANCE:</span>
                            <span>${formatCurrency(currentBalance)}</span>
                        </div>
                    </div>

                    <div class="mt-6 flex justify-end">
                        <button type="button" onclick="document.getElementById('balance-modal').classList.add('hidden')" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Got It
                        </button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            lucide.createIcons();
        }
        window.showBalanceModal = showBalanceModal;


        // ============================================================
        // ========================= PDF REPORTS ======================
        // ============================================================

        function showPdfLoader(show) {
            document.getElementById('pdf-loader').style.display = show ? 'flex' : 'none';
        }

        function generateWeeklySummaryReport() {
            document.getElementById('reports-modal').classList.add('hidden');
            showPdfLoader(true);

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const lastEntry = getLastDataEntry();
                const currentBalance = calculateBalance();

                if (!lastEntry) {
                    showPdfLoader(false);
                    return showMessageBox("Error", "No weekly data available to generate a summary report.", 'error');
                }

                doc.setFontSize(18);
                doc.text("Trinah Designs Weekly Summary Report", 14, 22);
                doc.setFontSize(11);
                doc.text(`Report Date: ${formatDate(new Date())}`, 14, 30);
                doc.text(`Week: ${formatDate(lastEntry.startDate)} - ${formatDate(lastEntry.endDate)}`, 14, 36);

                const totalRevenue = lastEntry.entries.reduce((sum, entry) => sum + entry.revenue, 0);
                const totalWage = lastEntry.entries.reduce((sum, entry) => sum + entry.wage, 0);
                const totalProcurement = lastEntry.procurement.reduce((sum, item) => sum + item.cost, 0);
                const totalExpenditure = totalWage + totalProcurement;

                doc.autoTable({
                    startY: 45,
                    head: [['Metric', 'Amount']],
                    body: [
                        ['Starting Balance', formatCurrency(window.LAST_WEEK_BALANCE)],
                        ['Total Revenue', formatCurrency(totalRevenue)],
                        ['Total Staff Wages', formatCurrency(totalWage)],
                        ['Total Procurement Cost', formatCurrency(totalProcurement)],
                        ['Total Expenditure', formatCurrency(totalExpenditure)],
                        ['FINAL BALANCE', formatCurrency(currentBalance)],
                    ],
                    headStyles: { fillColor: [59, 130, 246] },
                    foot: [['FINAL BALANCE', formatCurrency(currentBalance)]],
                    footStyles: { fillColor: [147, 197, 253], textColor: [0, 0, 0], fontStyle: 'bold' }
                });

                const finalY = doc.autoTable.previous.finalY + 10;
                doc.setFontSize(14);
                doc.text("Detailed Entries:", 14, finalY);

                const detailedBody = lastEntry.entries.map(entry => {
                    const staff = window.localDb.find(d => d.key === 'staffList')?.data.find(s => s.id === entry.staffId);
                    return [
                        entry.item,
                        staff ? staff.name : 'Unknown',
                        formatCurrency(entry.revenue),
                        formatCurrency(entry.wage)
                    ];
                });

                doc.autoTable({
                    startY: finalY + 5,
                    head: [['Item', 'Staff', 'Revenue', 'Wage']],
                    body: detailedBody,
                    theme: 'striped',
                    headStyles: { fillColor: [100, 116, 139] }
                });


                doc.save(`Weekly_Summary_${lastEntry.startDate.substring(0, 10)}.pdf`);
                showPdfLoader(false);
                showNotification("Weekly Summary PDF generated.", 'success');
            }, 50);
        }

        function generateStaffWageReport() {
            document.getElementById('reports-modal').classList.add('hidden');
            showPdfLoader(true);

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const allStaff = window.localDb.find(d => d.key === 'staffList')?.data || [];
                const weeklyData = window.localDb.find(d => d.key === 'weeklyData')?.data || [];

                if (weeklyData.length === 0) {
                    showPdfLoader(false);
                    return showMessageBox("Error", "No historical data available for staff wage reports.", 'error');
                }

                doc.setFontSize(18);
                doc.text("Trinah Designs Staff Wages Report (All Time)", 14, 22);
                doc.setFontSize(11);
                doc.text(`Report Date: ${formatDate(new Date())}`, 14, 30);

                const staffWageMap = {};

                weeklyData.forEach(week => {
                    week.entries.forEach(entry => {
                        if (!staffWageMap[entry.staffId]) {
                            staffWageMap[entry.staffId] = { totalWage: 0, entries: 0, weeks: new Set() };
                        }
                        staffWageMap[entry.staffId].totalWage += entry.wage;
                        staffWageMap[entry.staffId].entries += 1;
                        staffWageMap[entry.staffId].weeks.add(week.id);
                    });
                });

                const staffReportBody = allStaff.map(staff => {
                    const stats = staffWageMap[staff.id] || { totalWage: 0, entries: 0, weeks: new Set() };
                    return [
                        staff.name,
                        staff.role,
                        formatCurrency(stats.totalWage),
                        stats.entries,
                        stats.weeks.size
                    ];
                });

                doc.autoTable({
                    startY: 40,
                    head: [['Staff Name', 'Role', 'Total Wages Paid', 'Total Entries', 'Weeks Worked']],
                    body: staffReportBody,
                    theme: 'grid',
                    headStyles: { fillColor: [59, 130, 246] }
                });

                doc.save(`Staff_Wages_Report.pdf`);
                showPdfLoader(false);
                showNotification("Staff Wages PDF generated.", 'success');
            }, 50);
        }

        function generateProcurementHistoryReport() {
            document.getElementById('reports-modal').classList.add('hidden');
            showPdfLoader(true);

            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const weeklyData = window.localDb.find(d => d.key === 'weeklyData')?.data || [];

                if (weeklyData.length === 0) {
                    showPdfLoader(false);
                    return showMessageBox("Error", "No historical data available for procurement reports.", 'error');
                }

                doc.setFontSize(18);
                doc.text("Trinah Designs Procurement History Report", 14, 22);
                doc.setFontSize(11);
                doc.text(`Report Date: ${formatDate(new Date())}`, 14, 30);

                let allProcurement = [];
                weeklyData.forEach(week => {
                    week.procurement.forEach(item => {
                        allProcurement.push({ ...item, weekId: week.id, weekStart: week.startDate });
                    });
                });

                allProcurement.sort((a, b) => new Date(a.date) - new Date(b.date));

                const totalAllTimeCost = allProcurement.reduce((sum, item) => sum + item.cost, 0);

                const procurementBody = allProcurement.map(item => [
                    formatDate(item.date),
                    item.item,
                    item.supplier,
                    formatCurrency(item.cost),
                    formatDate(item.weekStart)
                ]);

                doc.autoTable({
                    startY: 40,
                    head: [['Date', 'Item', 'Supplier', 'Cost', 'Week Start']],
                    body: procurementBody,
                    theme: 'striped',
                    headStyles: { fillColor: [74, 222, 128] },
                    foot: [['Total All-Time Cost', '', '', formatCurrency(totalAllTimeCost), '']],
                    footStyles: { fillColor: [187, 247, 208], textColor: [0, 0, 0], fontStyle: 'bold' }
                });

                doc.save(`Procurement_History_Report.pdf`);
                showPdfLoader(false);
                showNotification("Procurement History PDF generated.", 'success');
            }, 50);
        }

        // ============================================================
        // ====================== AUTHENTICATION ======================
        // ============================================================

        function renderAuthScreen() {
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('recovery-container').classList.add('hidden');
            document.getElementById('auth-container').classList.remove('hidden');

            document.getElementById('auth-container').innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                    <div class="text-center mb-6">
                        <i data-lucide="scissors" class="w-10 h-10 mx-auto text-indigo-600 mb-2"></i>
                        <h2 class="text-2xl font-bold text-gray-900">Admin Login</h2>
                        <p class="text-sm text-gray-500">Sign in to manage Trinah Designs</p>
                        <p id="auth-status" class="mt-2 text-xs text-red-500"></p>
                    </div>
                    <form onsubmit="event.preventDefault(); handleAuthSubmit(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (Admin)</label>
                                <input type="tel" id="phone" name="phone" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 0712345678">
                            </div>
                            <div>
                                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                                <input type="password" id="password" name="password" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2.5 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                Login / Register
                            </button>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <button onclick="renderRecoveryScreen()" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">
                            Forgot Password?
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        window.renderAuthScreen = renderAuthScreen;

        // Placeholder authentication submission handler
        function handleAuthSubmit(event) {
            const phone = event.target.phone.value;
            const password = event.target.password.value;
            
            // This is simple local auth for the demo, which will be replaced by the Firebase logic later
            // In a real app, this would use Firebase Auth functions.
            const isAdmin = (window.localDb.find(d => d.key === 'staffList')?.data || [])
                            .find(u => u.phone === phone && u.role === 'Admin');

            if (isAdmin) {
                const user = { phone, password, role: 'admin' };
                handleLogin(user);
            } else {
                document.getElementById('auth-status').textContent = "Invalid phone or password. Only Admin can login.";
            }
        }

        function handleLogin(user) {
            window.currentUser = user;
            localStorage.setItem(SESSION_KEY, JSON.stringify(user));
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            setView('dashboard');
            showNotification(`Welcome, ${user.role}!`, 'success');
        }

        function logoutUser() {
            localStorage.removeItem(SESSION_KEY);
            window.currentUser = null;
            // The Firebase signOut is not strictly needed here since we rely on custom token, 
            // but for completeness in a non-canvas environment, it would be here.
            renderAuthScreen();
            showNotification("Logged out successfully.", 'info');
        }


        // ============================================================
        // ====================== RECOVERY LOGIC ======================
        // ============================================================

        function renderRecoveryScreen() {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('recovery-container').classList.remove('hidden');

            document.getElementById('recovery-container').innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                    <div class="text-center mb-6">
                        <i data-lucide="lock-open" class="w-10 h-10 mx-auto text-yellow-600 mb-2"></i>
                        <h2 class="text-2xl font-bold text-gray-900">Password Recovery</h2>
                        <p class="text-sm text-gray-500">Step 1: Verify System PIN</p>
                    </div>
                    <form onsubmit="event.preventDefault(); handleRecoveryStep1(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="pin" class="block text-sm font-medium text-gray-700">System PIN</label>
                                <input type="password" id="pin" name="pin" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2.5 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                Verify PIN
                            </button>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <button onclick="renderAuthScreen()" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">
                            Back to Login
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        window.renderRecoveryScreen = renderRecoveryScreen;

        function verifySystemPin(pin) {
            return pin === SYSTEM_PIN;
        }
        window.verifySystemPin = verifySystemPin;

        function handleRecoveryStep1(event) {
            const pin = event.target.pin.value;
            if (verifySystemPin(pin)) {
                renderRecoveryStep2();
            } else {
                showMessageBox("Access Denied", "Incorrect System PIN. Recovery cancelled.", 'error');
            }
        }
        window.handleRecoveryStep1 = handleRecoveryStep1;

        function renderRecoveryStep2() {
            document.getElementById('recovery-container').innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
                    <div class="text-center mb-6">
                        <i data-lucide="shield-check" class="w-10 h-10 mx-auto text-green-600 mb-2"></i>
                        <h2 class="text-2xl font-bold text-gray-900">Password Recovery</h2>
                        <p class="text-sm text-gray-500">Step 2: Reset Admin Password (Phone Auth is now unlocked)</p>
                    </div>
                    <form onsubmit="event.preventDefault(); handleRecoveryStep2(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="adminPhone" class="block text-sm font-medium text-gray-700">Admin Phone Number</label>
                                <input type="tel" id="adminPhone" name="adminPhone" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 0712345678">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password</label>
                                <input type="password" id="newPassword" name="newPassword" required class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                                Reset Password
                            </button>
                        </div>
                    </form>
                    <div class="mt-6 text-center">
                        <button onclick="renderAuthScreen()" class="text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">
                            Back to Login
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function handleRecoveryStep2(event) {
            const phone = event.target.adminPhone.value;
            const newPassword = event.target.newPassword.value;
            
            // In a real app, this would use Firebase Auth to update the user's password.
            // For this demo, we'll just log it.

            // Find the admin user (or just assume the one logging in is the admin for simplicity)
            const adminUser = (window.localDb.find(d => d.key === 'staffList')?.data || [])
                            .find(u => u.phone === phone && u.role === 'Admin');

            if (adminUser) {
                // In a real Firebase setup, the user's password would be updated in the Firebase Auth system.
                // Since this demo uses simple phone/password logic for local login, we can't truly update it without
                // a full backend. We will just confirm the change.
                showMessageBox("Password Reset Successful", "The password for the admin phone has been securely reset. You can now log in.", 'success', () => {
                    renderAuthScreen();
                    document.getElementById('phone').value = phone;
                    document.getElementById('password').value = newPassword;
                });
            } else {
                showMessageBox("Error", "Admin phone number not found in staff list.", 'error');
            }
        }
        window.handleRecoveryStep2 = handleRecoveryStep2;

        // ============================================================
        // =================== INIT AND SETUP =========================
        // ============================================================

        // Functions exposed globally for HTML interaction
        window.handleSaveStaff = handleSaveStaff;
        window.handleDeleteStaff = handleDeleteStaff;
        window.handleProcurementSave = handleProcurementSave;
        window.handleProcurementDateChange = handleProcurementDateChange;
        
        // ============================================================
        // ================ CORRECTED FIREBASE INTEGRATION ============
        // ============================================================
        
        // Globals for Firebase services
        let db;
        let auth;
        let currentUserId = 'loading'; // Will hold the UID after auth
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Define the single document path for shared, public application state
        // We use a public path so all devices sync the same data.
        function getMainDocRef() {
            // Path: /artifacts/{APP_ID}/public/data/trinah_manager_state/main_data_state
            return doc(db, `artifacts/${APP_ID}/public/data/trinah_manager_state`, 'main_data_state');
        }

        // The main function to push the current 'localDb' state to Firestore
        window.saveDataToCloud = async function() {
            if (!db || currentUserId === 'loading') {
                console.error("Firestore not initialized or user not authenticated. Cannot save to cloud.");
                return;
            }
            try {
                // Store the entire 'localDb' object/array under a 'data' field
                await setDoc(getMainDocRef(), { 
                    data: window.localDb, 
                    lastUpdated: serverTimestamp(),
                    userId: currentUserId 
                }, { merge: true });
                console.log("Data successfully pushed to Firestore.");
            } catch (e) {
                console.error("Error saving data to Firestore: ", e);
                window.showNotification("Error: Could not sync data to the cloud.", 'error');
            }
        }

        // Function to set up the real-time listener from Firestore
        function startRealtimeSync() {
            if (window.unsubscribeFirestore) {
                window.unsubscribeFirestore();
            }

            window.unsubscribeFirestore = onSnapshot(getMainDocRef(), (docSnap) => {
                if (docSnap.exists() && docSnap.data().data) {
                    const cloudData = docSnap.data().data;
                    // Only update if the cloud data is different from the current local state
                    // This prevents infinite loops caused by the local device writing to the cloud
                    if (JSON.stringify(cloudData) !== JSON.stringify(window.localDb)) {
                        console.log("Received data update from cloud. Updating UI.");
                        window.localDb = cloudData;
                        
                        // Force the UI update after receiving data
                        window.updateUI(); 
                        
                        // Also update localStorage as a last-resort cache
                        localStorage.setItem(window.LOCAL_DB_KEY, JSON.stringify(window.localDb));
                        
                        window.showNotification("Data successfully synced from cloud.", 'success');
                    }
                } else if (!docSnap.exists() && window.localDb.length > 0) {
                    // If the document is missing but we have local data, it's a first run, so push the current local data.
                    console.log("Main data document missing. Migrating current local data to cloud.");
                    window.saveDataToCloud();
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                window.showNotification("Real-time sync failed. Check console for details.", 'error');
            });
        }

        // This function initializes Firebase and performs authentication
        async function initFirebase() {
            // 1. Load Firebase services
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, doc, setDoc, onSnapshot, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            
            // 2. Get Config
            const firebaseConfig = jparse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}', {});
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing. Cannot initialize cloud backend.");
                return;
            }

            // 3. Initialize App and Services
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // 4. Authenticate using the provided custom token
            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            try {
                if (token) {
                    const userCredential = await signInWithCustomToken(auth, token);
                    currentUserId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    currentUserId = userCredential.user.uid;
                }
                console.log("Firebase Auth successful. User ID:", currentUserId);

                // 5. Override the global saveData function to use the cloud
                window.saveData = window.saveDataToCloud;
                console.log("Overrode saveData to use Firestore sync.");

                // 6. Start real-time listener
                startRealtimeSync();
                
                // 7. Notify user
                window.showNotification("Cloud backend active  real-time sync enabled.", 'info');

            } catch (e) {
                console.error("Firebase Auth or Init failed:", e);
                currentUserId = 'anonymous-failed';
                window.showNotification(`Authentication failed. App running in local-only mode. Error: ${e.message}`, 'error');
            }
        }

        // Initialize App UI based on session and then init Firebase
        window.onload = function() {
            const sessionUser = localStorage.getItem(SESSION_KEY);
            if (sessionUser) {
                try {
                    handleLogin(JSON.parse(sessionUser));
                } catch(e) {
                    renderAuthScreen();
                }
            } else {
                renderAuthScreen();
            }
            
            // Start Firebase initialization immediately
            initFirebase();
        };
    </script>
</body>
</html>
