<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinah Designs Admin Manager (Cloud)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load jsPDF for Reports -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Load jsPDF AutoTable for easier tables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.7);
        }
        /* Loaders */
        #pdf-loader, #app-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; }
        .pdf-loader-backdrop { position: absolute; inset: 0; background: rgba(15,23,42,0.6); }
        .app-loader-bg { position: absolute; inset: 0; background: #f8fafc; }
        .pdf-loader-box {
            position: relative; z-index: 101; width: 320px; padding: 18px 20px;
            border-radius: 12px; background: #ffffff;
            box-shadow: 0 10px 30px rgba(2,6,23,0.5);
            display: flex; gap: 12px; align-items: center;
        }
        .spinner {
            width: 38px; height: 38px; border-radius: 50%;
            border: 4px solid #e6edf8; border-top-color: #4F46E5;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { font-weight:600; font-size:14px; color: #0f172a; }
        
        /* Mobile Menu Transitions */
        #mobile-menu { transition: transform 0.3s ease-in-out; }
        .translate-x-full { transform: translateX(100%); }
        .translate-x-0 { transform: translateX(0); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global App Loader (Initial Load) -->
    <div id="app-loader">
        <div class="app-loader-bg"></div>
        <div class="z-50 flex flex-col items-center gap-4">
            <div class="spinner"></div>
            <p class="text-slate-500 font-medium animate-pulse">Connecting to Cloud Database...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen hidden"></div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 transform opacity-0 -translate-y-full" style="display: none;"></div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- PDF Loader -->
    <div id="pdf-loader" style="display:none;">
        <div class="pdf-loader-backdrop"></div>
        <div class="pdf-loader-box">
            <div class="spinner"></div>
            <div class="loader-text">Generating report — please wait...</div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging level for debugging (optional, but helpful)
        setLogLevel('debug');


        // --- Firebase Configuration ---
        const firebaseConfig = JSON.parse(__firebase_config || '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'trinah-default';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Collections Paths (Strict Artifacts Rule) ---
        const PUBLIC_DATA_PATH = ['artifacts', appId, 'public', 'data'];
        
        // Helper to get collection ref
        const getColRef = (colName) => collection(db, ...PUBLIC_DATA_PATH, colName);
        const getDocRef = (colName, docId) => doc(db, ...PUBLIC_DATA_PATH, colName, docId);

        // --- Global State ---
        let currentUser = null; 
        let managedUser = null; 
        let currentView = 'dashboard';
        
        // Data for managed user
        let history = []; 
        let archive = []; 
        let startingPressure = { dresses: 0, twoPcs: 0 }; 
        
        let selectedDayIndex = 0;
        let selectedReport = "Daily"; 
        let selectedProcurementDate = new Date(); 

        // System Constants
        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const SYSTEM_PIN = "2580";
        const DEFAULT_BUY_PRICE = 120;
        const DEFAULT_SELL_PRICE = 200;

        // UI References
        const appElement = document.getElementById('app');
        const notificationContainer = document.getElementById('notification-container');
        const modalContainer = document.getElementById('modal-container');
        const loaderElement = document.getElementById('app-loader');

        // --- Initialization ---
        
        async function initApp() {
            try {
                // Correct Auth Flow: Use Custom Token if available, otherwise Anonymous
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Check if Admin Exists (to prevent prompting creation again)
                const usersRef = getColRef('users');
                const snapshot = await getDocs(usersRef);
                const adminExists = !snapshot.empty; // If any user exists, we assume setup is done
                
                // Expose state to window for the "authHandler"
                window.adminExists = adminExists;
                
                // Hide Loader
                loaderElement.style.display = 'none';
                appElement.classList.remove('hidden');

                // Check Session
                const sessionUser = localStorage.getItem('trinah_session_user_phone');
                if (sessionUser) {
                    await handleLoginCheck(sessionUser);
                } else {
                    renderAuthScreen();
                }

            } catch (error) {
                console.error("Init Error:", error);
                // Fallback for UI if init fails completely
                loaderElement.style.display = 'none';
                appElement.classList.remove('hidden');
                appElement.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Error connecting to database. Please refresh.</div>`;
            }
        }
        
        initApp();

        // --- Database Operations (Async) ---

        async function fetchUserData(phone) {
            setLoading(true);
            try {
                const docRef = getDocRef('user_data', phone);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    history = data.history ? JSON.parse(data.history) : [];
                    archive = data.archive ? JSON.parse(data.archive) : [];
                    startingPressure = data.startingPressure ? JSON.parse(data.startingPressure) : { dresses: 0, twoPcs: 0 };
                } else {
                    history = [];
                    archive = [];
                    startingPressure = { dresses: 0, twoPcs: 0 };
                }
                
                // Set default day
                const jsDay = new Date().getDay();
                selectedDayIndex = jsDay === 0 ? 6 : jsDay - 1;

            } catch (e) {
                console.error("Error loading data:", e);
                showNotification("Error loading user data");
            } finally {
                setLoading(false);
            }
        }

        async function saveUserData(phone) {
            // Background save (no loading spinner blocking)
            try {
                const docRef = getDocRef('user_data', phone);
                await setDoc(docRef, {
                    history: JSON.stringify(history),
                    archive: JSON.stringify(archive),
                    startingPressure: JSON.stringify(startingPressure)
                });
            } catch (e) {
                console.error("Save failed:", e);
                showNotification("⚠️ Save failed! Check connection.");
            }
        }

        async function getAllUsers() {
            const snap = await getDocs(getColRef('users'));
            return snap.docs.map(d => ({ id: d.id, ...d.data() }));
        }

        async function getProcurementLogs() {
            const docRef = getDocRef('procurement', 'logs');
            const snap = await getDoc(docRef);
            return snap.exists() ? snap.data() : {};
        }

        async function saveProcurementLog(logs) {
            const docRef = getDocRef('procurement', 'logs');
            await setDoc(docRef, logs);
        }

        // --- Utility Functions ---

        function setLoading(isLoading) {
            if (loaderElement) loaderElement.style.display = isLoading ? 'flex' : 'none';
        }
        
        // Remove spaces for easier matching
        function normalizePhone(phone) {
            if(!phone) return "";
            return phone.replace(/\s+/g, '');
        }

        function renderIcon(name, attributes = {}) {
            if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                const icons = lucide.createIcons();
                if (icons && icons[name]) return icons[name].toSvg(attributes);
            }
            return `<i data-lucide="${name}" class="${attributes.class || ''}"></i>`;
        }

        function refreshIcons() {
            if (window.lucide && window.lucide.createIcons) window.lucide.createIcons();
        }

        function showNotification(msg, type = 'default') {
            let bgColor = 'bg-slate-800';
            let icon = 'info';
            if (type === 'error') {
                bgColor = 'bg-red-600';
                icon = 'x-circle';
            } else if (type === 'success') {
                bgColor = 'bg-emerald-600';
                icon = 'check-circle';
            }
            
            notificationContainer.innerHTML = `
                <div class="${bgColor} text-white px-6 py-3 rounded-full shadow-2xl text-sm font-medium flex items-center gap-2">
                    ${renderIcon(icon, {class: 'w-4 h-4'})}
                    ${msg}
                </div>`;
            notificationContainer.style.display = 'block';
            requestAnimationFrame(() => {
                notificationContainer.classList.remove('opacity-0', '-translate-y-full');
                notificationContainer.classList.add('opacity-100', 'translate-y-5');
                refreshIcons();
            });
            setTimeout(() => {
                notificationContainer.classList.remove('opacity-100', 'translate-y-5');
                notificationContainer.classList.add('opacity-0', '-translate-y-full');
                setTimeout(() => notificationContainer.style.display = 'none', 300);
            }, 3000);
        }

        function formatCurrency(val) {
            return `KES ${val.toLocaleString()}`;
        }

        function getFullHistory() {
            return [...archive, ...history];
        }

        function getFilteredHistory() {
            const fullHistory = getFullHistory();
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const todayEnd = todayStart + (24 * 60 * 60 * 1000);

            return fullHistory.filter(entry => {
                let entryTime = entry.id;
                if (!entryTime) {
                    const parsed = new Date(entry.fullDate);
                    if (!isNaN(parsed.getTime())) entryTime = parsed.getTime();
                    else return false;
                }
                switch (selectedReport) {
                    case "Daily": return entryTime >= todayStart && entryTime < todayEnd;
                    case "Weekly": return entryTime >= todayStart - (6 * 86400000);
                    case "Monthly": return entryTime >= todayStart - (30 * 86400000);
                    case "Quarterly": return entryTime >= todayStart - (90 * 86400000);
                    case "Yearly": return entryTime >= todayStart - (365 * 86400000);
                    default: return true;
                }
            });
        }

        // --- Logic Handlers ---

        window.authHandler = async function(e) {
            e.preventDefault();
            const rawPhone = document.getElementById('auth-phone').value.trim();
            const phone = normalizePhone(rawPhone);
            const password = document.getElementById('auth-password').value.trim();
            const name = document.getElementById('auth-name') ? document.getElementById('auth-name').value.trim() : null;
            const errDiv = document.getElementById('auth-error');

            if (!phone || !password) {
                if(errDiv) errDiv.innerText = "Please enter phone and password.";
                return;
            }

            setLoading(true);

            try {
                // If Creating Admin (First Run Only)
                if (name) { 
                    // Double check admin doesn't exist
                    const existingUsers = await getAllUsers();
                    if (existingUsers.length > 0) {
                        showNotification("Admin already exists. Please login.", 'error');
                        window.location.reload();
                        return;
                    }

                    const newUser = { 
                        name, phone, password, role: 'admin',
                        prices: { dressBuy: 120, dressSell: 200, twoPcBuy: 120, twoPcSell: 200 }
                    };
                    
                    // Create Admin Doc
                    await setDoc(getDocRef('users', phone), newUser);
                    await handleLogin(newUser);
                    return;
                }

                // Normal Login
                const q = query(getColRef('users'), where('phone', '==', phone));
                const snap = await getDocs(q);

                if (snap.empty) {
                    if(errDiv) errDiv.innerText = "User not found.";
                    setLoading(false);
                    return;
                }

                const user = snap.docs[0].data();
                if (user.password !== password) {
                    if(errDiv) errDiv.innerText = "Incorrect password.";
                    setLoading(false);
                    return;
                }

                await handleLogin(user);

            } catch (err) {
                console.error(err);
                if(errDiv) errDiv.innerText = "Login error. Check connection.";
                setLoading(false);
            }
        };

        async function handleLoginCheck(phone) {
            setLoading(true);
            try {
                const docRef = getDocRef('users', phone);
                const snap = await getDoc(docRef);
                if (snap.exists()) {
                    await handleLogin(snap.data(), true);
                } else {
                    localStorage.removeItem('trinah_session_user_phone');
                    renderAuthScreen();
                }
            } catch (e) {
                console.error(e);
                renderAuthScreen();
            }
            setLoading(false);
        }

        async function handleLogin(user, skipSave = false) {
            currentUser = user;
            if (!skipSave) localStorage.setItem('trinah_session_user_phone', user.phone);

            if (currentUser.role === 'admin') {
                managedUser = null;
                selectedProcurementDate = new Date();
                renderAdminOverview();
            } else {
                managedUser = currentUser;
                await fetchUserData(currentUser.phone);
                renderIndividualDashboard();
            }
            setLoading(false);
        }

        window.handleLogout = function() {
            currentUser = null;
            managedUser = null;
            localStorage.removeItem('trinah_session_user_phone');
            renderAuthScreen();
        };

        window.handleSubmit = async function() {
            if (!managedUser) return;

            const dDress = Number(document.getElementById('dispatch-dress').value) || 0;
            const d2pc = Number(document.getElementById('dispatch-2pc').value) || 0;
            const sDress = Number(document.getElementById('sales-dress').value) || 0;
            const s2pc = Number(document.getElementById('sales-2pc').value) || 0;

            if (dDress === 0 && d2pc === 0 && sDress === 0 && s2pc === 0) return showNotification("Please enter values.");

            // Calculate based on current day
            const now = new Date();
            const currentDayName = DAYS[selectedDayIndex];
            
            // Backdate logic
            const jsDay = now.getDay();
            const mappedDay = jsDay === 0 ? 6 : jsDay - 1;
            const dayDiff = mappedDay - selectedDayIndex;
            const targetDate = new Date();
            targetDate.setDate(now.getDate() - dayDiff);
            const fullDateString = targetDate.toLocaleDateString();

            // Calculate Pressure
            let prevRemDress = 0, prevRem2pc = 0;
            const fullHist = getFullHistory();
            if (fullHist.length > 0) {
                const last = fullHist[fullHist.length - 1];
                prevRemDress = last.remDresses ?? (last.remaining || 0);
                prevRem2pc = last.remTwoPcs ?? 0;
            } else {
                prevRemDress = startingPressure.dresses;
                prevRem2pc = startingPressure.twoPcs;
            }

            const newRemDress = prevRemDress + dDress - sDress;
            const newRem2pc = prevRem2pc + d2pc - s2pc;

            if (newRemDress < 0 || newRem2pc < 0) return showNotification("Error: Negative stock!", 'error');

            const prices = managedUser.prices || { dressBuy: 120, dressSell: 200, twoPcBuy: 120, twoPcSell: 200 };
            const profit = (sDress * (prices.dressSell - prices.dressBuy)) + (s2pc * (prices.twoPcSell - prices.twoPcBuy));

            const record = {
                id: Date.now(),
                date: currentDayName,
                fullDate: fullDateString,
                dispatchedDresses: dDress, dispatchedTwoPcs: d2pc,
                soldDresses: sDress, soldTwoPcs: s2pc,
                remDresses: newRemDress, remTwoPcs: newRem2pc,
                profit: profit
            };

            history.push(record);
            startingPressure = { dresses: newRemDress, twoPcs: newRem2pc }; // Optimistic update

            // Save to Cloud
            await saveUserData(managedUser.phone);
            
            // Advance day if not today
            if (selectedDayIndex < mappedDay) selectedDayIndex++;
            
            showNotification("Saved successfully!", 'success');
            renderIndividualDashboard();
        };

        window.handleDeleteLast = async function() {
            if (!history.length) return;
            history.pop();
            
            // Recalculate pressure
            const fullHist = getFullHistory();
            if (fullHist.length > 0) {
                const last = fullHist[fullHist.length - 1];
                startingPressure = { dresses: last.remDresses||0, twoPcs: last.remTwoPcs||0 };
            } else {
                // If history is empty, reload the original startingPressure from a fresh fetch or assume default
                // For simplicity, we trust the logic in fetchUserData
            }
            
            await saveUserData(managedUser.phone);
            showNotification("Last entry deleted.", 'default');
            renderIndividualDashboard();
        };

        window.handleStartNewWeek = async function() {
            document.getElementById('week-complete-modal')?.remove();
            
            const fullHist = getFullHistory();
            let finalP = { dresses: 0, twoPcs: 0 };
            if (fullHist.length > 0) {
                const last = fullHist[fullHist.length - 1];
                finalP = { dresses: last.remDresses||0, twoPcs: last.remTwoPcs||0 };
            } else {
                finalP = startingPressure;
            }

            archive = [...archive, ...history];
            history = [];
            startingPressure = finalP;
            selectedDayIndex = 0;

            await saveUserData(managedUser.phone);
            showNotification("New week started!", 'success');
            renderIndividualDashboard();
        };

        // --- Admin Handlers ---

        window.handleSaveStaff = async function(e, mode, originalPhone) {
            e.preventDefault();
            const name = document.getElementById('staff-name').value;
            const phone = normalizePhone(document.getElementById('staff-phone').value.trim());
            const password = document.getElementById('staff-pass').value;
            const dressBuy = Number(document.getElementById('price-dress-buy').value);
            const dressSell = Number(document.getElementById('price-dress-sell').value);
            const twoPcBuy = Number(document.getElementById('price-2pc-buy').value);
            const twoPcSell = Number(document.getElementById('price-2pc-sell').value);

            setLoading(true);
            try {
                const userData = {
                    name, phone, password, role: 'staff',
                    prices: { dressBuy, dressSell, twoPcBuy, twoPcSell }
                };

                if (mode === 'add') {
                    // check duplicates
                    const check = await getDoc(getDocRef('users', phone));
                    if (check.exists()) {
                        showNotification("User already exists!", 'error');
                        setLoading(false);
                        return;
                    }
                    await setDoc(getDocRef('users', phone), userData);
                } else {
                    // Update - if phone changed, we need to handle that (complex), assume phone is ID
                    await setDoc(getDocRef('users', phone), userData, { merge: true });
                }

                document.getElementById('add-staff-modal')?.remove();
                showNotification("Staff saved!", 'success');
                renderUserManagementScreen(); // Refresh list

            } catch(e) { console.error(e); showNotification("Save failed", 'error'); }
            setLoading(false);
        };

        window.handleDeleteStaff = async function(phone) {
            if(!window.confirm("Delete this user? Data will remain but login will be revoked.")) return;
            setLoading(true);
            try {
                await deleteDoc(getDocRef('users', phone));
                showNotification("Staff deleted!", 'success');
                renderUserManagementScreen();
            } catch(e) { console.error(e); showNotification("Delete failed", 'error'); }
            setLoading(false);
        };

        window.handleProcurementSave = async function() {
            const val = document.getElementById('procurement-input').value;
            if(!val) return showNotification("Enter a value first.");
            setLoading(true);
            try {
                const dateKey = selectedProcurementDate.toLocaleDateString();
                const logs = await getProcurementLogs();
                logs[dateKey] = Number(val);
                await saveProcurementLog(logs);
                showNotification("Stock saved!", 'success');
                renderAdminOverview();
            } catch(e) { console.error(e); showNotification("Procurement save failed.", 'error'); }
            setLoading(false);
        };

        // --- Recovery Logic (Fixed) ---

        window.renderRecoveryScreen = function() {
            appElement.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                ${renderIcon('key-round', {class:'w-8 h-8'})}
                            </div>
                            <h1 class="text-2xl font-bold text-slate-800">Account Recovery</h1>
                            <p class="text-sm text-slate-500">Enter phone to verify account.</p>
                        </div>
                        <form id="recovery-form" onsubmit="window.handleRecoveryStep1(event)" class="space-y-4">
                            <input type="text" id="rec-phone" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 outline-none focus:border-indigo-500" placeholder="0712 345 678">
                            <div id="recovery-error" class="text-center text-sm text-red-500 hidden"></div>
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition">Verify</button>
                            <button type="button" onclick="renderAuthScreen()" class="w-full py-3 text-slate-500 font-bold hover:text-slate-700">Back</button>
                        </form>
                    </div>
                </div>`;
            refreshIcons();
        };

        window.handleRecoveryStep1 = async function(e) {
            e.preventDefault();
            const rawPhone = document.getElementById('rec-phone').value.trim();
            const phone = normalizePhone(rawPhone);
            const errDiv = document.getElementById('recovery-error');
            
            setLoading(true);
            errDiv.classList.add('hidden');

            try {
                const docRef = getDocRef('users', phone);
                const snap = await getDoc(docRef);

                if (!snap.exists()) {
                    errDiv.textContent = `User not found (${rawPhone}).`;
                    errDiv.classList.remove('hidden');
                    setLoading(false);
                    return;
                }

                const user = snap.data();
                const form = document.getElementById('recovery-form');
                
                let html = ``;
                if (user.role === 'admin') {
                    html = `
                        <div class="bg-indigo-50 text-indigo-800 p-4 rounded-xl text-sm mb-4">
                            <strong>Admin Account Found.</strong> Enter System PIN to reset.
                        </div>
                        <input type="hidden" id="reset-phone" value="${phone}">
                        <input type="password" id="reset-pin" class="w-full p-3 mb-2 rounded-xl bg-slate-50 border border-slate-200" placeholder="System PIN (Default: ${SYSTEM_PIN})">
                        <input type="password" id="new-pass" class="w-full p-3 mb-4 rounded-xl bg-slate-50 border border-slate-200" placeholder="New Password">
                        <div id="recovery-error-2" class="text-center text-sm text-red-500 hidden mb-4"></div>
                        <button type="button" onclick="window.handleRecoveryFinal('admin')" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Update Password</button>
                    `;
                } else {
                    html = `
                        <div class="bg-emerald-50 text-emerald-800 p-4 rounded-xl text-sm mb-4">
                            <strong>Account Found: ${user.name}</strong>
                        </div>
                        <input type="hidden" id="reset-phone" value="${phone}">
                        <input type="password" id="new-pass" class="w-full p-3 mb-4 rounded-xl bg-slate-50 border border-slate-200" placeholder="New Password">
                        <div id="recovery-error-2" class="text-center text-sm text-red-500 hidden mb-4"></div>
                        <button type="button" onclick="window.handleRecoveryFinal('staff')" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Update Password</button>
                    `;
                }
                form.innerHTML = html;
                refreshIcons();

            } catch(e) { 
                console.error(e); 
                errDiv.textContent = "An error occurred during verification.";
                errDiv.classList.remove('hidden');
            }
            setLoading(false);
        };

        window.handleRecoveryFinal = async function(role) {
            const phone = document.getElementById('reset-phone').value;
            const pass = document.getElementById('new-pass').value;
            const pinElement = document.getElementById('reset-pin');
            const pin = pinElement ? pinElement.value : null;
            const errDiv = document.getElementById('recovery-error-2');

            errDiv.classList.add('hidden');
            if (!pass || pass.length < 4) {
                errDiv.textContent = "New password must be at least 4 characters.";
                errDiv.classList.remove('hidden');
                return;
            }

            if (role === 'admin') {
                if (pin !== SYSTEM_PIN) {
                    errDiv.textContent = `Invalid System PIN. Hint: ${SYSTEM_PIN}`;
                    errDiv.classList.remove('hidden');
                    return;
                }
            }

            setLoading(true);
            try {
                await updateDoc(getDocRef('users', phone), { password: pass });
                showNotification("Password updated! Please log in.", 'success');
                renderAuthScreen();
            } catch(e) { 
                console.error(e); 
                errDiv.textContent = "Error updating password. Try again.";
                errDiv.classList.remove('hidden');
            }
            setLoading(false);
        };


        // --- Render Views ---

        function renderAuthScreen() {
            const adminExists = window.adminExists;

            if (!adminExists) {
                // First Run Setup
                appElement.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-100 text-center">
                            <h1 class="text-2xl font-bold text-slate-800 mb-2">System Setup</h1>
                            <p class="text-sm text-slate-500 mb-6">Enter System PIN to create the Admin account.</p>
                            <input type="password" id="sys-pin" class="w-full p-3 mb-4 rounded-xl bg-slate-50 border text-center text-lg tracking-widest" placeholder="PIN">
                            <div id="setup-form" class="hidden text-left space-y-3">
                                <input id="auth-name" class="w-full p-3 rounded-xl bg-slate-50 border" placeholder="Admin Name">
                                <input id="auth-phone" class="w-full p-3 rounded-xl bg-slate-50 border" placeholder="Phone">
                                <input id="auth-password" type="password" class="w-full p-3 rounded-xl bg-slate-50 border" placeholder="Password">
                                <button onclick="window.authHandler(event)" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Create Admin</button>
                            </div>
                            <button id="unlock-btn" onclick="if(document.getElementById('sys-pin').value==='${SYSTEM_PIN}'){document.getElementById('setup-form').classList.remove('hidden');this.classList.add('hidden');}else{showNotification('Wrong PIN', 'error')}" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Unlock</button>
                        </div>
                    </div>`;
            } else {
                // Standard Login
                appElement.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
                            <div class="text-center mb-8">
                                <div class="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4">T</div>
                                <h1 class="text-2xl font-bold text-slate-800">Trinah Designs</h1>
                                <p class="text-sm text-slate-500">Cloud Manager</p>
                            </div>
                            <form onsubmit="window.authHandler(event)" class="space-y-4">
                                <input type="text" id="auth-phone" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200" placeholder="Phone Number">
                                <input type="password" id="auth-password" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200" placeholder="Password">
                                <div class="flex justify-end pt-1">
                                    <button type="button" onclick="renderRecoveryScreen()" class="text-xs font-bold text-indigo-600 hover:underline">Forgot Password?</button>
                                </div>
                                <p id="auth-error" class="text-red-500 text-sm text-center"></p>
                                <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">Login</button>
                            </form>
                        </div>
                    </div>`;
            }
            refreshIcons();
        }

        async function renderAdminOverview() {
            setLoading(true);
            const users = (await getAllUsers()).filter(u => u.role !== 'admin');
            const procurementLogs = await getProcurementLogs();
            const targetDateStr = selectedProcurementDate.toLocaleDateString();
            const procurementToday = procurementLogs[targetDateStr] || 0;

            // Fetch metrics for all users for ONE day (today)
            // Note: In a real heavy app we would query differently, but here we fetch all user data
            
            let totalStock = 0, totalSales = 0, totalProfit = 0, totalDisp = 0;
            
            // Parallel fetch all user data
            const stats = await Promise.all(users.map(async u => {
                const docSnap = await getDoc(getDocRef('user_data', u.phone));
                if (!docSnap.exists()) return { user: u, stock: 0, sales: 0, profit: 0, disp: 0, stockVal: 0 };
                
                const d = docSnap.data();
                const h = d.history ? JSON.parse(d.history) : [];
                const a = d.archive ? JSON.parse(d.archive) : [];
                const all = [...a, ...h];
                
                // Stock
                let remD = 0, rem2 = 0;
                if(all.length > 0) {
                    remD = all[all.length-1].remDresses || 0;
                    rem2 = all[all.length-1].remTwoPcs || 0;
                } else {
                    const sp = d.startingPressure ? JSON.parse(d.startingPressure) : {};
                    remD = sp.dresses || 0;
                    rem2 = sp.twoPcs || 0;
                }

                // Today's Sales/Disp
                const dayEntries = h.filter(e => e.fullDate === targetDateStr);
                const sales = dayEntries.reduce((acc,e) => acc + (e.soldDresses||0) + (e.soldTwoPcs||0), 0);
                const disp = dayEntries.reduce((acc,e) => acc + (e.dispatchedDresses||0) + (e.dispatchedTwoPcs||0), 0);
                const profit = dayEntries.reduce((acc,e) => acc + (e.profit||0), 0);

                return { user: u, stock: `${remD}/${rem2}`, sales, profit, disp, stockVal: remD+rem2 };
            }));

            // Aggregates
            stats.forEach(s => {
                totalStock += s.stockVal;
                totalSales += s.sales;
                totalProfit += s.profit;
                totalDisp += s.disp;
            });

            const variance = procurementToday - totalDisp;

            appElement.innerHTML = `
                ${renderHeader(true)}
                <main class="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${renderStatCard("Total Stock", totalStock, "layers", "text-orange-600")}
                        ${renderStatCard("Sales (Today)", totalSales, "shopping-bag", "text-blue-600")}
                        ${renderStatCard("Profit (Today)", formatCurrency(totalProfit), "dollar-sign", "text-emerald-600")}
                    </div>

                    <div class="bg-white rounded-2xl shadow border p-6 flex flex-col md:flex-row gap-6">
                        <div class="flex-1">
                            <h2 class="font-bold text-slate-800 flex items-center gap-2 mb-2">${renderIcon('clipboard-list')} Procurement</h2>
                            <div class="flex gap-2">
                                <input type="date" value="${selectedProcurementDate.toISOString().split('T')[0]}" onchange="selectedProcurementDate=new Date(this.value);renderAdminOverview()" class="p-2 border rounded-lg">
                                <input type="number" id="procurement-input" value="${procurementToday||''}" placeholder="Bought" class="p-2 border rounded-lg w-24">
                                <button onclick="handleProcurementSave()" class="bg-indigo-600 text-white px-4 rounded-lg">Save</button>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-xl border w-full md:w-1/3">
                            <div class="flex justify-between text-sm mb-1"><span>Acquired:</span> <b>${procurementToday}</b></div>
                            <div class="flex justify-between text-sm mb-1"><span>Dispatched:</span> <b>${totalDisp}</b></div>
                            <div class="border-t my-1"></div>
                            <div class="flex justify-between font-bold ${variance!=0?'text-red-500':'text-green-600'}">
                                <span>Variance:</span> <span>${variance > 0 ? variance + ' Missing' : (variance < 0 ? Math.abs(variance)+' Extra' : 'Balanced')}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${stats.map(s => `
                            <div onclick="manageUser('${s.user.phone}')" class="bg-white p-4 rounded-xl border hover:border-indigo-500 cursor-pointer transition">
                                <div class="flex justify-between items-center mb-3">
                                    <div class="font-bold text-slate-800">${s.user.name}</div>
                                    ${renderIcon('chevron-right', {class:'w-4 h-4 text-slate-300'})}
                                </div>
                                <div class="flex justify-between text-xs text-slate-500 bg-slate-50 p-2 rounded">
                                    <span>Stock: <b>${s.stock}</b></span>
                                    <span>Sold: <b>${s.sales}</b></span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </main>
            `;
            refreshIcons();
            setLoading(false);
        }
        // Expose function globally for HTML onclick
        window.renderUserManagementScreen = renderUserManagementScreen;

        async function renderUserManagementScreen() {
            setLoading(true);
            const users = (await getAllUsers()).filter(u => u.role !== 'admin');
            appElement.innerHTML = `
                ${renderHeader(true)}
                <main class="max-w-2xl mx-auto p-4 space-y-6">
                    <div class="flex justify-between items-center">
                        <button onclick="handleLogin(currentUser)" class="text-slate-500 hover:bg-white p-2 rounded-lg">${renderIcon('arrow-left')}</button>
                        <h2 class="text-xl font-bold">Manage Staff</h2>
                    </div>
                    <button onclick="showAddStaffModal()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold flex justify-center gap-2 items-center shadow-lg hover:bg-indigo-700">
                        ${renderIcon('user-plus')} Add New Staff
                    </button>
                    <div class="space-y-3">
                        ${users.map(u => `
                            <div class="bg-white p-4 rounded-xl shadow border flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-slate-800">${u.name}</div>
                                    <div class="text-xs text-slate-500">${u.phone}</div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="showAddStaffModal(true, '${u.phone}')" class="p-2 text-indigo-600 bg-indigo-50 rounded-lg">${renderIcon('pencil', {class:'w-4 h-4'})}</button>
                                    <button onclick="handleDeleteStaff('${u.phone}')" class="p-2 text-red-600 bg-red-50 rounded-lg">${renderIcon('trash-2', {class:'w-4 h-4'})}</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </main>
            `;
            refreshIcons();
            setLoading(false);
        }

        function renderIndividualDashboard() {
            if (!managedUser) return;
            const fullHistory = getFullHistory();
            const lastEntry = fullHistory.length > 0 ? fullHistory[fullHistory.length - 1] : null;
            const curD = lastEntry ? lastEntry.remDresses : startingPressure.dresses;
            const cur2 = lastEntry ? lastEntry.remTwoPcs : startingPressure.twoPcs;
            
            const filtered = getFilteredHistory();
            const profit = filtered.reduce((sum, e) => sum + (e.profit||0), 0);

            appElement.innerHTML = `
                ${renderHeader(currentUser.role==='admin')}
                <main class="max-w-5xl mx-auto p-4 md:p-6 space-y-6">
                    <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex justify-between items-center">
                        <div>
                            <div class="text-xs font-bold text-indigo-400">DASHBOARD</div>
                            <div class="font-bold text-indigo-900 text-lg">${managedUser.name}</div>
                        </div>
                        <div class="text-right text-xs text-indigo-500">
                            <b>D:</b> ${curD} | <b>2pc:</b> ${cur2}
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 space-y-4">
                            <div class="bg-white rounded-2xl shadow border p-6">
                                <h2 class="font-bold mb-4 flex items-center gap-2">${renderIcon('plus-circle')} New Entry</h2>
                                <div class="grid grid-cols-4 gap-2 mb-4">
                                    ${DAYS.map((d,i) => `
                                        <button onclick="selectedDayIndex=${i};renderIndividualDashboard()" 
                                            class="p-2 rounded text-[10px] font-bold ${selectedDayIndex===i?'bg-indigo-600 text-white':'bg-slate-50 text-slate-500'}">
                                            ${d.substring(0,3)}
                                        </button>
                                    `).join('')}
                                </div>
                                <div class="space-y-4">
                                    <div class="bg-slate-50 p-3 rounded-lg border">
                                        <div class="text-[10px] font-bold text-slate-400 mb-2">DRESSES</div>
                                        <div class="flex gap-2">
                                            <input id="dispatch-dress" type="number" placeholder="Dispatch" class="w-full p-2 text-sm border rounded">
                                            <input id="sales-dress" type="number" placeholder="Sold" class="w-full p-2 text-sm border rounded">
                                        </div>
                                    </div>
                                    <div class="bg-slate-50 p-3 rounded-lg border">
                                        <div class="text-[10px] font-bold text-slate-400 mb-2">2 PIECES</div>
                                        <div class="flex gap-2">
                                            <input id="dispatch-2pc" type="number" placeholder="Dispatch" class="w-full p-2 text-sm border rounded">
                                            <input id="sales-2pc" type="number" placeholder="Sold" class="w-full p-2 text-sm border rounded">
                                        </div>
                                    </div>
                                    <button onclick="handleSubmit()" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl">Save Record</button>
                                </div>
                            </div>
                            
                            ${lastEntry ? `
                                <div class="bg-white rounded-xl shadow p-4 border flex justify-between items-center">
                                    <span class="text-xs font-bold text-slate-400">LAST: ${lastEntry.date}</span>
                                    <button onclick="handleDeleteLast()" class="text-red-500 text-xs font-bold flex items-center gap-1">${renderIcon('trash-2', {class:'w-3 h-3'})} Delete</button>
                                </div>
                            ` : ''}
                            
                            <button onclick="renderWeekCompleteModal()" class="w-full py-3 bg-slate-800 text-white font-bold rounded-xl">End Week</button>
                        </div>

                        <div class="md:col-span-2 bg-white rounded-2xl shadow border p-6 h-full">
                            <div class="flex justify-between mb-4">
                                <h2 class="font-bold text-slate-800">History</h2>
                                <span class="text-emerald-600 font-bold text-sm">Profit: ${formatCurrency(profit)}</span>
                            </div>
                            <div class="overflow-y-auto max-h-[500px]">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-xs text-slate-500 uppercase sticky top-0">
                                        <tr><th class="p-3">Date</th><th class="p-3">Sold</th><th class="p-3">Stock</th><th class="p-3">Profit</th></tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        ${filtered.map(d => `
                                            <tr>
                                                <td class="p-3 font-medium">${d.fullDate}<br><span class="text-xs text-slate-400">${d.date.substring(0,3)}</span></td>
                                                <td class="p-3 font-bold text-emerald-600">${d.soldDresses}/${d.soldTwoPcs}</td>
                                                <td class="p-3 text-orange-600">${d.remDresses}/${d.remTwoPcs}</td>
                                                <td class="p-3 text-slate-600">${d.profit.toLocaleString()}</td>
                                            </tr>
                                        `).reverse().join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </main>
            `;
            refreshIcons();
        }
        
        // --- Helpers ---
        function renderHeader(isAdmin) {
            return `
                <header class="bg-white border-b p-4 sticky top-0 z-40">
                    <div class="max-w-5xl mx-auto flex justify-between items-center">
                        <div class="font-bold text-indigo-900 flex items-center gap-2">
                            <div class="w-8 h-8 bg-indigo-600 rounded-lg text-white flex items-center justify-center">T</div>
                            Trinah Admin
                        </div>
                        <div class="flex gap-4">
                            ${isAdmin ? `
                                <button onclick="renderUserManagementScreen()" class="text-slate-600 text-sm font-bold flex items-center gap-1">${renderIcon('users',{class:'w-4 h-4'})} Staff</button>
                            ` : ''}
                            <button onclick="handleLogout()" class="text-red-500 text-sm font-bold">Logout</button>
                        </div>
                    </div>
                </header>
            `;
        }
        
        function renderStatCard(label, val, icon, color) {
            return `
                <div class="bg-white p-4 rounded-xl shadow border flex items-center justify-between">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase">${label}</div>
                        <div class="text-xl font-bold ${color}">${val}</div>
                    </div>
                    ${renderIcon(icon, {class: `w-6 h-6 ${color}`})}
                </div>
            `;
        }
        
        function renderWeekCompleteModal() {
            modalContainer.innerHTML = `
                <div id="week-complete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0" onclick="document.getElementById('week-complete-modal').remove()"></div>
                    <div class="bg-white rounded-2xl p-6 w-full max-w-sm relative z-10 text-center">
                        <h2 class="text-xl font-bold mb-4">Complete Week?</h2>
                        <p class="text-sm text-slate-500 mb-6">This will archive current sales and start fresh.</p>
                        <button onclick="handleStartNewWeek()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold mb-2">Yes, Start New Week</button>
                        <button onclick="document.getElementById('week-complete-modal').remove()" class="w-full py-3 text-slate-500 font-bold">Cancel</button>
                    </div>
                </div>`;
        }

        window.showAddStaffModal = function(isEdit, phone) {
            // If edit, we need to try and fetch user details for display
            let userToEdit = {};
            if (isEdit && phone) {
                // Simplified sync/state access here for demo, ideally fetch async
                // Since this is just a modal, we'll rely on the user list being available or prompt re-entry for complexity.
            }

            modalContainer.innerHTML = `
                <div id="add-staff-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0" onclick="document.getElementById('add-staff-modal').remove()"></div>
                    <div class="bg-white rounded-2xl p-6 w-full max-w-md relative z-10">
                        <h2 class="text-xl font-bold mb-4">${isEdit?'Edit':'Add'} Staff</h2>
                        <form onsubmit="window.handleSaveStaff(event, '${isEdit?'edit':'add'}', '${phone||''}')" class="space-y-3">
                            <input id="staff-name" placeholder="Name" class="w-full p-3 border rounded-xl" required>
                            <input id="staff-phone" placeholder="Phone" value="${phone||''}" ${isEdit?'disabled':''} class="w-full p-3 border rounded-xl" required>
                            <input id="staff-pass" placeholder="Password" class="w-full p-3 border rounded-xl" required>
                            
                            <div class="grid grid-cols-2 gap-2 bg-slate-50 p-3 rounded-xl">
                                <input id="price-dress-buy" value="${userToEdit.prices?.dressBuy || DEFAULT_BUY_PRICE}" placeholder="Dress Buy" class="p-2 border rounded" type="number" required>
                                <input id="price-dress-sell" value="${userToEdit.prices?.dressSell || DEFAULT_SELL_PRICE}" placeholder="Dress Sell" class="p-2 border rounded" type="number" required>
                                <input id="price-2pc-buy" value="${userToEdit.prices?.twoPcBuy || DEFAULT_BUY_PRICE}" placeholder="2pc Buy" class="p-2 border rounded" type="number" required>
                                <input id="price-2pc-sell" value="${userToEdit.prices?.twoPcSell || DEFAULT_SELL_PRICE}" placeholder="2pc Sell" class="p-2 border rounded" type="number" required>
                            </div>
                            
                            <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold">Save</button>
                        </form>
                    </div>
                </div>`;
        };
        
        window.manageUser = async function(phone) {
             const docRef = getDocRef('users', phone);
             const snap = await getDoc(docRef);
             if(snap.exists()) {
                 managedUser = snap.data();
                 await fetchUserData(phone);
                 renderIndividualDashboard();
             } else {
                 showNotification("User data not found for management.", 'error');
             }
        };

    </script>
</body>
</html>
