<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinah Designs Admin Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- Load Lucide Icons -->
    <script src="[https://unpkg.com/lucide@latest](https://unpkg.com/lucide@latest)"></script>
    <!-- Load jsPDF for Reports -->
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js](https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js)"></script>
    <!-- Load jsPDF AutoTable for easier tables -->
    <script src="[https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js](https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js)"></script>
    
    <style>
        @import url('[https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap)');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.7);
        }
        /* PDF loader styles */
        #pdf-loader { position: fixed; inset: 0; z-index: 60; display: flex; align-items: center; justify-content: center; }
        .pdf-loader-backdrop { position: absolute; inset: 0; background: rgba(15,23,42,0.6); }
        .pdf-loader-box {
            position: relative; z-index: 61; width: 320px; padding: 18px 20px;
            border-radius: 12px; background: #ffffff;
            box-shadow: 0 10px 30px rgba(2,6,23,0.5);
            display: flex; gap: 12px; align-items: center;
        }
        .pdf-spinner {
            width: 38px; height: 38px; border-radius: 50%;
            border: 4px solid #e6edf8; border-top-color: #1E3A8A;
            animation: pdfspin 1s linear infinite;
        }
        @keyframes pdfspin { to { transform: rotate(360deg); } }
        .pdf-loader-text { font-weight:600; font-size:14px; color: #0f172a; }
        
        /* Mobile Menu Transitions */
        #mobile-menu { transition: transform 0.3s ease-in-out; }
        .translate-x-full { transform: translateX(100%); }
        .translate-x-0 { transform: translateX(0); }
    </style>
</head>
<body class="min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="min-h-screen"></div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 transition-all duration-300 transform opacity-0 -translate-y-full" style="display: none;"></div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- PDF Loader -->
    <div id="pdf-loader" style="display:none;">
        <div class="pdf-loader-backdrop"></div>
        <div class="pdf-loader-box">
            <div class="pdf-spinner"></div>
            <div class="pdf-loader-text">Generating report â€” please wait...</div>
        </div>
    </div>

    <script>
        // --- Configuration & Constants ---
        // DEPRECATED CONSTANTS (Used as fallbacks for old users)
        const DEFAULT_BUY_PRICE = 120;
        const DEFAULT_SELL_PRICE = 200;

        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        const REPORT_TYPES = ["Daily", "Weekly", "Monthly", "Quarterly", "Yearly"];
        
        // SECURITY CONFIGURATION
        const SYSTEM_PIN = "2580"; 

        // Local Storage Keys
        const DB_KEY = "trinah_users_db";
        const SESSION_KEY = "trinah_active_session";
        const PROCUREMENT_KEY = "trinah_procurement_log";
        const CONTROLLER_KEY = "trinah_stock_controller_log"; 
        
        // --- PRESSURE CALCULATOR KEYS ---
        const PRESSURE_STAFF_KEY = "trinah_pressure_staff_list";
        const PRESSURE_LOG_PREFIX = "trinah_pressure_log_";

        // View States
        const VIEW_DASHBOARD = 'dashboard';
        const VIEW_USERS = 'users';
        const VIEW_PRESSURE = 'pressure'; // New View

        // Global State Variables
        let currentUser = null; 
        let managedUser = null; 
        let currentView = VIEW_DASHBOARD;
        
        // Pressure Calc State
        let currentPressureStaff = null; // Name of staff currently being calculated

        // Data for managed user
        let history = []; 
        let archive = []; 
        // startingPressure updated to include kimonos
        let startingPressure = { dresses: 0, twoPcs: 0, kimonos: 0 }; 
        
        let selectedDayIndex = 0;
        let selectedReport = "Daily"; 
        
        // Admin Overview Date State
        let selectedProcurementDate = new Date(); // Default to today

        // Auth State
        let authError = "";
        let authLoading = false;
        let showAdminCreation = false;

        const appElement = document.getElementById('app');
        const notificationContainer = document.getElementById('notification-container');
        const modalContainer = document.getElementById('modal-container');

        // --- Utility Functions ---

        function renderIcon(name, attributes = {}) {
            if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') {
                const icons = lucide.createIcons();
                if (icons && icons[name]) {
                    return icons[name].toSvg(attributes);
                }
            }
            return `<i data-lucide="${name}" class="${attributes.class || ''}"></i>`;
        }

        function refreshIcons() {
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }

        function saveData(phone) {
            if (!phone) return;
            localStorage.setItem(`trinah_current_week_${phone}`, JSON.stringify(history));
            localStorage.setItem(`trinah_archive_${phone}`, JSON.stringify(archive));
            localStorage.setItem(`trinah_starting_pressure_${phone}`, JSON.stringify(startingPressure));
        }

        function loadData(user) {
            if (!user) return;
            const phone = user.phone;
            const savedHistory = localStorage.getItem(`trinah_current_week_${phone}`);
            if (savedHistory) history = JSON.parse(savedHistory);
            else history = [];
            
            const savedArchive = localStorage.getItem(`trinah_archive_${phone}`);
            if (savedArchive) archive = JSON.parse(savedArchive);
            else archive = [];
            
            const savedPressure = localStorage.getItem(`trinah_starting_pressure_${phone}`);
            if (savedPressure) {
                try {
                    const parsed = JSON.parse(savedPressure);
                    // Handle migration and defaults
                    if (typeof parsed === 'number') {
                        startingPressure = { dresses: parsed, twoPcs: 0, kimonos: 0 };
                    } else {
                        startingPressure = {
                            dresses: parsed.dresses || 0,
                            twoPcs: parsed.twoPcs || 0,
                            kimonos: parsed.kimonos || 0
                        };
                    }
                } catch (e) {
                    startingPressure = { dresses: 0, twoPcs: 0, kimonos: 0 };
                }
            } else {
                startingPressure = { dresses: 0, twoPcs: 0, kimonos: 0 };
            }

            // Recalculate from last archive entry if exists and history is empty
            if (history.length === 0 && archive.length > 0) {
                const last = archive[archive.length - 1];
                startingPressure = {
                    dresses: last.remDresses || last.remaining || 0, 
                    twoPcs: last.remTwoPcs || 0,
                    kimonos: last.remKimonos || 0
                };
            }

            // Set default day to today
            const jsDay = new Date().getDay();
            const mappedDay = jsDay === 0 ? 6 : jsDay - 1;
            selectedDayIndex = mappedDay;
        }

        function showNotification(msg) {
            notificationContainer.innerHTML = `
                <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-medium flex items-center gap-2">
                    ${msg.includes("Locked") ? renderIcon('lock', { class: 'w-4 h-4' }) : ''}
                    ${msg}
                </div>`;
            notificationContainer.style.display = 'block';
            
            requestAnimationFrame(() => {
                notificationContainer.classList.remove('opacity-0', '-translate-y-full');
                notificationContainer.classList.add('opacity-100', 'translate-y-5');
                refreshIcons();
            });

            setTimeout(() => {
                notificationContainer.classList.remove('opacity-100', 'translate-y-5');
                notificationContainer.classList.add('opacity-0', '-translate-y-full');
                setTimeout(() => notificationContainer.style.display = 'none', 300);
            }, 3000);
        }

        function formatCurrency(val) {
            return `KES ${val.toLocaleString()}`;
        }

        function getFullHistory() {
            return [...archive, ...history];
        }

        function isEntryLocked(entry) {
            if (!entry) return false;
            // Lock if more than 72 hours have passed since entry creation
            const entryTime = entry.id; // entry.id is Date.now() at creation
            const timeSinceCreation = Date.now() - entryTime;
            const hours72 = 72 * 60 * 60 * 1000;
            
            return timeSinceCreation > hours72;
        }

        function getFilteredHistory() {
            const fullHistory = getFullHistory();
            const now = new Date();
            // Create midnight timestamps for safe comparison
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const todayEnd = todayStart + (24 * 60 * 60 * 1000);

            return fullHistory.filter(entry => {
                let entryTime = entry.id;
                if (!entryTime) {
                    const parsed = new Date(entry.fullDate);
                    if (!isNaN(parsed.getTime())) entryTime = parsed.getTime();
                    else return false;
                }

                switch (selectedReport) {
                    case "Daily": 
                        return entryTime >= todayStart && entryTime < todayEnd;
                    case "Weekly": {
                        const oneWeekAgo = todayStart - (6 * 24 * 60 * 60 * 1000);
                        return entryTime >= oneWeekAgo;
                    }
                    case "Monthly": {
                        const thirtyDaysAgo = todayStart - (30 * 24 * 60 * 60 * 1000);
                        return entryTime >= thirtyDaysAgo;
                    }
                    case "Quarterly": {
                        const ninetyDaysAgo = todayStart - (90 * 24 * 60 * 60 * 1000);
                        return entryTime >= ninetyDaysAgo;
                    }
                    case "Yearly": {
                        const oneYearAgo = todayStart - (365 * 24 * 60 * 60 * 1000);
                        return entryTime >= oneYearAgo;
                    }
                    default: return true;
                }
            });
        }

        // --- Expense Management Functions ---
        function addExpenseRow() {
            const container = document.getElementById('expenses-container');
            const rowId = 'exp-row-' + Date.now();
            const div = document.createElement('div');
            div.id = rowId;
            div.className = 'grid grid-cols-5 gap-2 items-center';
            div.innerHTML = `
                <div class="col-span-3">
                    <input type="text" name="expense_name[]" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Expense Name">
                </div>
                <div class="col-span-1">
                    <input type="number" name="expense_amt[]" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Amt">
                </div>
                <div class="col-span-1 text-center">
                    <button type="button" onclick="document.getElementById('${rowId}').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                        ${renderIcon('trash-2', {class:'w-4 h-4'})}
                    </button>
                </div>
            `;
            container.appendChild(div);
            refreshIcons();
        }

        // --- Pressure Expense Management ---
        function addPressureExpenseRow() {
            const container = document.getElementById('pressure-expenses-container');
            const rowId = 'p-exp-row-' + Date.now();
            const div = document.createElement('div');
            div.id = rowId;
            div.className = 'grid grid-cols-5 gap-2 items-center mb-2';
            div.innerHTML = `
                <div class="col-span-3">
                    <input type="text" name="pressure_exp_name[]" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Name">
                </div>
                <div class="col-span-1">
                    <input type="number" name="pressure_exp_amt[]" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Amt">
                </div>
                <div class="col-span-1 text-center">
                    <button type="button" onclick="document.getElementById('${rowId}').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                        ${renderIcon('trash-2', {class:'w-4 h-4'})}
                    </button>
                </div>
            `;
            container.appendChild(div);
            refreshIcons();
        }

        // --- Master Report Logic ---
        async function downloadMasterReport(type = 'Daily', customDateStr = null) {
            const loader = document.getElementById('pdf-loader');
            if (loader) loader.style.display = 'flex';
            
            await new Promise(r => setTimeout(r, 800));

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const allUsers = JSON.parse(localStorage.getItem(DB_KEY) || "[]").filter(u => u.role !== 'admin');
                
                let targetDateLocale = new Date().toLocaleDateString();
                let reportDateTitle = new Date().toDateString();

                if (customDateStr && type === 'Daily') {
                    const [y, m, d] = customDateStr.split('-').map(Number);
                    const dateObj = new Date(y, m - 1, d);
                    targetDateLocale = dateObj.toLocaleDateString();
                    reportDateTitle = dateObj.toDateString();
                }

                let reportRows = [];
                let grandTotalSoldDresses = 0;
                let grandTotalSoldTwoPcs = 0;
                let grandTotalSoldKimonos = 0;
                let grandTotalProfit = 0;
                let grandTotalDispatchedDresses = 0;
                let grandTotalDispatchedKimonos = 0;

                allUsers.forEach(user => {
                    const userHistoryStr = localStorage.getItem(`trinah_current_week_${user.phone}`) || "[]";
                    const userArchiveStr = localStorage.getItem(`trinah_archive_${user.phone}`) || "[]";
                    const userPressureStr = localStorage.getItem(`trinah_starting_pressure_${user.phone}`);
                    
                    const userHistory = JSON.parse(userHistoryStr);
                    const userArchive = JSON.parse(userArchiveStr);
                    const allEntries = [...userArchive, ...userHistory];
                    
                    let filteredEntries = [];
                    if (type === 'Daily') {
                        filteredEntries = allEntries.filter(e => e.fullDate === targetDateLocale);
                    } else {
                        filteredEntries = allEntries;
                    }

                    const soldDresses = filteredEntries.reduce((acc, curr) => acc + (Number(curr.soldDresses)||0), 0);
                    const soldTwoPcs = filteredEntries.reduce((acc, curr) => acc + (Number(curr.soldTwoPcs)||0), 0);
                    const soldKimonos = filteredEntries.reduce((acc, curr) => acc + (Number(curr.soldKimonos)||0), 0);
                    const soldLegacy = filteredEntries.reduce((acc, curr) => acc + (curr.soldDresses ? 0 : (Number(curr.sold)||0)), 0); 
                    
                    const dispatchedDresses = filteredEntries.reduce((acc, curr) => acc + (Number(curr.dispatchedDresses)||0), 0);
                    const dispatchedTwoPcs = filteredEntries.reduce((acc, curr) => acc + (Number(curr.dispatchedTwoPcs)||0), 0);
                    const dispatchedKimonos = filteredEntries.reduce((acc, curr) => acc + (Number(curr.dispatchedKimonos)||0), 0);
                    const dispatchedLegacy = filteredEntries.reduce((acc, curr) => acc + (curr.dispatchedDresses ? 0 : (Number(curr.dispatched)||0)), 0);
                    
                    // Grouping
                    const userTotalDispatchedDresses = dispatchedDresses + dispatchedTwoPcs + dispatchedLegacy;
                    const userTotalDispatchedKimonos = dispatchedKimonos;

                    const totalSoldDresses = soldDresses + soldLegacy;
                    const totalProfit = filteredEntries.reduce((acc, curr) => acc + (Number(curr.profit)||0), 0);
                    
                    const totalSold = totalSoldDresses + soldTwoPcs + soldKimonos;
                    const userTotalDispatched = userTotalDispatchedDresses + userTotalDispatchedKimonos;

                    if (type === 'Daily') {
                        if (userTotalDispatched === 0 && totalSold === 0) {
                            return; 
                        }
                    }

                    grandTotalDispatchedDresses += userTotalDispatchedDresses;
                    grandTotalDispatchedKimonos += userTotalDispatchedKimonos;

                    grandTotalSoldDresses += totalSoldDresses;
                    grandTotalSoldTwoPcs += soldTwoPcs;
                    grandTotalSoldKimonos += soldKimonos;
                    grandTotalProfit += totalProfit;

                    let currentRemDresses = 0;
                    let currentRemTwoPcs = 0;
                    let currentRemKimonos = 0;

                    if (allEntries.length > 0) {
                        const last = allEntries[allEntries.length - 1];
                        currentRemDresses = last.remDresses || last.remaining || 0;
                        currentRemTwoPcs = last.remTwoPcs || 0;
                        currentRemKimonos = last.remKimonos || 0;
                    } else {
                         try {
                            const p = JSON.parse(userPressureStr);
                            if (typeof p === 'number') currentRemDresses = p;
                            else { 
                                currentRemDresses = p?.dresses || 0; 
                                currentRemTwoPcs = p?.twoPcs || 0;
                                currentRemKimonos = p?.kimonos || 0;
                            }
                        } catch(e) {}
                    }
                    
                    let stockDisplay = `${currentRemDresses} / ${currentRemTwoPcs} / ${currentRemKimonos}`;
                    if (user.enableReconciliation) {
                        stockDisplay = `${currentRemDresses} / ${currentRemKimonos}`;
                    }

                    reportRows.push([
                        user.name,
                        String(totalSoldDresses),
                        String(soldTwoPcs),
                        String(soldKimonos),
                        stockDisplay,
                        formatCurrency(totalProfit)
                    ]);
                });

                doc.setFillColor(30, 58, 138); 
                doc.rect(0, 0, 210, 45, 'F'); 

                doc.setTextColor(255, 255, 255);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(22);
                doc.text("TRINAH DESIGNS", 105, 20, { align: "center" });
                
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                const titleText = type === 'Daily' ? "DAILY SALES & STOCK REPORT" : `MASTER ${type.toUpperCase()} REPORT`;
                doc.text(titleText, 105, 30, { align: "center" });

                doc.setFontSize(10);
                doc.setTextColor(203, 213, 225); 
                doc.text(`Period: ${reportDateTitle}`, 105, 38, { align: "center" });

                doc.autoTable({
                    startY: 55,
                    head: [['Staff Member', 'Sold Premium', 'Sold CleanUp', 'Sold Kimono', 'Stock', 'Profit (KES)']],
                    body: reportRows,
                    foot: [['TOTALS', String(grandTotalSoldDresses), String(grandTotalSoldTwoPcs), String(grandTotalSoldKimonos), '-', formatCurrency(grandTotalProfit)]],
                    theme: 'striped',
                    headStyles: { 
                        fillColor: [30, 58, 138], 
                        textColor: 255, 
                        fontStyle: 'bold', 
                        halign: 'center',
                        cellPadding: 3
                    },
                    bodyStyles: { 
                        textColor: 50, 
                        halign: 'center',
                        cellPadding: 3 
                    },
                    columnStyles: { 
                        0: { halign: 'left', fontStyle: 'bold' },
                        5: { fontStyle: 'bold', halign: 'right' }
                    },
                    footStyles: { 
                        fillColor: [241, 245, 249], 
                        textColor: [15, 23, 42], 
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    margin: { top: 55 }
                });

                if (type === 'Daily') {
                    const logs = JSON.parse(localStorage.getItem(PROCUREMENT_KEY) || "{}");
                    let procurementData = logs[targetDateLocale] || 0;
                    
                    let procDresses = 0;
                    let procKimonos = 0;

                    if (typeof procurementData === 'number') {
                        procDresses = procurementData;
                    } else {
                        procDresses = procurementData.dresses || 0;
                        procKimonos = procurementData.kimonos || 0;
                    }
                    
                    // Simple Variance calculation for PDF (Simplified view)
                    const varianceD = procDresses - grandTotalDispatchedDresses;
                    const varianceK = procKimonos - grandTotalDispatchedKimonos;
                    
                    const finalY = doc.lastAutoTable.finalY + 15;
                    
                    doc.setDrawColor(226, 232, 240);
                    doc.setFillColor(248, 250, 252);
                    doc.rect(14, finalY, 182, 50, 'FD');

                    doc.setFillColor(30, 58, 138);
                    doc.rect(14, finalY, 182, 10, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "bold");
                    doc.text("PROCUREMENT VS DISPATCHED ANALYSIS", 20, finalY + 7);

                    doc.setTextColor(51, 65, 85);
                    doc.setFont("helvetica", "normal");
                    
                    // Dresses Line
                    doc.text("Dresses/Suits:", 20, finalY + 20);
                    doc.text(`Acquired: ${procDresses}`, 60, finalY + 20);
                    doc.text(`Dispatched: ${grandTotalDispatchedDresses}`, 100, finalY + 20);
                    
                    let vColorD = [22, 163, 74];
                    let vTextD = "Balanced";
                    if (varianceD > 0) { vColorD = [220, 38, 38]; vTextD = `Missing: ${varianceD}`; }
                    else if (varianceD < 0) { vColorD = [217, 119, 6]; vTextD = `Extra: ${Math.abs(varianceD)}`; }
                    
                    doc.setTextColor(vColorD[0], vColorD[1], vColorD[2]);
                    doc.setFont("helvetica", "bold");
                    doc.text(vTextD, 180, finalY + 20, {align:'right'});

                    // Kimonos Line
                    doc.setTextColor(51, 65, 85);
                    doc.setFont("helvetica", "normal");
                    doc.text("Kimonos:", 20, finalY + 30);
                    doc.text(`Acquired: ${procKimonos}`, 60, finalY + 30);
                    doc.text(`Dispatched: ${grandTotalDispatchedKimonos}`, 100, finalY + 30);
                    
                    let vColorK = [22, 163, 74];
                    let vTextK = "Balanced";
                    if (varianceK > 0) { vColorK = [220, 38, 38]; vTextK = `Missing: ${varianceK}`; }
                    else if (varianceK < 0) { vColorK = [217, 119, 6]; vTextK = `Extra: ${Math.abs(varianceK)}`; }
                    
                    doc.setTextColor(vColorK[0], vColorK[1], vColorK[2]);
                    doc.setFont("helvetica", "bold");
                    doc.text(vTextK, 180, finalY + 30, {align:'right'});
                }

                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    doc.text(`Generated by Trinah Designs Admin System - ${new Date().toLocaleString()}`, 105, 290, { align: "center" });
                }

                const fileDate = type === 'Daily' ? `_${targetDateLocale.replace(/\//g, '-')}` : '';
                doc.save(`Trinah_${type}_Report${fileDate}.pdf`);
                
                showNotification("Report Downloaded Successfully");

            } catch (e) {
                console.error(e);
                showNotification("Error generating report.");
            } finally {
                if (loader) loader.style.display = 'none';
            }
        }


        // --- Navigation ---

        function setView(view) {
            currentView = view;
            if (view === VIEW_DASHBOARD && currentUser.role === 'admin') {
                managedUser = null; 
            }
            if (view !== VIEW_PRESSURE) {
                currentPressureStaff = null;
            }
            renderApp();
        }

        function manageUser(userPhone) {
            const users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            const target = users.find(u => u.phone === userPhone);
            if (target) {
                managedUser = target;
                loadData(target);
                renderApp(); 
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const overlay = document.getElementById('mobile-menu-overlay');
            if (menu && overlay) {
                const isClosed = menu.classList.contains('translate-x-full');
                if (isClosed) {
                    menu.classList.remove('translate-x-full');
                    menu.classList.add('translate-x-0');
                    overlay.classList.remove('hidden');
                } else {
                    menu.classList.add('translate-x-full');
                    menu.classList.remove('translate-x-0');
                    overlay.classList.add('hidden');
                }
            }
        }

        // --- Auth & User Management ---

        function handleLogin(user) {
            authError = "";
            authLoading = false;
            currentUser = user;
            
            if (!currentUser.role) {
                const users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
                if (users.length > 0 && users[0].phone === currentUser.phone) {
                    currentUser.role = 'admin';
                    users[0].role = 'admin';
                    localStorage.setItem(DB_KEY, JSON.stringify(users));
                } else {
                    currentUser.role = 'staff';
                }
            }

            localStorage.setItem(SESSION_KEY, JSON.stringify(user));

            if (currentUser.role === 'admin') {
                managedUser = null; 
                selectedProcurementDate = new Date();
            } else {
                managedUser = currentUser; 
                loadData(currentUser);
            }
            
            setView(VIEW_DASHBOARD);
        }

        function handleLogout() {
            if (managedUser) saveData(managedUser.phone);
            currentUser = null;
            managedUser = null;
            localStorage.removeItem(SESSION_KEY);
            history = [];
            archive = [];
            startingPressure = { dresses: 0, twoPcs: 0, kimonos: 0 };
            renderApp();
        }

        function handleSwitchUser(user) {
            if (managedUser) saveData(managedUser.phone);
            handleLogin(user);
        }

        // --- Admin Functions ---

        function showAddStaffModal(isEdit = false, userPhone = null) {
            let userToEdit = null;
            if (isEdit && userPhone) {
                const users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
                userToEdit = users.find(u => u.phone === userPhone);
            }

            const nameVal = userToEdit ? userToEdit.name : '';
            const phoneVal = userToEdit ? userToEdit.phone : '';
            const passVal = userToEdit ? userToEdit.password : '';
            const isReconcileEnabled = userToEdit && userToEdit.enableReconciliation ? 'checked' : '';

            const prices = userToEdit ? (userToEdit.prices || {}) : {};
            
            const dbVal = prices.dressBuy || '';
            const dsVal = prices.dressSell || '';
            const tbVal = prices.twoPcBuy || '';
            const tsVal = prices.twoPcSell || '';
            const kbVal = prices.kimonoBuy || '';
            const ksVal = prices.kimonoSell || '';

            const modalHTML = `
                <div id="add-staff-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg z-10 p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold text-slate-800">${isEdit ? 'Edit Staff Member' : 'Add New Staff Member'}</h3>
                            <button onclick="closeModal('add-staff-modal')" class="text-slate-500 hover:text-slate-700 p-1 rounded-full">
                                ${renderIcon('x', { class: 'w-6 h-6' })}
                            </button>
                        </div>
                        
                        <form id="add-staff-form" onsubmit="event.preventDefault(); handleSaveStaff(this, ${isEdit})">
                            <input type="hidden" name="original_phone" value="${phoneVal}">
                            
                            <!-- User Details Section -->
                            <div class="mb-6 border-b border-slate-200 pb-4">
                                <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                    ${renderIcon('user', { class: 'w-4 h-4 text-indigo-600' })} User Credentials
                                </h4>
                                <div class="space-y-4">
                                    <div>
                                        <label for="staff-name" class="block text-sm font-medium text-slate-700">Name</label>
                                        <input type="text" id="staff-name" name="name" value="${nameVal}" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label for="staff-phone" class="block text-sm font-medium text-slate-700">Phone (Login ID)</label>
                                        <input type="text" id="staff-phone" name="phone" value="${phoneVal}" required ${isEdit ? '' : ''} class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 ${isEdit ? 'bg-slate-50' : ''}" placeholder="e.g., 2547XXXXXXXX">
                                    </div>
                                    <div>
                                        <label for="staff-password" class="block text-sm font-medium text-slate-700">Password</label>
                                        <input type="text" id="staff-password" name="password" value="${passVal}" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div class="flex items-center pt-2">
                                        <input id="enable-reconciliation" name="enableReconciliation" type="checkbox" ${isReconcileEnabled} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <label for="enable-reconciliation" class="ml-2 block text-sm text-slate-900 select-none">
                                            Enable Stock Reconciliation (Track only Premium/Kimonos)
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Pricing Section -->
                            <div class="mb-8">
                                <h4 class="font-semibold text-slate-700 mb-4 flex items-center gap-2">
                                    ${renderIcon('dollar-sign', { class: 'w-4 h-4 text-green-600' })} Default Pricing (Optional)
                                </h4>
                                <p class="text-xs text-slate-500 mb-3">Set user-specific buy and sell prices for profit calculation. Defaults will be used if left empty.</p>
                                
                                <div class="space-y-4">
                                    
                                    <!-- Dresses/Suits (Premium) -->
                                    <div class="grid grid-cols-3 gap-3 items-center">
                                        <label class="text-sm font-medium text-slate-700">Premium/Dresses</label>
                                        <input type="number" name="dressBuy" value="${dbVal}" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Buy Price">
                                        <input type="number" name="dressSell" value="${dsVal}" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Sell Price">
                                    </div>

                                    <!-- Two-Piece (CleanUp) -->
                                    <div class="grid grid-cols-3 gap-3 items-center">
                                        <label class="text-sm font-medium text-slate-700">CleanUp/Two-Pcs</label>
                                        <input type="number" name="twoPcBuy" value="${tbVal}" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Buy Price">
                                        <input type="number" name="twoPcSell" value="${tsVal}" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Sell Price">
                                    </div>

                                    <!-- Kimonos -->
                                    <div class="grid grid-cols-3 gap-3 items-center">
                                        <label class="text-sm font-medium text-slate-700">Kimonos</label>
                                        <input type="number" name="kimonoBuy" value="${kbVal}" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Buy Price">
                                        <input type="number" name="kimonoSell" value="${ksVal}" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Sell Price">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="closeModal('add-staff-modal')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition duration-150">
                                    Cancel
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150">
                                    ${isEdit ? 'Save Changes' : 'Add Staff'}
                                </button>
                            </div>

                            ${isEdit ? `
                                <button type="button" onclick="showConfirmationModal('Are you sure you want to delete ${nameVal}? This action cannot be undone and will remove all their data.', () => handleDeleteStaff('${phoneVal}'))" class="mt-4 w-full px-4 py-2 text-sm font-medium text-red-600 bg-red-100 hover:bg-red-200 rounded-lg transition duration-150 flex items-center justify-center gap-2">
                                    ${renderIcon('trash-2', { class: 'w-4 h-4' })} Delete Staff Member
                                </button>
                            ` : ''}
                        </form>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            refreshIcons();
        }

        function showConfirmationModal(message, callback) {
            const modalHTML = `
                <div id="confirmation-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm z-10 p-6">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Confirmation Required</h3>
                        <p class="text-sm text-slate-600 mb-6">${message}</p>
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeModal('confirmation-modal')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition duration-150">
                                Cancel
                            </button>
                            <button type="button" id="confirm-action-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-md transition duration-150">
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            
            const confirmButton = document.getElementById('confirm-action-btn');
            confirmButton.onclick = () => {
                closeModal('confirmation-modal');
                callback();
            };
            refreshIcons();
        }


        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
                // Ensure only one modal is removed at a time
                const anyModal = modalContainer.querySelector('.fixed');
                if (!anyModal) {
                    modalContainer.innerHTML = '';
                }
            }
        }

        function handleSaveStaff(form, isEdit) {
            const formData = new FormData(form);
            const name = formData.get('name').trim();
            const phone = formData.get('phone').trim();
            const password = formData.get('password').trim();
            const originalPhone = formData.get('original_phone');
            const enableReconciliation = formData.get('enableReconciliation') === 'on';

            const prices = {
                dressBuy: Number(formData.get('dressBuy')) || 0,
                dressSell: Number(formData.get('dressSell')) || 0,
                twoPcBuy: Number(formData.get('twoPcBuy')) || 0,
                twoPcSell: Number(formData.get('twoPcSell')) || 0,
                kimonoBuy: Number(formData.get('kimonoBuy')) || 0,
                kimonoSell: Number(formData.get('kimonoSell')) || 0,
            };

            if (!name || !phone || !password) {
                return showNotification("All fields are required.");
            }
            if (phone.length < 5) {
                return showNotification("Phone number seems too short.");
            }

            let users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");

            if (isEdit) {
                const index = users.findIndex(u => u.phone === originalPhone);
                if (index !== -1) {
                    // Update user details
                    users[index] = { 
                        ...users[index], 
                        name, 
                        phone, 
                        password, 
                        prices, 
                        enableReconciliation 
                    };

                    // If phone changed, migrate data
                    if (originalPhone !== phone) {
                        // Migrate sales data (history, archive, pressure)
                        const historyData = localStorage.getItem(`trinah_current_week_${originalPhone}`);
                        const archiveData = localStorage.getItem(`trinah_archive_${originalPhone}`);
                        const pressureData = localStorage.getItem(`trinah_starting_pressure_${originalPhone}`);

                        if (historyData) {
                            localStorage.setItem(`trinah_current_week_${phone}`, historyData);
                            localStorage.removeItem(`trinah_current_week_${originalPhone}`);
                        }
                        if (archiveData) {
                            localStorage.setItem(`trinah_archive_${phone}`, archiveData);
                            localStorage.removeItem(`trinah_archive_${originalPhone}`);
                        }
                        if (pressureData) {
                            localStorage.setItem(`trinah_starting_pressure_${phone}`, pressureData);
                            localStorage.removeItem(`trinah_starting_pressure_${originalPhone}`);
                        }
                        showNotification(`Staff and data migrated from ${originalPhone} to ${phone}`);
                    }
                    showNotification(`Staff member ${name} updated successfully.`);
                }
            } else {
                if (users.some(u => u.phone === phone)) {
                    return showNotification("Error: Staff member with this phone number already exists.");
                }
                const newUser = { name, phone, password, role: 'staff', prices, enableReconciliation };
                users.push(newUser);
                showNotification(`Staff member ${name} added successfully.`);
            }

            localStorage.setItem(DB_KEY, JSON.stringify(users));
            closeModal('add-staff-modal');
            renderApp();
        }
        
        function handleDeleteStaff(phone) {
            let users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            const initialLength = users.length;
            
            users = users.filter(u => u.phone !== phone);

            if (users.length < initialLength) {
                localStorage.setItem(DB_KEY, JSON.stringify(users));
                
                // Clear all related local storage data
                localStorage.removeItem(`trinah_current_week_${phone}`);
                localStorage.removeItem(`trinah_archive_${phone}`);
                localStorage.removeItem(`trinah_starting_pressure_${phone}`);

                // If the user being deleted is the one currently managed, reset managedUser
                if (managedUser && managedUser.phone === phone) {
                    managedUser = null;
                    if (currentUser.role === 'admin') {
                        setView(VIEW_DASHBOARD);
                    } else {
                        // This should ideally log the user out if they delete themselves, but for admin view, just reset the target
                    }
                }
                showNotification("Staff member and all their data deleted.");
            } else {
                showNotification("Error: Staff member not found.");
            }
            renderApp();
        }

        // --- Procurement/Stock Control Functions ---

        function showProcurementModal() {
            const currentDate = selectedProcurementDate.toLocaleDateString();
            const logs = JSON.parse(localStorage.getItem(PROCUREMENT_KEY) || "{}");
            let procurementData = logs[currentDate] || {dresses: 0, kimonos: 0};
            
            // Handle legacy format (just a number)
            if (typeof procurementData === 'number') {
                 procurementData = { dresses: procurementData, kimonos: 0 };
            }

            const modalHTML = `
                <div id="procurement-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md z-10 p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                ${renderIcon('box', { class: 'w-6 h-6 text-indigo-600' })} Daily Stock Procurement
                            </h3>
                            <button onclick="closeModal('procurement-modal')" class="text-slate-500 hover:text-slate-700 p-1 rounded-full">
                                ${renderIcon('x', { class: 'w-6 h-6' })}
                            </button>
                        </div>
                        
                        <p class="text-sm text-slate-500 mb-4">
                            Enter the number of dresses/suits (Premium) and kimonos acquired and dispatched to staff on 
                            <span class="font-semibold text-indigo-600">${currentDate}</span>.
                        </p>

                        <form id="procurement-form" onsubmit="event.preventDefault(); handleProcurementSave(this)">
                            
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="procurement-dresses" class="block text-sm font-medium text-slate-700">Dresses / Suits (Premium)</label>
                                    <input type="number" id="procurement-dresses" name="dresses" value="${procurementData.dresses || ''}" min="0" class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Number of dresses/suits acquired">
                                </div>
                                <div>
                                    <label for="procurement-kimonos" class="block text-sm font-medium text-slate-700">Kimonos</label>
                                    <input type="number" id="procurement-kimonos" name="kimonos" value="${procurementData.kimonos || ''}" min="0" class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Number of kimonos acquired">
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center gap-3">
                                <button type="button" onclick="handleDeleteProcurement('${currentDate}')" class="px-4 py-2 text-sm font-medium text-red-600 bg-red-100 hover:bg-red-200 rounded-lg transition duration-150">
                                    ${renderIcon('trash-2', { class: 'w-4 h-4 inline-block mr-1' })} Clear Day
                                </button>
                                <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150">
                                    Save Procurement
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            refreshIcons();
        }

        function handleProcurementSave(form) {
            const formData = new FormData(form);
            const dresses = Number(formData.get('dresses')) || 0;
            const kimonos = Number(formData.get('kimonos')) || 0;
            const currentDate = selectedProcurementDate.toLocaleDateString();

            if (dresses < 0 || kimonos < 0) {
                 return showNotification("Stock numbers cannot be negative.");
            }

            let logs = JSON.parse(localStorage.getItem(PROCUREMENT_KEY) || "{}");
            
            logs[currentDate] = { dresses, kimonos };

            localStorage.setItem(PROCUREMENT_KEY, JSON.stringify(logs));
            showNotification(`Stock procurement for ${currentDate} saved.`);
            closeModal('procurement-modal');
            renderAdminDashboard(); 
        }

        function handleDeleteProcurement(date) {
            showConfirmationModal(`Are you sure you want to clear the stock procurement log for ${date}? This action cannot be undone.`, () => {
                let logs = JSON.parse(localStorage.getItem(PROCUREMENT_KEY) || "{}");
                delete logs[date];
                localStorage.setItem(PROCUREMENT_KEY, JSON.stringify(logs));
                showNotification(`Stock procurement for ${date} cleared.`);
                closeModal('procurement-modal');
                renderAdminDashboard(); 
            });
        }
        
        function handleProcurementDateChange(input) {
            const dateStr = input.value;
            if (dateStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                // JS months are 0-indexed
                selectedProcurementDate = new Date(year, month - 1, day); 
                renderAdminDashboard();
            }
        }
        
        // --- Stock Controller Log ---

        function showControllerModal() {
            const currentDate = new Date().toLocaleDateString();
            const logs = JSON.parse(localStorage.getItem(CONTROLLER_KEY) || "{}");
            const todayLogs = logs[currentDate] || [];

            let logItemsHTML = todayLogs.map((log, index) => `
                <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg mb-2">
                    <p class="text-sm text-slate-700">
                        <span class="font-semibold">${log.type === 'In' ? 'IN' : 'OUT'}:</span> ${log.dresses} Dr / ${log.kimonos} Ki 
                        <span class="text-xs text-slate-500 ml-2">(${new Date(log.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })})</span>
                    </p>
                    <button type="button" onclick="handleDeleteControllerLog('${currentDate}', ${index})" class="text-red-500 hover:text-red-700 p-1">
                        ${renderIcon('trash-2', { class: 'w-4 h-4' })}
                    </button>
                </div>
            `).join('');


            const modalHTML = `
                <div id="controller-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md z-10 p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                ${renderIcon('clipboard-list', { class: 'w-6 h-6 text-emerald-600' })} Controller Stock Log
                            </h3>
                            <button onclick="closeModal('controller-modal')" class="text-slate-500 hover:text-slate-700 p-1 rounded-full">
                                ${renderIcon('x', { class: 'w-6 h-6' })}
                            </button>
                        </div>
                        
                        <p class="text-sm text-slate-500 mb-4">
                            Log stock movement (Dresses/Suits and Kimonos) for today, <span class="font-semibold text-emerald-600">${currentDate}</span>.
                        </p>

                        <!-- Log Input Form -->
                        <form id="controller-log-form" onsubmit="event.preventDefault(); handleControllerLogSave(this)" class="p-4 border border-emerald-200 rounded-lg mb-6 bg-emerald-50">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="log-dresses" class="block text-xs font-medium text-slate-700">Dresses / Suits (Premium)</label>
                                    <input type="number" id="log-dresses" name="dresses" value="0" min="0" class="mt-1 w-full p-2 text-sm border border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="log-kimonos" class="block text-xs font-medium text-slate-700">Kimonos</label>
                                    <input type="number" id="log-kimonos" name="kimonos" value="0" min="0" class="mt-1 w-full p-2 text-sm border border-emerald-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="0">
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3">
                                <button type="submit" name="type" value="In" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-md transition duration-150">
                                    ${renderIcon('log-in', { class: 'w-4 h-4 inline-block mr-1' })} Stock In
                                </button>
                                <button type="submit" name="type" value="Out" class="flex-1 px-4 py-2 text-sm font-medium text-emerald-700 bg-emerald-200 hover:bg-emerald-300 rounded-lg shadow-md transition duration-150">
                                    ${renderIcon('log-out', { class: 'w-4 h-4 inline-block mr-1' })} Stock Out
                                </button>
                            </div>
                        </form>
                        
                        <!-- Today's Log History -->
                        <h4 class="font-semibold text-slate-700 mb-2 flex items-center gap-2">
                             Log History for Today (${todayLogs.length})
                        </h4>
                        <div id="controller-log-history" class="max-h-60 overflow-y-auto pr-2">
                            ${logItemsHTML || '<p class="text-sm text-slate-500 p-3 bg-slate-50 rounded-lg">No stock movements logged today.</p>'}
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            refreshIcons();
        }

        function handleControllerLogSave(form) {
            const formData = new FormData(form);
            const dresses = Number(formData.get('dresses')) || 0;
            const kimonos = Number(formData.get('kimonos')) || 0;
            const type = formData.get('type'); 
            const currentDate = new Date().toLocaleDateString();
            const timestamp = Date.now();

            if (dresses <= 0 && kimonos <= 0) {
                 return showNotification("Please enter stock quantity greater than zero.");
            }

            let logs = JSON.parse(localStorage.getItem(CONTROLLER_KEY) || "{}");
            
            if (!logs[currentDate]) {
                logs[currentDate] = [];
            }
            
            const newLogEntry = { dresses, kimonos, type, timestamp };
            logs[currentDate].push(newLogEntry);

            localStorage.setItem(CONTROLLER_KEY, JSON.stringify(logs));
            showNotification(`${dresses} Dr / ${kimonos} Ki logged as Stock ${type}.`);
            
            // Re-render the modal to update history
            showControllerModal(); 
        }

        function handleDeleteControllerLog(date, index) {
             showConfirmationModal(`Are you sure you want to delete this specific log entry?`, () => {
                let logs = JSON.parse(localStorage.getItem(CONTROLLER_KEY) || "{}");
                
                if (logs[date] && logs[date].length > index) {
                    logs[date].splice(index, 1);
                    localStorage.setItem(CONTROLLER_KEY, JSON.stringify(logs));
                    showNotification("Log entry deleted.");
                } else {
                    showNotification("Error: Log entry not found.");
                }
                // Re-render the modal to update history
                showControllerModal();
            });
        }


        // --- Pressure Calculation Functions ---
        function getPressureStaffList() {
            return JSON.parse(localStorage.getItem(PRESSURE_STAFF_KEY) || "[]");
        }

        function savePressureStaffList(list) {
            localStorage.setItem(PRESSURE_STAFF_KEY, JSON.stringify(list));
        }

        function getPressureLogs(staffName) {
            const key = PRESSURE_LOG_PREFIX + staffName.toLowerCase().replace(/\s/g, '_');
            return JSON.parse(localStorage.getItem(key) || "[]");
        }

        function savePressureLogs(staffName, logs) {
            const key = PRESSURE_LOG_PREFIX + staffName.toLowerCase().replace(/\s/g, '_');
            localStorage.setItem(key, JSON.stringify(logs));
        }
        
        function getStaffOptions() {
            return getPressureStaffList().map(name => 
                `<option value="${name}" ${name === currentPressureStaff ? 'selected' : ''}>${name}</option>`
            ).join('');
        }

        function renderPressureCalculator() {
            const staffList = getPressureStaffList();
            
            let contentHTML = '';

            if (staffList.length === 0) {
                contentHTML = `
                    <div class="p-8 bg-white rounded-xl shadow-lg text-center">
                        <p class="text-xl font-semibold text-slate-700 mb-3">No Staff Added</p>
                        <p class="text-slate-500 mb-6">Start by adding staff members to the pressure calculator list.</p>
                        <button onclick="showAddPressureStaffModal()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            ${renderIcon('plus', { class: 'w-5 h-5 inline-block mr-1' })} Add Staff
                        </button>
                    </div>
                `;
            } else if (!currentPressureStaff) {
                contentHTML = `
                    <div class="p-8 bg-white rounded-xl shadow-lg w-full max-w-md mx-auto">
                        <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Pressure Calculator</h2>
                        <p class="text-slate-600 mb-6 text-center">Select a staff member to view and manage their pressure calculation history.</p>
                        <div class="space-y-4">
                            <label for="select-pressure-staff" class="block text-sm font-medium text-slate-700">Select Staff Member</label>
                            <select id="select-pressure-staff" onchange="setCurrentPressureStaff(this.value)" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="">-- Select Staff --</option>
                                ${getStaffOptions()}
                            </select>
                        </div>
                        <div class="mt-6 flex justify-center">
                            <button onclick="showAddPressureStaffModal()" class="text-indigo-600 hover:text-indigo-800 text-sm flex items-center gap-1">
                                ${renderIcon('user-plus', { class: 'w-4 h-4' })} Add/Manage Staff List
                            </button>
                        </div>
                    </div>
                `;
            } else {
                const logs = getPressureLogs(currentPressureStaff);
                
                // Calculate current pressure from all logs
                let totalIncome = 0;
                let totalExpenditure = 0;
                
                logs.forEach(log => {
                    totalIncome += log.currentPressure || 0;
                    totalExpenditure += (log.expenses || []).reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
                    // Add previous pressure, as the currentPressure field represents the *net change* for that day's entry
                    // This logic assumes each log entry's 'currentPressure' is the starting pressure + sales - returns, and we're totaling sales over time.
                    // For pressure calculation, we typically want the latest *net* balance.
                });

                // Simplified net balance approach for pressure. The last entry's balance is the current one.
                const currentBalance = logs.length > 0 ? logs[logs.length - 1].balance : 0;
                const totalExpenses = logs.reduce((sum, log) => sum + (log.expenses || []).reduce((s, e) => s + (Number(e.amount) || 0), 0), 0);
                
                const logEntriesHTML = logs.map((log, index) => {
                    const date = new Date(log.id).toLocaleDateString();
                    const expensesTotal = (log.expenses || []).reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
                    const expenseDetails = (log.expenses || []).map(exp => 
                        `<li class="text-xs text-slate-500 ml-4">${exp.name}: ${formatCurrency(exp.amount)}</li>`
                    ).join('');
                    
                    const isLocked = isEntryLocked(log);

                    return `
                        <div class="p-4 border-b border-slate-200 last:border-b-0 bg-white hover:bg-slate-50 transition duration-150 rounded-lg shadow-sm mb-2">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-slate-800 flex items-center gap-2">
                                        ${date} 
                                        ${isLocked ? `<span class="text-red-500 text-xs font-normal">(${renderIcon('lock', {class:'w-3 h-3 inline'})} Locked)</span>` : ''}
                                    </p>
                                    <p class="text-sm text-slate-600 mt-1">
                                        Starting Balance: <span class="font-medium">${formatCurrency(log.startBalance)}</span>
                                    </p>
                                    <p class="text-sm text-slate-600">
                                        Net Change: <span class="font-medium text-indigo-600">${formatCurrency(log.currentPressure)}</span>
                                    </p>
                                    <p class="text-sm text-slate-600">
                                        Daily Expenses: <span class="font-medium text-red-600">${formatCurrency(expensesTotal)}</span>
                                    </p>
                                    <p class="text-sm text-slate-800 mt-2 font-bold">
                                        NEW BALANCE: <span class="text-xl text-emerald-600">${formatCurrency(log.balance)}</span>
                                    </p>
                                    ${expenseDetails.length > 0 ? `<ul class="mt-2 text-xs border-t pt-2">Expenses: ${expenseDetails}</ul>` : ''}
                                </div>
                                <div class="text-right">
                                    <button onclick="showPressureLogModal('${currentPressureStaff}', ${index})" class="text-indigo-600 hover:text-indigo-800 p-2 rounded-full transition ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}" ${isLocked ? 'disabled' : ''} title="${isLocked ? 'Locked for editing' : 'Edit Entry'}">
                                        ${renderIcon('edit', { class: 'w-4 h-4' })}
                                    </button>
                                    <button onclick="showConfirmationModal('Are you sure you want to delete this log entry?', () => handleDeletePressureLog('${currentPressureStaff}', ${index}))" class="text-red-500 hover:text-red-700 p-2 rounded-full transition ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}" ${isLocked ? 'disabled' : ''} title="${isLocked ? 'Locked for deletion' : 'Delete Entry'}">
                                        ${renderIcon('trash-2', { class: 'w-4 h-4' })}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                contentHTML = `
                    <div class="max-w-4xl mx-auto p-4 sm:p-6 bg-slate-50 rounded-xl shadow-inner">
                        <div class="flex justify-between items-center mb-6 border-b pb-4">
                            <h2 class="text-2xl font-bold text-slate-800">${currentPressureStaff}'s Pressure Log</h2>
                            <button onclick="setView(VIEW_PRESSURE); currentPressureStaff = null;" class="text-indigo-600 hover:text-indigo-800 flex items-center gap-1 text-sm font-medium">
                                ${renderIcon('arrow-left', { class: 'w-4 h-4' })} Back to Staff Select
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-indigo-600 text-white p-4 rounded-xl shadow-lg">
                                <p class="text-sm font-medium opacity-80">Current Balance</p>
                                <p class="text-2xl font-extrabold mt-1">${formatCurrency(currentBalance)}</p>
                            </div>
                            <div class="bg-white text-slate-700 p-4 rounded-xl shadow-lg">
                                <p class="text-sm font-medium">Total Expenses Logged</p>
                                <p class="text-2xl font-extrabold mt-1 text-red-600">${formatCurrency(totalExpenses)}</p>
                            </div>
                            <div class="bg-white text-slate-700 p-4 rounded-xl shadow-lg">
                                <p class="text-sm font-medium">Log Entries</p>
                                <p class="text-2xl font-extrabold mt-1 text-indigo-600">${logs.length}</p>
                            </div>
                        </div>

                        <div class="flex justify-end mb-6">
                            <button onclick="showPressureLogModal('${currentPressureStaff}')" class="px-5 py-2 bg-emerald-600 text-white rounded-lg shadow-md hover:bg-emerald-700 transition flex items-center gap-2">
                                ${renderIcon('plus-circle', { class: 'w-5 h-5' })} Add New Log Entry
                            </button>
                        </div>
                        
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            ${logEntriesHTML || '<div class="text-center p-8 bg-white rounded-xl text-slate-500">No pressure log entries yet.</div>'}
                        </div>

                    </div>
                `;
            }

            return `
                <div class="p-4 sm:p-8">
                    ${contentHTML}
                </div>
            `;
        }
        
        function setCurrentPressureStaff(name) {
            currentPressureStaff = name;
            renderApp();
        }

        function showAddPressureStaffModal() {
            const staffList = getPressureStaffList();
            
            const listHTML = staffList.map(name => `
                <li class="flex justify-between items-center p-2 bg-slate-50 rounded-lg">
                    <span class="text-sm text-slate-700">${name}</span>
                    <button onclick="showConfirmationModal('Are you sure you want to remove ${name} from the list? All their pressure logs will also be permanently deleted!', () => deletePressureStaff('${name}'))" class="text-red-500 hover:text-red-700 p-1">
                        ${renderIcon('trash-2', { class: 'w-4 h-4' })}
                    </button>
                </li>
            `).join('');

            const modalHTML = `
                <div id="pressure-staff-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md z-10 p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                ${renderIcon('users', { class: 'w-6 h-6 text-indigo-600' })} Manage Pressure Staff
                            </h3>
                            <button onclick="closeModal('pressure-staff-modal'); renderApp();" class="text-slate-500 hover:text-slate-700 p-1 rounded-full">
                                ${renderIcon('x', { class: 'w-6 h-6' })}
                            </button>
                        </div>
                        
                        <!-- Add New Staff Form -->
                        <form onsubmit="event.preventDefault(); handleAddPressureStaff(this)" class="mb-6 p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                            <label for="new-staff-name" class="block text-sm font-semibold text-slate-700 mb-2">Add New Staff</label>
                            <div class="flex gap-2">
                                <input type="text" id="new-staff-name" name="staffName" required class="flex-grow p-2 text-sm border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter staff name">
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition">
                                    Add
                                </button>
                            </div>
                        </form>

                        <!-- Current List -->
                        <h4 class="font-semibold text-slate-700 mb-3">Current Staff List (${staffList.length})</h4>
                        <div class="max-h-60 overflow-y-auto space-y-2 pr-2">
                            ${listHTML || '<p class="text-sm text-slate-500 text-center py-4">The list is empty.</p>'}
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            refreshIcons();
        }

        function handleAddPressureStaff(form) {
            const formData = new FormData(form);
            const name = formData.get('staffName').trim();

            if (!name) return showNotification("Please enter a name.");

            let staffList = getPressureStaffList();

            if (staffList.some(n => n.toLowerCase() === name.toLowerCase())) {
                return showNotification("Staff member already exists.");
            }

            staffList.push(name);
            savePressureStaffList(staffList);
            form.reset();
            showNotification(`${name} added to the list.`);
            showAddPressureStaffModal(); // Re-render the modal
        }

        function deletePressureStaff(name) {
            let staffList = getPressureStaffList();
            staffList = staffList.filter(n => n !== name);
            savePressureStaffList(staffList);

            // Delete associated logs
            const key = PRESSURE_LOG_PREFIX + name.toLowerCase().replace(/\s/g, '_');
            localStorage.removeItem(key);

            if (currentPressureStaff === name) {
                currentPressureStaff = null;
            }

            showNotification(`${name} and all associated logs deleted.`);
            showAddPressureStaffModal(); // Re-render modal
            renderApp(); // Re-render main view
        }

        function showPressureLogModal(staffName, logIndex = null) {
            const logs = getPressureLogs(staffName);
            const isEdit = logIndex !== null;
            const logEntry = isEdit ? logs[logIndex] : {};
            
            const now = new Date();
            const todayDate = now.toISOString().split('T')[0];
            
            const dateVal = logEntry.date || todayDate;
            const salesVal = logEntry.sales || '';
            const returnsVal = logEntry.returns || '';

            // Calculate starting balance for a new entry
            let startBalance = 0;
            if (!isEdit && logs.length > 0) {
                startBalance = logs[logs.length - 1].balance;
            } else if (isEdit) {
                startBalance = logEntry.startBalance || 0;
            }

            let expensesHTML = '';
            const initialExpenses = logEntry.expenses || [];
            if (isEdit && initialExpenses.length > 0) {
                expensesHTML = initialExpenses.map((exp, i) => `
                    <div id="p-exp-row-${logEntry.id}-${i}" class="grid grid-cols-5 gap-2 items-center mb-2">
                        <div class="col-span-3">
                            <input type="text" name="pressure_exp_name[]" value="${exp.name || ''}" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Name">
                        </div>
                        <div class="col-span-1">
                            <input type="number" name="pressure_exp_amt[]" value="${exp.amount || ''}" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Amt">
                        </div>
                        <div class="col-span-1 text-center">
                            <button type="button" onclick="document.getElementById('p-exp-row-${logEntry.id}-${i}').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                ${renderIcon('trash-2', {class:'w-4 h-4'})}
                            </button>
                        </div>
                    </div>
                `).join('');
            }


            const modalHTML = `
                <div id="pressure-log-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg z-10 p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                ${renderIcon('target', { class: 'w-6 h-6 text-emerald-600' })} ${isEdit ? 'Edit Log Entry' : 'Add New Pressure Log'}
                            </h3>
                            <button onclick="closeModal('pressure-log-modal')" class="text-slate-500 hover:text-slate-700 p-1 rounded-full">
                                ${renderIcon('x', { class: 'w-6 h-6' })}
                            </button>
                        </div>
                        
                        <p class="text-sm text-slate-500 mb-4">
                            Logging daily pressure for <span class="font-semibold text-emerald-600">${staffName}</span>.
                        </p>

                        <form id="pressure-log-form" onsubmit="event.preventDefault(); handlePressureLogSave(this, '${staffName}', ${logIndex})">
                            <input type="hidden" name="startBalance" value="${startBalance}">

                            <!-- Sales/Returns Section -->
                            <div class="mb-6 p-4 border border-slate-200 rounded-lg">
                                <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                    ${renderIcon('trending-up', { class: 'w-4 h-4 text-emerald-600' })} Daily Activity
                                </h4>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="pressure-date" class="block text-sm font-medium text-slate-700">Date</label>
                                        <input type="date" id="pressure-date" name="date" value="${dateVal}" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                                    </div>
                                    <div>
                                        <label for="start-balance" class="block text-sm font-medium text-slate-700">Starting Balance</label>
                                        <input type="text" id="start-balance" value="${formatCurrency(startBalance)}" disabled class="mt-1 w-full p-3 border border-slate-300 rounded-lg bg-slate-100 text-sm font-semibold">
                                    </div>
                                    <div>
                                        <label for="daily-sales" class="block text-sm font-medium text-slate-700">Daily Sales (KES)</label>
                                        <input type="number" id="daily-sales" name="sales" value="${salesVal}" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="0">
                                    </div>
                                    <div>
                                        <label for="daily-returns" class="block text-sm font-medium text-slate-700">Returns / Deductions (KES)</label>
                                        <input type="number" id="daily-returns" name="returns" value="${returnsVal}" class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="0">
                                    </div>
                                </div>
                            </div>

                            <!-- Expenses Section -->
                            <div class="mb-6 p-4 border border-slate-200 rounded-lg">
                                <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                    ${renderIcon('wallet', { class: 'w-4 h-4 text-red-600' })} Expenses
                                </h4>
                                <div id="pressure-expenses-container" class="space-y-2">
                                    ${expensesHTML}
                                </div>
                                <button type="button" onclick="addPressureExpenseRow()" class="mt-3 w-full px-3 py-2 text-sm text-indigo-600 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition flex items-center justify-center gap-2">
                                    ${renderIcon('plus', { class: 'w-4 h-4' })} Add Expense
                                </button>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex justify-end gap-3">
                                <button type="button" onclick="closeModal('pressure-log-modal')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition duration-150">
                                    Cancel
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg shadow-md transition duration-150">
                                    ${isEdit ? 'Save Changes' : 'Save Log'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            refreshIcons();
        }

        function handlePressureLogSave(form, staffName, logIndex) {
            const formData = new FormData(form);
            const date = formData.get('date');
            const sales = Number(formData.get('sales')) || 0;
            const returns = Number(formData.get('returns')) || 0;
            const startBalance = Number(formData.get('startBalance')) || 0;

            const expenseNames = formData.getAll('pressure_exp_name[]');
            const expenseAmounts = formData.getAll('pressure_exp_amt[]');

            const expenses = expenseNames.map((name, index) => ({
                name: name.trim(),
                amount: Number(expenseAmounts[index]) || 0
            })).filter(exp => exp.name && exp.amount > 0);
            
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);

            if (sales < 0 || returns < 0) {
                 return showNotification("Sales and Returns cannot be negative.");
            }
            if (!date) {
                 return showNotification("Please select a date.");
            }

            let logs = getPressureLogs(staffName);
            const isEdit = logIndex !== null;

            // Calculate the net change and new balance
            const netChange = sales - returns;
            const balanceBeforeExpenses = startBalance + netChange;
            const newBalance = balanceBeforeExpenses - totalExpenses;
            
            const newEntry = {
                id: isEdit ? logs[logIndex].id : Date.now(),
                date: date,
                sales: sales,
                returns: returns,
                expenses: expenses,
                startBalance: startBalance,
                currentPressure: netChange, // Net change for the day
                balance: newBalance // Final balance after all calculations
            };

            if (isEdit) {
                // Update the entry
                logs[logIndex] = newEntry;
                // Since an entry was updated, we need to recalculate all subsequent balances
                for (let i = logIndex + 1; i < logs.length; i++) {
                    const prevBalance = logs[i - 1].balance;
                    const prevNetChange = logs[i].currentPressure;
                    const prevTotalExpenses = (logs[i].expenses || []).reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
                    
                    logs[i].startBalance = prevBalance;
                    logs[i].balance = prevBalance + prevNetChange - prevTotalExpenses;
                }
                showNotification(`Pressure log updated for ${date}.`);
            } else {
                // New entry should always be appended
                if (logs.some(log => log.date === date)) {
                    return showNotification("A log entry already exists for this date. Please edit the existing entry.");
                }
                logs.push(newEntry);
                showNotification(`New pressure log saved for ${date}.`);
            }

            savePressureLogs(staffName, logs);
            closeModal('pressure-log-modal');
            renderApp(); // Re-render pressure view
        }

        function handleDeletePressureLog(staffName, logIndex) {
            let logs = getPressureLogs(staffName);

            if (logIndex !== null && logIndex >= 0 && logIndex < logs.length) {
                // Remove the log entry
                logs.splice(logIndex, 1);

                // Recalculate subsequent balances
                for (let i = logIndex; i < logs.length; i++) {
                    const prevBalance = i === 0 
                        ? 0 // Start fresh if it's the first log now
                        : logs[i - 1].balance;
                    
                    const currentNetChange = logs[i].currentPressure;
                    const currentTotalExpenses = (logs[i].expenses || []).reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
                    
                    logs[i].startBalance = prevBalance;
                    logs[i].balance = prevBalance + currentNetChange - currentTotalExpenses;
                }

                savePressureLogs(staffName, logs);
                showNotification("Pressure log entry deleted and subsequent balances updated.");
            } else {
                showNotification("Error: Log entry index out of bounds.");
            }
            closeModal('confirmation-modal');
            renderApp(); // Re-render pressure view
        }

        // --- Core Sales Dashboard Functions ---

        function calculateCurrentStock() {
            if (history.length === 0) {
                return { 
                    dresses: startingPressure.dresses, 
                    twoPcs: startingPressure.twoPcs, 
                    kimonos: startingPressure.kimonos 
                };
            }
            
            const lastEntry = history[history.length - 1];
            
            // Check for new/missing keys for migration safety
            return {
                dresses: lastEntry.remDresses || lastEntry.remaining || 0,
                twoPcs: lastEntry.remTwoPcs || 0,
                kimonos: lastEntry.remKimonos || 0,
            };
        }

        function calculateDailySummary(dayIndex = selectedDayIndex) {
            const dayName = DAYS[dayIndex];
            const todayEntries = history.filter(entry => entry.day === dayName);
            
            let totalSoldDresses = 0;
            let totalSoldTwoPcs = 0;
            let totalSoldKimonos = 0;
            let totalDispatchedDresses = 0;
            let totalDispatchedTwoPcs = 0;
            let totalDispatchedKimonos = 0;
            let totalReturns = 0;
            let totalProfit = 0;
            let totalExpenses = 0;

            todayEntries.forEach(entry => {
                // Handle new stock types + old legacy 'sold' field
                totalSoldDresses += Number(entry.soldDresses) || 0;
                totalSoldTwoPcs += Number(entry.soldTwoPcs) || 0;
                totalSoldKimonos += Number(entry.soldKimonos) || 0;
                
                // If old format used, add to dresses
                if (!entry.soldDresses && entry.sold) {
                    totalSoldDresses += Number(entry.sold);
                }

                totalDispatchedDresses += Number(entry.dispatchedDresses) || 0;
                totalDispatchedTwoPcs += Number(entry.dispatchedTwoPcs) || 0;
                totalDispatchedKimonos += Number(entry.dispatchedKimonos) || 0;

                // If old format used, add to dresses dispatched
                if (!entry.dispatchedDresses && entry.dispatched) {
                    totalDispatchedDresses += Number(entry.dispatched);
                }

                totalReturns += Number(entry.returns) || 0;
                totalProfit += Number(entry.profit) || 0;
                
                // Calculate expenses
                const expenses = entry.expenses || [];
                totalExpenses += expenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
            });

            return {
                dayName,
                entries: todayEntries,
                sold: totalSoldDresses + totalSoldTwoPcs + totalSoldKimonos,
                soldDresses: totalSoldDresses,
                soldTwoPcs: totalSoldTwoPcs,
                soldKimonos: totalSoldKimonos,
                dispatchedDresses: totalDispatchedDresses,
                dispatchedTwoPcs: totalDispatchedTwoPcs,
                dispatchedKimonos: totalDispatchedKimonos,
                returns: totalReturns,
                profit: totalProfit,
                expenses: totalExpenses
            };
        }
        
        function calculateWeeklySummary() {
            let totalSoldDresses = 0;
            let totalSoldTwoPcs = 0;
            let totalSoldKimonos = 0;
            let totalReturns = 0;
            let totalProfit = 0;
            let totalExpenses = 0;

            getFullHistory().forEach(entry => {
                totalSoldDresses += Number(entry.soldDresses) || 0;
                totalSoldTwoPcs += Number(entry.soldTwoPcs) || 0;
                totalSoldKimonos += Number(entry.soldKimonos) || 0;
                
                if (!entry.soldDresses && entry.sold) {
                    totalSoldDresses += Number(entry.sold);
                }

                totalReturns += Number(entry.returns) || 0;
                totalProfit += Number(entry.profit) || 0;

                const expenses = entry.expenses || [];
                totalExpenses += expenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
            });

            return {
                sold: totalSoldDresses + totalSoldTwoPcs + totalSoldKimonos,
                soldDresses: totalSoldDresses,
                soldTwoPcs: totalSoldTwoPcs,
                soldKimonos: totalSoldKimonos,
                returns: totalReturns,
                profit: totalProfit,
                expenses: totalExpenses
            };
        }

        function showEntryModal(entry = null) {
            const isEdit = entry !== null;
            const entryId = isEdit ? entry.id : Date.now();
            
            if (isEdit && isEntryLocked(entry)) {
                 return showNotification("Entry is locked. Editing is only allowed within 72 hours.");
            }

            const currentSummary = calculateDailySummary(selectedDayIndex);
            const currentStock = calculateCurrentStock();

            let remDresses = currentStock.dresses;
            let remTwoPcs = currentStock.twoPcs;
            let remKimonos = currentStock.kimonos;

            // If editing, adjust stock back to before this entry was made
            if (isEdit) {
                 const currentDayEntries = history.filter(e => e.day === entry.day).sort((a, b) => a.id - b.id);
                 const entryIndex = currentDayEntries.findIndex(e => e.id === entry.id);

                 if (entryIndex > 0) {
                     const previousEntry = currentDayEntries[entryIndex - 1];
                     remDresses = previousEntry.remDresses || previousEntry.remaining;
                     remTwoPcs = previousEntry.remTwoPcs || 0;
                     remKimonos = previousEntry.remKimonos || 0;
                 } else {
                     // If it's the first entry of the current history, use starting pressure
                     remDresses = startingPressure.dresses;
                     remTwoPcs = startingPressure.twoPcs;
                     remKimonos = startingPressure.kimonos;
                 }
            }

            // Input values
            const soldDressesVal = isEdit ? (entry.soldDresses || entry.sold || '') : '';
            const soldTwoPcsVal = isEdit ? (entry.soldTwoPcs || '') : '';
            const soldKimonosVal = isEdit ? (entry.soldKimonos || '') : '';
            
            const dispDressesVal = isEdit ? (entry.dispatchedDresses || entry.dispatched || '') : '';
            const dispTwoPcsVal = isEdit ? (entry.dispatchedTwoPcs || '') : '';
            const dispKimonosVal = isEdit ? (entry.dispatchedKimonos || '') : '';

            const returnsVal = isEdit ? (entry.returns || '') : '';
            const commentsVal = isEdit ? (entry.comments || '') : '';
            
            // Prices
            const userPrices = managedUser.prices || {};
            const dressBuyPrice = userPrices.dressBuy || DEFAULT_BUY_PRICE;
            const dressSellPrice = userPrices.dressSell || DEFAULT_SELL_PRICE;
            const twoPcBuyPrice = userPrices.twoPcBuy || DEFAULT_BUY_PRICE;
            const twoPcSellPrice = userPrices.twoPcSell || DEFAULT_SELL_PRICE;
            const kimonoBuyPrice = userPrices.kimonoBuy || DEFAULT_BUY_PRICE;
            const kimonoSellPrice = userPrices.kimonoSell || DEFAULT_SELL_PRICE;


            let expensesHTML = '';
            const initialExpenses = isEdit ? (entry.expenses || []) : [];
            if (initialExpenses.length > 0) {
                expensesHTML = initialExpenses.map((exp, i) => `
                    <div id="exp-row-${entryId}-${i}" class="grid grid-cols-5 gap-2 items-center mb-2">
                        <div class="col-span-3">
                            <input type="text" name="expense_name[]" value="${exp.name || ''}" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Expense Name">
                        </div>
                        <div class="col-span-1">
                            <input type="number" name="expense_amt[]" value="${exp.amount || ''}" class="w-full p-2 text-sm rounded-lg border border-slate-300" placeholder="Amt">
                        </div>
                        <div class="col-span-1 text-center">
                            <button type="button" onclick="document.getElementById('exp-row-${entryId}-${i}').remove()" class="p-2 text-red-500 hover:bg-red-50 rounded-lg">
                                ${renderIcon('trash-2', {class:'w-4 h-4'})}
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Determine if the user is using the reconciliation mode (only tracks Premium/Kimonos)
            const isReconciliationMode = managedUser.enableReconciliation;


            const modalHTML = `
                <div id="entry-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg z-10 p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold text-slate-800">${isEdit ? 'Edit Daily Entry' : 'New Daily Entry'} - ${DAYS[selectedDayIndex]}</h3>
                            <button onclick="closeModal('entry-modal')" class="text-slate-500 hover:text-slate-700 p-1 rounded-full">
                                ${renderIcon('x', { class: 'w-6 h-6' })}
                            </button>
                        </div>

                        <form id="entry-form" onsubmit="event.preventDefault(); handleEntrySave(this, ${isEdit ? entryId : null}, ${remDresses}, ${remTwoPcs}, ${remKimonos})">
                            <input type="hidden" name="entry_id" value="${entryId}">
                            <input type="hidden" name="day_name" value="${DAYS[selectedDayIndex]}">
                            <input type="hidden" name="is_edit" value="${isEdit}">
                            <input type="hidden" name="is_reconciliation" value="${isReconciliationMode}">

                            <div class="space-y-6">

                                <!-- Stock Section -->
                                <div class="p-4 border border-slate-200 rounded-lg bg-slate-50">
                                    <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                        ${renderIcon('package', { class: 'w-4 h-4 text-blue-600' })} Stock Movement
                                    </h4>
                                    
                                    ${isReconciliationMode ? 
                                        `<p class="text-xs text-blue-500 mb-3">Reconciliation mode enabled: Only Premium/Dresses and Kimonos are tracked for stock.</p>` 
                                        : ''
                                    }

                                    <!-- Stock Status -->
                                    <div class="grid grid-cols-3 gap-2 text-center text-sm mb-4">
                                        <div class="bg-blue-100 p-2 rounded-lg">
                                            <span class="font-medium text-blue-800">${remDresses}</span> Dr / ${remTwoPcs} TP
                                            <p class="text-xs text-blue-600 font-semibold">Current Premium</p>
                                        </div>
                                        <div class="bg-purple-100 p-2 rounded-lg">
                                            <span class="font-medium text-purple-800">${remKimonos}</span> Ki
                                            <p class="text-xs text-purple-600 font-semibold">Current Kimono</p>
                                        </div>
                                        <div class="bg-indigo-100 p-2 rounded-lg">
                                            <span class="font-medium text-indigo-800">${currentSummary.sold}</span> Total Sold Today
                                            <p class="text-xs text-indigo-600 font-semibold">Summary</p>
                                        </div>
                                    </div>

                                    <!-- Dispatched -->
                                    <h5 class="text-sm font-medium text-slate-700 mb-2">Stock Dispatched to You (+)</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-4">
                                        <input type="number" name="dispatchedDresses" value="${dispDressesVal}" min="0" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Premium Dr/TP">
                                        ${isReconciliationMode ? '' : `<input type="number" name="dispatchedTwoPcs" value="${dispTwoPcsVal}" min="0" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="CleanUp TP">`}
                                        <input type="number" name="dispatchedKimonos" value="${dispKimonosVal}" min="0" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Kimonos">
                                    </div>
                                </div>

                                <!-- Sales Section -->
                                <div class="p-4 border border-slate-200 rounded-lg">
                                    <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                        ${renderIcon('shopping-cart', { class: 'w-4 h-4 text-green-600' })} Sales & Returns (-)
                                    </h4>
                                    
                                    <!-- Sales -->
                                    <h5 class="text-sm font-medium text-slate-700 mb-2">Items Sold</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-4">
                                        <input type="number" name="soldDresses" value="${soldDressesVal}" min="0" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Premium Dr/TP">
                                        ${isReconciliationMode ? '' : `<input type="number" name="soldTwoPcs" value="${soldTwoPcsVal}" min="0" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="CleanUp TP">`}
                                        <input type="number" name="soldKimonos" value="${soldKimonosVal}" min="0" class="p-2 text-sm border border-slate-300 rounded-lg" placeholder="Kimonos">
                                    </div>
                                    
                                    <!-- Returns -->
                                    <h5 class="text-sm font-medium text-slate-700 mb-2">Returns / Cash Deductions</h5>
                                    <input type="number" name="returns" value="${returnsVal}" min="0" class="w-full p-2 text-sm border border-slate-300 rounded-lg" placeholder="Returns Amount (KES)">
                                </div>

                                <!-- Expenses Section -->
                                <div class="p-4 border border-slate-200 rounded-lg">
                                    <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                        ${renderIcon('wallet', { class: 'w-4 h-4 text-red-600' })} Daily Expenses (Cash Paid Out)
                                    </h4>
                                    <div id="expenses-container" class="space-y-2">
                                        ${expensesHTML}
                                    </div>
                                    <button type="button" onclick="addExpenseRow()" class="mt-3 w-full px-3 py-2 text-sm text-indigo-600 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition flex items-center justify-center gap-2">
                                        ${renderIcon('plus', { class: 'w-4 h-4' })} Add Expense
                                    </button>
                                </div>

                                <!-- Comments -->
                                <div class="p-4 border border-slate-200 rounded-lg">
                                    <h4 class="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                                        ${renderIcon('message-square', { class: 'w-4 h-4 text-yellow-600' })} Comments
                                    </h4>
                                    <textarea name="comments" rows="2" class="w-full p-2 text-sm border border-slate-300 rounded-lg" placeholder="Add any relevant comments or notes...">${commentsVal}</textarea>
                                </div>

                                <!-- Hidden Prices for Calculation -->
                                <input type="hidden" name="dressBuyPrice" value="${dressBuyPrice}">
                                <input type="hidden" name="dressSellPrice" value="${dressSellPrice}">
                                <input type="hidden" name="twoPcBuyPrice" value="${twoPcBuyPrice}">
                                <input type="hidden" name="twoPcSellPrice" value="${twoPcSellPrice}">
                                <input type="hidden" name="kimonoBuyPrice" value="${kimonoBuyPrice}">
                                <input type="hidden" name="kimonoSellPrice" value="${kimonoSellPrice}">

                            </div>

                            <div class="flex justify-end gap-3 mt-6">
                                <button type="button" onclick="closeModal('entry-modal')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-lg transition duration-150">
                                    Cancel
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg shadow-md transition duration-150">
                                    ${isEdit ? 'Update Entry' : 'Save Entry'}
                                </button>
                            </div>
                            
                            ${isEdit ? `
                                <button type="button" onclick="showConfirmationModal('Are you sure you want to delete this entry? This will affect all subsequent stock counts.', () => handleDeleteEntry('${entry.id}', '${entry.day}'))" class="mt-4 w-full px-4 py-2 text-sm font-medium text-red-600 bg-red-100 hover:bg-red-200 rounded-lg transition duration-150 flex items-center justify-center gap-2">
                                    ${renderIcon('trash-2', { class: 'w-4 h-4' })} Delete Entry
                                </button>
                            ` : ''}
                        </form>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            refreshIcons();
        }

        function handleEntrySave(form, entryId, startDresses, startTwoPcs, startKimonos) {
            const formData = new FormData(form);
            const isEdit = formData.get('is_edit') === 'true';
            const dayName = formData.get('day_name');
            const isReconciliationMode = formData.get('is_reconciliation') === 'true';

            // Sales/Dispatched
            const soldDresses = Number(formData.get('soldDresses')) || 0;
            const soldTwoPcs = isReconciliationMode ? 0 : (Number(formData.get('soldTwoPcs')) || 0);
            const soldKimonos = Number(formData.get('soldKimonos')) || 0;
            
            const dispatchedDresses = Number(formData.get('dispatchedDresses')) || 0;
            const dispatchedTwoPcs = isReconciliationMode ? 0 : (Number(formData.get('dispatchedTwoPcs')) || 0);
            const dispatchedKimonos = Number(formData.get('dispatchedKimonos')) || 0;
            
            const returns = Number(formData.get('returns')) || 0;
            const comments = formData.get('comments').trim();

            // Prices
            const dressBuyPrice = Number(formData.get('dressBuyPrice'));
            const dressSellPrice = Number(formData.get('dressSellPrice'));
            const twoPcBuyPrice = Number(formData.get('twoPcBuyPrice'));
            const twoPcSellPrice = Number(formData.get('twoPcSellPrice'));
            const kimonoBuyPrice = Number(formData.get('kimonoBuyPrice'));
            const kimonoSellPrice = Number(formData.get('kimonoSellPrice'));
            
            // Expenses
            const expenseNames = formData.getAll('expense_name[]');
            const expenseAmounts = formData.getAll('expense_amt[]');
            
            const expenses = expenseNames.map((name, index) => ({
                name: name.trim(),
                amount: Number(expenseAmounts[index]) || 0
            })).filter(exp => exp.name && exp.amount > 0);
            
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);

            // --- VALIDATION ---
            if (soldDresses < 0 || soldTwoPcs < 0 || soldKimonos < 0 || dispatchedDresses < 0 || dispatchedTwoPcs < 0 || dispatchedKimonos < 0 || returns < 0) {
                 return showNotification("Quantities cannot be negative.");
            }

            // --- CALCULATION ---
            
            // Calculate Profit from Sales
            const revenue = (soldDresses * dressSellPrice) + (soldTwoPcs * twoPcSellPrice) + (soldKimonos * kimonoSellPrice);
            const costOfGoods = (soldDresses * dressBuyPrice) + (soldTwoPcs * twoPcBuyPrice) + (soldKimonos * kimonoBuyPrice);
            
            const grossProfit = revenue - costOfGoods;
            const netProfit = grossProfit - returns - totalExpenses; // Deduct returns and expenses

            // Calculate Remaining Stock
            const remDresses = startDresses + dispatchedDresses - soldDresses;
            const remTwoPcs = startTwoPcs + dispatchedTwoPcs - soldTwoPcs;
            const remKimonos = startKimonos + dispatchedKimonos - soldKimonos;
            
            // --- FINAL VALIDATION (Stock Check) ---
            if (remDresses < 0 || remTwoPcs < 0 || remKimonos < 0) {
                let errorMsg = "Error: Stock count is negative. Check your inputs.";
                if (remDresses < 0) errorMsg = `Error: Premium/Dresses stock deficit of ${Math.abs(remDresses)}`;
                else if (remTwoPcs < 0) errorMsg = `Error: CleanUp/Two-Pcs stock deficit of ${Math.abs(remTwoPcs)}`;
                else if (remKimonos < 0) errorMsg = `Error: Kimono stock deficit of ${Math.abs(remKimonos)}`;

                return showNotification(errorMsg);
            }

            // --- SAVE ---
            const newEntry = {
                id: isEdit ? entryId : Date.now(),
                day: dayName,
                fullDate: new Date().toLocaleDateString(), 
                soldDresses: soldDresses,
                soldTwoPcs: soldTwoPcs,
                soldKimonos: soldKimonos,
                dispatchedDresses: dispatchedDresses,
                dispatchedTwoPcs: dispatchedTwoPcs,
                dispatchedKimonos: dispatchedKimonos,
                returns: returns,
                profit: netProfit,
                remDresses: remDresses,
                remTwoPcs: remTwoPcs,
                remKimonos: remKimonos,
                comments: comments,
                expenses: expenses,
                // Store prices used for this entry for auditing
                prices: { dressBuyPrice, dressSellPrice, twoPcBuyPrice, twoPcSellPrice, kimonoBuyPrice, kimonoSellPrice }
            };

            if (isEdit) {
                // Find index and replace
                const index = history.findIndex(e => e.id === entryId);
                if (index !== -1) {
                    // Update entry
                    history[index] = newEntry;
                    
                    // Recalculate all subsequent entries in the current history for the day
                    const currentDayEntries = history.filter(e => e.day === dayName).sort((a, b) => a.id - b.id);
                    const startIndex = currentDayEntries.findIndex(e => e.id === entryId);
                    
                    for (let i = startIndex + 1; i < currentDayEntries.length; i++) {
                        const current = currentDayEntries[i];
                        const previous = currentDayEntries[i - 1];
                        
                        current.remDresses = (previous.remDresses || previous.remaining || 0) + (current.dispatchedDresses || 0) - (current.soldDresses || 0);
                        current.remTwoPcs = (previous.remTwoPcs || 0) + (current.dispatchedTwoPcs || 0) - (current.soldTwoPcs || 0);
                        current.remKimonos = (previous.remKimonos || 0) + (current.dispatchedKimonos || 0) - (current.soldKimonos || 0);
                        
                        // Also update history array with the recalculated entry
                        const histIndex = history.findIndex(e => e.id === current.id);
                        if (histIndex !== -1) history[histIndex] = current;
                    }
                }
                showNotification("Entry updated successfully.");
            } else {
                // Add new entry
                history.push(newEntry);
                showNotification("New entry saved successfully.");
            }

            saveData(managedUser.phone);
            closeModal('entry-modal');
            renderApp();
        }

        function handleDeleteEntry(entryId, dayName) {
            let initialLength = history.length;
            
            // Find and remove the entry
            const indexToRemove = history.findIndex(e => e.id === entryId);

            if (indexToRemove !== -1) {
                history.splice(indexToRemove, 1);
                
                // Recalculate all subsequent entries in the current history for the day
                const currentDayEntries = history.filter(e => e.day === dayName).sort((a, b) => a.id - b.id);
                const startIndex = currentDayEntries.findIndex(e => e.id > entryId); // Start from the first entry after the deleted one

                for (let i = startIndex; i < currentDayEntries.length; i++) {
                    const current = currentDayEntries[i];
                    
                    // Determine previous stock
                    let prevDresses = startingPressure.dresses;
                    let prevTwoPcs = startingPressure.twoPcs;
                    let prevKimonos = startingPressure.kimonos;

                    if (i > 0) {
                        const previous = currentDayEntries[i - 1];
                        prevDresses = previous.remDresses || previous.remaining || 0;
                        prevTwoPcs = previous.remTwoPcs || 0;
                        prevKimonos = previous.remKimonos || 0;
                    }
                    
                    // Recalculate remaining stock
                    current.remDresses = prevDresses + (current.dispatchedDresses || 0) - (current.soldDresses || 0);
                    current.remTwoPcs = prevTwoPcs + (current.dispatchedTwoPcs || 0) - (current.soldTwoPcs || 0);
                    current.remKimonos = prevKimonos + (current.dispatchedKimonos || 0) - (current.soldKimonos || 0);
                    
                    // Also update history array with the recalculated entry
                    const histIndex = history.findIndex(e => e.id === current.id);
                    if (histIndex !== -1) history[histIndex] = current;
                }

                saveData(managedUser.phone);
                showNotification("Entry deleted and subsequent stock counts adjusted.");
            } else {
                showNotification("Error: Entry not found.");
            }

            closeModal('confirmation-modal');
            renderApp();
        }
        
        function showBalanceModal() {
            const currentStock = calculateCurrentStock();

            const modalHTML = `
                <div id="balance-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-75"></div>
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm z-10 p-6 sm:p-8">
                        <div class="flex justify-between items-start mb-6">
                            <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                ${renderIcon('refresh-cw', { class: 'w-6 h-6 text-indigo-600' })} Set Starting Stock
                            </h3>
                            <button onclick="closeModal('balance-modal')" class="text-slate-500 hover:text-slate-700 p-1 rounded-full">
                                ${renderIcon('x', { class: 'w-6 h-6' })}
                            </button>
                        </div>
                        
                        <p class="text-sm text-slate-500 mb-6">
                            This action will set the new starting stock for a fresh week/reporting period. The current week's history will be archived.
                        </p>

                        <form id="balance-form" onsubmit="event.preventDefault(); handleBalanceSave(this)">
                            
                            <div class="space-y-4 mb-6">
                                <div>
                                    <label for="balance-dresses" class="block text-sm font-medium text-slate-700">Dresses / Suits (Premium)</label>
                                    <input type="number" id="balance-dresses" name="dresses" value="${currentStock.dresses}" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="balance-twoPcs" class="block text-sm font-medium text-slate-700">Two-Piece (CleanUp)</label>
                                    <input type="number" id="balance-twoPcs" name="twoPcs" value="${currentStock.twoPcs}" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="0">
                                </div>
                                <div>
                                    <label for="balance-kimonos" class="block text-sm font-medium text-slate-700">Kimonos</label>
                                    <input type="number" id="balance-kimonos" name="kimonos" value="${currentStock.kimonos}" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="0">
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                <button type="submit" class="px-6 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150">
                                    Archive & Set New Stock
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            refreshIcons();
        }
        
        function handleBalanceSave(form) {
            const formData = new FormData(form);
            const dresses = Number(formData.get('dresses'));
            const twoPcs = Number(formData.get('twoPcs'));
            const kimonos = Number(formData.get('kimonos'));

            if (isNaN(dresses) || isNaN(twoPcs) || isNaN(kimonos) || dresses < 0 || twoPcs < 0 || kimonos < 0) {
                 return showNotification("Invalid stock quantity.");
            }

            if (history.length > 0) {
                // Move current history to archive
                archive = [...archive, ...history];
                history = [];
                showNotification("Current week's data archived.");
            }

            startingPressure = { dresses, twoPcs, kimonos };

            saveData(managedUser.phone);
            showNotification(`Starting stock set to ${dresses} Dr, ${twoPcs} TP, ${kimonos} Ki.`);
            closeModal('balance-modal');
            renderApp();
        }

        function handleFactoryReset() {
            showConfirmationModal("Are you absolutely sure you want to perform a factory reset? This will delete ALL users and ALL sales data (Procurement, Staff, Pressure Logs) from this device. This action is irreversible.", () => {
                showConfirmationModal("Confirm final step: Enter system PIN to proceed with irreversible Factory Reset.", () => {
                    const pin = prompt("Enter the 4-digit system PIN to confirm deletion of ALL data:");
                    if (pin === SYSTEM_PIN) {
                        // Clear ALL local storage keys
                        localStorage.clear();
                        showNotification("FACTORY RESET COMPLETE. All data has been erased.");
                        handleLogout(); // Force logout and rerender auth screen
                    } else {
                        showNotification("Incorrect PIN. Factory Reset cancelled.");
                    }
                });
            });
        }
        
        // --- Rendering Logic ---

        function renderAuthScreen() {
            const users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            const hasAdmin = users.some(u => u.role === 'admin');
            
            let staffLoginOptions = users.filter(u => u.role === 'staff').map(u => 
                `<option value="${u.phone}">${u.name} (${u.phone})</option>`
            ).join('');

            const authHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-slate-100">
                    <div class="w-full max-w-sm bg-white rounded-xl shadow-2xl p-6 sm:p-8">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-extrabold text-indigo-700">Trinah Designs</h1>
                            <p class="text-sm text-slate-500 mt-1">Sales & Stock Management</p>
                        </div>

                        ${authError ? `<div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg font-medium">${authError}</div>` : ''}
                        
                        ${!hasAdmin && !showAdminCreation ? `
                            <!-- Admin Creation Prompt -->
                            <div class="p-5 bg-indigo-50 border border-indigo-200 rounded-lg text-center mb-6">
                                <p class="font-semibold text-indigo-700 mb-3">Welcome! No Admin Found.</p>
                                <p class="text-sm text-indigo-600 mb-4">Please set up the primary Admin account first.</p>
                                <button onclick="showAdminCreation = true; renderAuthScreen()" class="w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition duration-150">
                                    Create Admin Account
                                </button>
                            </div>
                        ` : ''}

                        ${!hasAdmin && showAdminCreation ? `
                            <!-- Admin Creation Form -->
                            <form onsubmit="event.preventDefault(); handleAdminSetup(this)">
                                <h2 class="text-xl font-bold text-slate-800 mb-4">Admin Setup</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="admin-name" class="block text-sm font-medium text-slate-700">Name</label>
                                        <input type="text" id="admin-name" name="name" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Admin Name">
                                    </div>
                                    <div>
                                        <label for="admin-phone" class="block text-sm font-medium text-slate-700">Phone (Login ID)</label>
                                        <input type="text" id="admin-phone" name="phone" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 2547XXXXXXXX">
                                    </div>
                                    <div>
                                        <label for="admin-password" class="block text-sm font-medium text-slate-700">Password</label>
                                        <input type="password" id="admin-password" name="password" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Secure Password">
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="w-full px-4 py-3 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150" ${authLoading ? 'disabled' : ''}>
                                        ${authLoading ? 'Creating...' : 'Create Admin'}
                                    </button>
                                </div>
                            </form>
                        ` : hasAdmin ? `
                            <!-- General Login Form -->
                            <form onsubmit="event.preventDefault(); handleLoginAttempt(this)">
                                <h2 class="text-xl font-bold text-slate-800 mb-4">Login</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="login-type" class="block text-sm font-medium text-slate-700">Login Type</label>
                                        <select id="login-type" name="loginType" onchange="toggleLoginForm(this.value)" class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                            <option value="staff">Staff Login</option>
                                            <option value="admin">Admin Login</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Staff Login Fields -->
                                    <div id="staff-login-fields">
                                        <div>
                                            <label for="staff-phone-select" class="block text-sm font-medium text-slate-700">Staff Member</label>
                                            <select id="staff-phone-select" name="phoneStaff" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="">-- Select Staff --</option>
                                                ${staffLoginOptions}
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Admin Login Fields -->
                                    <div id="admin-login-fields" style="display:none;">
                                        <div>
                                            <label for="admin-phone-input" class="block text-sm font-medium text-slate-700">Admin Phone (ID)</label>
                                            <input type="text" id="admin-phone-input" name="phoneAdmin" class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Admin Phone ID">
                                        </div>
                                    </div>

                                    <div>
                                        <label for="login-password" class="block text-sm font-medium text-slate-700">Password</label>
                                        <input type="password" id="login-password" name="password" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Password">
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="w-full px-4 py-3 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150" ${authLoading ? 'disabled' : ''}>
                                        ${authLoading ? 'Logging in...' : 'Log In'}
                                    </button>
                                </div>
                                <div class="mt-4 text-center">
                                    <button type="button" onclick="renderRecoveryScreen()" class="text-xs text-slate-500 hover:text-indigo-600 transition">
                                        Lost Password or Admin Account?
                                    </button>
                                </div>
                            </form>
                        ` : ''}

                        <div class="mt-8 pt-4 border-t border-slate-200 text-center">
                            <button onclick="handleFactoryReset()" class="text-xs text-red-500 hover:text-red-700 transition">
                                Factory Reset
                            </button>
                        </div>

                    </div>
                </div>
            `;
            appElement.innerHTML = authHTML;
            refreshIcons();
        }
        
        function toggleLoginForm(type) {
            const staffFields = document.getElementById('staff-login-fields');
            const adminFields = document.getElementById('admin-login-fields');
            
            if (staffFields && adminFields) {
                if (type === 'admin') {
                    staffFields.style.display = 'none';
                    adminFields.style.display = 'block';
                    document.getElementById('staff-phone-select').removeAttribute('required');
                    document.getElementById('admin-phone-input').setAttribute('required', 'required');
                } else {
                    staffFields.style.display = 'block';
                    adminFields.style.display = 'none';
                    document.getElementById('admin-phone-input').removeAttribute('required');
                    document.getElementById('staff-phone-select').setAttribute('required', 'required');
                }
            }
        }

        function handleAdminSetup(form) {
            authLoading = true;
            authError = "";
            const formData = new FormData(form);
            const name = formData.get('name').trim();
            const phone = formData.get('phone').trim();
            const password = formData.get('password').trim();

            if (!name || !phone || !password) {
                authError = "All fields are required.";
                authLoading = false;
                return renderAuthScreen();
            }

            const newAdmin = { name, phone, password, role: 'admin', prices: {} };
            const users = [newAdmin];
            localStorage.setItem(DB_KEY, JSON.stringify(users));

            showNotification("Admin account created. Logging in...");
            handleLogin(newAdmin);
        }

        function handleLoginAttempt(form) {
            authLoading = true;
            authError = "";
            renderAuthScreen(); // Re-render to show loading state

            const formData = new FormData(form);
            const loginType = formData.get('loginType');
            const password = formData.get('password').trim();
            
            let phone;
            if (loginType === 'admin') {
                phone = formData.get('phoneAdmin').trim();
            } else {
                phone = formData.get('phoneStaff').trim();
            }

            const users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            const user = users.find(u => u.phone === phone);

            if (!user) {
                authError = "User not found.";
            } else if (user.role !== loginType) {
                authError = `Login failed: The user '${user.name}' is not an ${loginType} account.`;
            } else if (user.password !== password) {
                authError = "Incorrect password.";
            }

            if (authError) {
                authLoading = false;
                return renderAuthScreen();
            }

            // Success
            handleLogin(user);
        }
        
        // --- Recovery Screen Logic ---
        let recoveryStep = 1;
        let recoveryData = { phone: '', newPass: '', confirmedPass: '' };

        function renderRecoveryScreen() {
            let contentHTML = '';

            switch (recoveryStep) {
                case 1:
                    contentHTML = `
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Step 1: Verify Phone</h2>
                        <p class="text-sm text-slate-600 mb-6">Enter the Phone ID (Login ID) of the account you wish to recover.</p>
                        <form onsubmit="event.preventDefault(); handleRecoveryStep1(this)">
                            <div class="space-y-4">
                                <div>
                                    <label for="recovery-phone" class="block text-sm font-medium text-slate-700">Phone ID</label>
                                    <input type="text" id="recovery-phone" name="phone" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 2547XXXXXXXX">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition duration-150">
                                    Next: Set New Password
                                </button>
                            </div>
                        </form>
                    `;
                    break;
                case 2:
                    contentHTML = `
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Step 2: Set New Password</h2>
                        <p class="text-sm text-slate-600 mb-6">You are setting a new password for user: <span class="font-semibold text-indigo-600">${recoveryData.phone}</span>. This requires the system PIN.</p>
                        <form onsubmit="event.preventDefault(); handleRecoveryStep2(this)">
                            <div class="space-y-4">
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-slate-700">New Password</label>
                                    <input type="text" id="new-password" name="newPass" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter new password">
                                </div>
                                <div>
                                    <label for="confirm-password" class="block text-sm font-medium text-slate-700">Confirm New Password</label>
                                    <input type="text" id="confirm-password" name="confirmedPass" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Confirm new password">
                                </div>
                                <div>
                                    <label for="system-pin" class="block text-sm font-medium text-slate-700">System PIN (Required for Recovery)</label>
                                    <input type="password" id="system-pin" name="systemPin" required class="mt-1 w-full p-3 border border-slate-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Enter System PIN">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-between">
                                <button type="button" onclick="recoveryStep = 1; renderRecoveryScreen()" class="text-sm font-medium text-slate-500 hover:text-slate-700">
                                    &larr; Back
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg shadow-md transition duration-150">
                                    Reset Password
                                </button>
                            </div>
                        </form>
                    `;
                    break;
            }

            const recoveryHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-slate-100">
                    <div class="w-full max-w-sm bg-white rounded-xl shadow-2xl p-6 sm:p-8">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-extrabold text-red-700">Account Recovery</h1>
                            <p class="text-sm text-slate-500 mt-1">Administrator action required</p>
                        </div>
                        ${authError ? `<div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg font-medium">${authError}</div>` : ''}
                        
                        ${contentHTML}

                        <div class="mt-8 pt-4 border-t border-slate-200 text-center">
                            <button onclick="recoveryStep = 1; authError = ''; renderAuthScreen()" class="text-xs text-indigo-500 hover:text-indigo-700 transition">
                                Back to Login
                            </button>
                        </div>
                    </div>
                </div>
            `;
            appElement.innerHTML = recoveryHTML;
            refreshIcons();
        }
        
        function handleRecoveryStep1(form) {
            authError = "";
            const formData = new FormData(form);
            const phone = formData.get('phone').trim();
            
            const users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            const user = users.find(u => u.phone === phone);
            
            if (!user) {
                authError = "User with this Phone ID not found.";
                return renderRecoveryScreen();
            }

            recoveryData.phone = phone;
            recoveryStep = 2;
            renderRecoveryScreen();
        }

        function handleRecoveryStep2(form) {
            authError = "";
            const formData = new FormData(form);
            const newPass = formData.get('newPass').trim();
            const confirmedPass = formData.get('confirmedPass').trim();
            const systemPin = formData.get('systemPin').trim();

            if (newPass !== confirmedPass) {
                authError = "New passwords do not match.";
                return renderRecoveryScreen();
            }
            if (systemPin !== SYSTEM_PIN) {
                authError = "Incorrect System PIN. Password reset failed.";
                return renderRecoveryScreen();
            }

            // Find user and update password
            let users = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            const index = users.findIndex(u => u.phone === recoveryData.phone);

            if (index !== -1) {
                users[index].password = newPass;
                localStorage.setItem(DB_KEY, JSON.stringify(users));
                showNotification(`Password for ${users[index].name} reset successfully.`);
                
                // Reset recovery state and go back to login
                recoveryStep = 1;
                recoveryData = { phone: '', newPass: '', confirmedPass: '' };
                renderAuthScreen();
            } else {
                authError = "Error: User not found in database.";
                renderRecoveryScreen();
            }
        }
        
        function verifySystemPin() {
            const pin = prompt("Enter the 4-digit system PIN to proceed:");
            return pin === SYSTEM_PIN;
        }

        // --- View Rendering Functions ---

        function renderUserDashboard() {
            const user = managedUser;
            const summary = calculateDailySummary(selectedDayIndex);
            const weeklySummary = calculateWeeklySummary();
            const currentStock = calculateCurrentStock();
            const fullHistory = getFullHistory();
            const isReconciliationMode = user.enableReconciliation;

            // Determine previous day's stock or starting stock
            let lastEntry = fullHistory.length > 0 ? fullHistory[fullHistory.length - 1] : null;
            
            let stockAtStart = { 
                dresses: startingPressure.dresses, 
                twoPcs: startingPressure.twoPcs, 
                kimonos: startingPressure.kimonos 
            };
            
            if (lastEntry) {
                 stockAtStart = {
                    dresses: lastEntry.remDresses || lastEntry.remaining || 0,
                    twoPcs: lastEntry.remTwoPcs || 0,
                    kimonos: lastEntry.remKimonos || 0
                };
            }
            
            // Render Stock Card based on mode
            const stockCardHTML = isReconciliationMode ? `
                <div class="col-span-1 bg-white p-4 rounded-xl shadow-lg border border-purple-200">
                    <p class="text-sm font-semibold text-purple-700 flex items-center gap-1">${renderIcon('package', {class: 'w-4 h-4'})} Current Stock (Reconciled)</p>
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <p class="text-2xl font-bold text-purple-800">${currentStock.dresses}</p>
                            <p class="text-xs text-purple-600">Premium Dr/TP</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center">
                            <p class="text-2xl font-bold text-purple-800">${currentStock.kimonos}</p>
                            <p class="text-xs text-purple-600">Kimonos</p>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 text-center">CleanUp/Two-Pcs stock is not tracked.</p>
                </div>
            ` : `
                <div class="col-span-1 bg-white p-4 rounded-xl shadow-lg border border-blue-200">
                    <p class="text-sm font-semibold text-blue-700 flex items-center gap-1">${renderIcon('package', {class: 'w-4 h-4'})} Current Stock</p>
                    <div class="grid grid-cols-3 gap-2 mt-3">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <p class="text-xl font-bold text-blue-800">${currentStock.dresses}</p>
                            <p class="text-xs text-blue-600">Premium Dr/TP</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <p class="text-xl font-bold text-blue-800">${currentStock.twoPcs}</p>
                            <p class="text-xs text-blue-600">CleanUp TP</p>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <p class="text-xl font-bold text-blue-800">${currentStock.kimonos}</p>
                            <p class="text-xs text-blue-600">Kimonos</p>
                        </div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 text-center">Total: ${currentStock.dresses + currentStock.twoPcs + currentStock.kimonos} items</p>
                </div>
            `;


            const dailyEntriesHTML = summary.entries.map(entry => {
                const isLocked = isEntryLocked(entry);
                const salesDisplay = `Dr: ${entry.soldDresses || entry.sold || 0}, TP: ${entry.soldTwoPcs || 0}, Ki: ${entry.soldKimonos || 0}`;
                const dispatchDisplay = `Dr: ${entry.dispatchedDresses || entry.dispatched || 0}, TP: ${entry.dispatchedTwoPcs || 0}, Ki: ${entry.dispatchedKimonos || 0}`;
                const remainingDisplay = `Dr: ${entry.remDresses || entry.remaining || 0}, TP: ${entry.remTwoPcs || 0}, Ki: ${entry.remKimonos || 0}`;
                
                const totalExpenses = (entry.expenses || []).reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);

                return `
                    <div class="p-4 border-b border-slate-200 last:border-b-0 bg-white hover:bg-slate-50 transition duration-150 rounded-lg shadow-sm">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-slate-800 flex items-center gap-2">
                                    Entry at ${new Date(entry.id).toLocaleTimeString()}
                                    ${isLocked ? `<span class="text-red-500 text-xs font-normal">(${renderIcon('lock', {class:'w-3 h-3 inline'})} Locked)</span>` : ''}
                                </p>
                                <p class="text-sm text-slate-600 mt-1">
                                    <span class="font-medium text-green-600">Sold:</span> ${salesDisplay} 
                                    <span class="ml-4 font-medium text-blue-600">Dispatched:</span> ${dispatchDisplay}
                                </p>
                                <p class="text-sm text-slate-600">
                                    <span class="font-medium">Remaining:</span> ${remainingDisplay}
                                </p>
                                <p class="text-sm text-slate-800 mt-2">
                                    Profit: <span class="font-bold text-emerald-600">${formatCurrency(entry.profit)}</span> 
                                    (Returns: ${formatCurrency(entry.returns)}, Expenses: ${formatCurrency(totalExpenses)})
                                </p>
                                ${entry.comments ? `<p class="text-xs text-slate-500 mt-1 italic">Note: ${entry.comments}</p>` : ''}
                            </div>
                            <button onclick="showEntryModal(${isLocked ? null : 'history.find(e => e.id === ' + entry.id + ')'})" class="text-indigo-600 hover:text-indigo-800 p-2 rounded-full transition ${isLocked ? 'opacity-50 cursor-not-allowed' : ''}" ${isLocked ? 'disabled' : ''} title="${isLocked ? 'Locked for editing' : 'Edit Entry'}">
                                ${renderIcon('edit', { class: 'w-4 h-4' })}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            const weeklyProgressCard = `
                <div class="bg-white p-4 rounded-xl shadow-lg border border-slate-200">
                    <p class="text-sm font-semibold text-slate-700 flex items-center gap-1">${renderIcon('trending-up', {class: 'w-4 h-4'})} Weekly Progress</p>
                    <div class="mt-3 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">Total Items Sold:</span>
                            <span class="font-bold text-indigo-600">${weeklySummary.sold}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">Total Profit:</span>
                            <span class="font-bold text-green-600">${formatCurrency(weeklySummary.profit)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">Total Expenses:</span>
                            <span class="font-bold text-red-600">${formatCurrency(weeklySummary.expenses)}</span>
                        </div>
                        <div class="pt-2 border-t mt-3 text-xs text-slate-500">
                            <p>Premium/Dresses: <span class="font-medium">${weeklySummary.soldDresses}</span></p>
                            ${isReconciliationMode ? '' : `<p>CleanUp/Two-Pcs: <span class="font-medium">${weeklySummary.soldTwoPcs}</span></p>`}
                            <p>Kimonos: <span class="font-medium">${weeklySummary.soldKimonos}</span></p>
                        </div>
                    </div>
                </div>
            `;
            
            const dashboardHTML = `
                <div class="p-4 sm:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-slate-800">Welcome, ${user.name}</h2>
                        <button onclick="showBalanceModal()" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-100 rounded-lg hover:bg-indigo-200 transition flex items-center gap-2">
                            ${renderIcon('rotate-cw', { class: 'w-4 h-4' })} Set New Stock
                        </button>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        ${stockCardHTML}
                        
                        <div class="col-span-1 bg-white p-4 rounded-xl shadow-lg border border-green-200">
                            <p class="text-sm font-semibold text-green-700 flex items-center gap-1">${renderIcon('dollar-sign', {class: 'w-4 h-4'})} Today's Profit</p>
                            <p class="text-3xl font-extrabold mt-1 text-green-600">${formatCurrency(summary.profit)}</p>
                            <p class="text-xs text-slate-500 mt-2">Sales: ${summary.sold} | Expenses: ${formatCurrency(summary.expenses)}</p>
                        </div>
                        
                        ${weeklyProgressCard}

                        <div class="col-span-1 bg-white p-4 rounded-xl shadow-lg border border-yellow-200">
                            <p class="text-sm font-semibold text-yellow-700 flex items-center gap-1">${renderIcon('target', {class: 'w-4 h-4'})} Next Target</p>
                            <p class="text-3xl font-extrabold mt-1 text-yellow-600">N/A</p>
                            <p class="text-xs text-slate-500 mt-2">Focus on quality sales & daily logs.</p>
                        </div>
                    </div>
                    
                    <!-- Day Selection & New Entry -->
                    <div class="flex flex-wrap justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-lg">
                        <div class="flex overflow-x-auto space-x-2 pb-2">
                            ${DAYS.map((day, index) => `
                                <button onclick="selectedDayIndex = ${index}; renderApp()" class="px-4 py-2 text-sm font-medium rounded-full transition duration-150 flex-shrink-0
                                    ${selectedDayIndex === index ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}">
                                    ${day}
                                </button>
                            `).join('')}
                        </div>
                        <button onclick="showEntryModal()" class="mt-4 sm:mt-0 px-6 py-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition flex items-center gap-2">
                            ${renderIcon('plus-circle', { class: 'w-5 h-5' })} New Entry
                        </button>
                    </div>

                    <!-- Daily Entries List -->
                    <h3 class="text-xl font-bold text-slate-800 mb-4">${summary.dayName} Entries (${summary.entries.length})</h3>
                    <div class="space-y-4">
                        ${dailyEntriesHTML || '<div class="text-center p-8 bg-white rounded-xl text-slate-500 shadow-lg">No entries logged for this day yet.</div>'}
                    </div>

                    <!-- Full History View -->
                    <div class="mt-10 p-4 bg-slate-100 rounded-xl shadow-inner">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            ${renderIcon('history', { class: 'w-5 h-5' })} Full Sales History (${fullHistory.length} Total Entries)
                        </h3>
                        <p class="text-sm text-slate-600 mb-4">This includes all current week and archived entries.</p>
                        <div class="flex flex-wrap gap-2">
                            ${fullHistory.map(entry => `
                                <span class="px-3 py-1 text-xs rounded-full ${entry.day === DAYS[selectedDayIndex] ? 'bg-indigo-200 text-indigo-800' : 'bg-slate-200 text-slate-700'}">
                                    ${entry.day}: ${formatCurrency(entry.profit)}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            appElement.innerHTML = renderLayout(dashboardHTML);
            refreshIcons();
        }

        function renderAdminDashboard() {
            const users = JSON.parse(localStorage.getItem(DB_KEY) || "[]").filter(u => u.role !== 'admin');
            const logs = JSON.parse(localStorage.getItem(PROCUREMENT_KEY) || "{}");
            const controllerLogs = JSON.parse(localStorage.getItem(CONTROLLER_KEY) || "{}");
            
            const staffListHTML = users.map(user => {
                const userSummary = calculateWeeklySummaryForUser(user.phone);
                
                const reconciliationMode = user.enableReconciliation ? 
                    `<span class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-0.5 rounded-full">Recon. ON</span>` : 
                    `<span class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">Full Track</span>`;

                return `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white rounded-xl shadow-md hover:shadow-lg transition duration-150 border border-slate-200">
                        <div class="flex-1 min-w-0 mb-3 sm:mb-0">
                            <p class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                ${renderIcon('user', { class: 'w-5 h-5 text-indigo-600' })} ${user.name} 
                            </p>
                            <p class="text-sm text-slate-500 ml-7">
                                ID: ${user.phone} | ${reconciliationMode}
                            </p>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:space-x-4 text-sm font-medium text-right sm:text-left">
                            <div class="mb-2 sm:mb-0">
                                <p class="text-slate-600">Total Sold</p>
                                <p class="font-bold text-indigo-600">${userSummary.sold}</p>
                            </div>
                            <div class="mb-2 sm:mb-0">
                                <p class="text-slate-600">Total Profit</p>
                                <p class="font-bold text-green-600">${formatCurrency(userSummary.profit)}</p>
                            </div>
                            <div class="mb-2 sm:mb-0">
                                <p class="text-slate-600">Entries</p>
                                <p class="font-bold text-slate-800">${userSummary.entries} (Archived: ${userSummary.archiveEntries})</p>
                            </div>
                        </div>
                        <div class="mt-3 sm:mt-0 flex space-x-2">
                            <button onclick="manageUser('${user.phone}')" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition">
                                View Dashboard
                            </button>
                            <button onclick="showAddStaffModal(true, '${user.phone}')" class="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-lg transition">
                                Edit
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Procurement Logic for selected date
            const dateStr = selectedProcurementDate.toLocaleDateString();
            const dateInputFormat = selectedProcurementDate.toISOString().split('T')[0];
            let procurementData = logs[dateStr] || {dresses: 0, kimonos: 0};
            if (typeof procurementData === 'number') {
                 procurementData = { dresses: procurementData, kimonos: 0 };
            }

            const procDresses = procurementData.dresses;
            const procKimonos = procurementData.kimonos;
            
            // Calculate dispatched totals for today
            const dailyDispatchSummary = calculateDailyDispatched();
            const dispatchedDresses = dailyDispatchSummary.dresses;
            const dispatchedKimonos = dailyDispatchSummary.kimonos;
            
            // Calculate variance
            const varianceD = procDresses - dispatchedDresses;
            const varianceK = procKimonos - dispatchedKimonos;
            
            const getVarianceClass = (v) => {
                if (v > 0) return 'text-red-600 font-bold'; // Missing
                if (v < 0) return 'text-yellow-600 font-bold'; // Extra
                return 'text-green-600 font-bold';
            };
            const getVarianceText = (v) => {
                if (v > 0) return `Missing: ${v}`;
                if (v < 0) return `Extra: ${Math.abs(v)}`;
                return 'Balanced';
            };

            // Calculate Controller Log Summary for Today
            const todayControllerLogs = controllerLogs[new Date().toLocaleDateString()] || [];
            const totalControllerInDresses = todayControllerLogs.filter(l => l.type === 'In').reduce((sum, l) => sum + l.dresses, 0);
            const totalControllerInKimonos = todayControllerLogs.filter(l => l.type === 'In').reduce((sum, l) => sum + l.kimonos, 0);
            const totalControllerOutDresses = todayControllerLogs.filter(l => l.type === 'Out').reduce((sum, l) => sum + l.dresses, 0);
            const totalControllerOutKimonos = todayControllerLogs.filter(l => l.type === 'Out').reduce((sum, l) => sum + l.kimonos, 0);

            const adminDashboardHTML = `
                <div class="p-4 sm:p-8">
                    <h2 class="text-3xl font-bold text-slate-800 mb-6">Admin Dashboard</h2>

                    <!-- Management Tabs -->
                    <div class="flex overflow-x-auto space-x-3 mb-8 pb-2 border-b border-slate-200">
                        <button onclick="setView(VIEW_USERS)" class="px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white shadow-md flex items-center gap-1">
                            ${renderIcon('users', { class: 'w-4 h-4' })} Staff Management
                        </button>
                        <button onclick="setView(VIEW_DASHBOARD); managedUser = null;" class="px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white shadow-md flex items-center gap-1">
                            ${renderIcon('layout-dashboard', { class: 'w-4 h-4' })} Admin Overview
                        </button>
                        <button onclick="setView(VIEW_PRESSURE)" class="px-4 py-2 text-sm font-medium rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 shadow-sm flex items-center gap-1">
                            ${renderIcon('target', { class: 'w-4 h-4' })} Pressure Calculator
                        </button>
                    </div>

                    <!-- Admin Overview Section -->
                    <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                        ${renderIcon('bar-chart-2', { class: 'w-5 h-5 text-indigo-600' })} Daily Procurement & Dispatch Reconciliation
                    </h3>

                    <!-- Date Picker and Actions -->
                    <div class="flex flex-wrap items-center justify-between gap-4 p-4 bg-white rounded-xl shadow-lg mb-6">
                        <div class="flex items-center gap-3">
                            <label for="procurement-date-picker" class="text-sm font-medium text-slate-700">View Date:</label>
                            <input type="date" id="procurement-date-picker" value="${dateInputFormat}" onchange="handleProcurementDateChange(this)" class="p-2 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="showProcurementModal()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg transition flex items-center gap-2">
                                ${renderIcon('box', { class: 'w-4 h-4' })} Edit Procurement
                            </button>
                            <button onclick="downloadMasterReport('Daily', '${dateInputFormat}')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-lg transition flex items-center gap-2">
                                ${renderIcon('download', { class: 'w-4 h-4' })} Download Daily Report
                            </button>
                        </div>
                    </div>

                    <!-- Reconciliation Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Dresses/Suits Reconciliation Card -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                            <h4 class="text-lg font-bold text-blue-700 mb-3 flex items-center gap-2">${renderIcon('tshirt', {class:'w-5 h-5'})} Dresses / Suits (Premium)</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between border-b pb-1">
                                    <span class="text-slate-600">Acquired (Procurement):</span>
                                    <span class="font-bold text-slate-800">${procDresses} pcs</span>
                                </div>
                                <div class="flex justify-between border-b pb-1">
                                    <span class="text-slate-600">Dispatched to Staff (Logs):</span>
                                    <span class="font-bold text-slate-800">${dispatchedDresses} pcs</span>
                                </div>
                                <div class="flex justify-between pt-2">
                                    <span class="text-lg font-bold text-slate-800">Variance:</span>
                                    <span class="text-lg ${getVarianceClass(varianceD)}">${getVarianceText(varianceD)}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Kimonos Reconciliation Card -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-purple-500">
                            <h4 class="text-lg font-bold text-purple-700 mb-3 flex items-center gap-2">${renderIcon('layers-3', {class:'w-5 h-5'})} Kimonos</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between border-b pb-1">
                                    <span class="text-slate-600">Acquired (Procurement):</span>
                                    <span class="font-bold text-slate-800">${procKimonos} pcs</span>
                                </div>
                                <div class="flex justify-between border-b pb-1">
                                    <span class="text-slate-600">Dispatched to Staff (Logs):</span>
                                    <span class="font-bold text-slate-800">${dispatchedKimonos} pcs</span>
                                </div>
                                <div class="flex justify-between pt-2">
                                    <span class="text-lg font-bold text-slate-800">Variance:</span>
                                    <span class="text-lg ${getVarianceClass(varianceK)}">${getVarianceText(varianceK)}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controller Log Summary -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-500 mb-8">
                         <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-bold text-emerald-700 flex items-center gap-2">
                                ${renderIcon('clipboard-list', {class:'w-5 h-5'})} Today's Controller Log Summary
                            </h4>
                            <button onclick="showControllerModal()" class="px-3 py-1 text-xs font-medium text-emerald-700 bg-emerald-100 hover:bg-emerald-200 rounded-lg transition flex items-center gap-1">
                                ${renderIcon('edit', { class: 'w-3 h-3' })} Manage Log
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="p-3 bg-emerald-50 rounded-lg">
                                <p class="font-semibold text-emerald-800">Stock In</p>
                                <p class="text-xs text-slate-600">Dr: ${totalControllerInDresses}, Ki: ${totalControllerInKimonos}</p>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg">
                                <p class="font-semibold text-red-800">Stock Out</p>
                                <p class="text-xs text-slate-600">Dr: ${totalControllerOutDresses}, Ki: ${totalControllerOutKimonos}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Staff Performance & Management -->
                    <h3 class="text-xl font-bold text-slate-800 mb-4 mt-8 flex items-center gap-2">
                        ${renderIcon('users', { class: 'w-5 h-5 text-indigo-600' })} Staff Management & Performance
                    </h3>

                    <div class="flex justify-between items-center mb-6">
                        <p class="text-sm text-slate-600">${users.length} staff members registered (excluding Admin).</p>
                        <div class="flex gap-3">
                             <button onclick="downloadMasterReport('Weekly')" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-lg transition flex items-center gap-2">
                                ${renderIcon('download', { class: 'w-4 h-4' })} Master Weekly Report
                            </button>
                            <button onclick="showAddStaffModal()" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-lg shadow-md transition flex items-center gap-2">
                                ${renderIcon('user-plus', { class: 'w-4 h-4' })} Add Staff
                            </button>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${staffListHTML || '<div class="text-center p-8 bg-white rounded-xl text-slate-500 shadow-lg">No staff members have been added yet.</div>'}
                    </div>

                </div>
            `;

            appElement.innerHTML = renderLayout(adminDashboardHTML);
            refreshIcons();
        }

        function renderUsersView() {
            // Since Admin Dashboard is the primary place for user management, 
            // this function will simply redirect to that view.
            renderAdminDashboard();
        }

        function renderPressureView() {
            const pressureHTML = renderPressureCalculator();
            appElement.innerHTML = renderLayout(pressureHTML);
            refreshIcons();
        }

        function calculateDailyDispatched() {
            const currentDate = selectedProcurementDate.toLocaleDateString();
            const allUsers = JSON.parse(localStorage.getItem(DB_KEY) || "[]").filter(u => u.role !== 'admin');
            
            let totalDresses = 0;
            let totalKimonos = 0;

            allUsers.forEach(user => {
                const userHistoryStr = localStorage.getItem(`trinah_current_week_${user.phone}`) || "[]";
                const userArchiveStr = localStorage.getItem(`trinah_archive_${user.phone}`) || "[]";
                
                const allEntries = [...JSON.parse(userArchiveStr), ...JSON.parse(userHistoryStr)];
                
                const dailyEntries = allEntries.filter(e => e.fullDate === currentDate);

                dailyEntries.forEach(entry => {
                    totalDresses += Number(entry.dispatchedDresses) || 0;
                    totalDresses += Number(entry.dispatchedTwoPcs) || 0;
                    totalDresses += Number(entry.dispatched) || 0; // legacy
                    totalKimonos += Number(entry.dispatchedKimonos) || 0;
                });
            });

            return { dresses: totalDresses, kimonos: totalKimonos };
        }

        function calculateWeeklySummaryForUser(phone) {
            const userHistoryStr = localStorage.getItem(`trinah_current_week_${phone}`) || "[]";
            const userArchiveStr = localStorage.getItem(`trinah_archive_${phone}`) || "[]";
            
            const historyData = JSON.parse(userHistoryStr);
            const archiveData = JSON.parse(userArchiveStr);
            const allEntries = [...archiveData, ...historyData];
            
            let totalSoldDresses = 0;
            let totalSoldTwoPcs = 0;
            let totalSoldKimonos = 0;
            let totalProfit = 0;

            allEntries.forEach(entry => {
                totalSoldDresses += Number(entry.soldDresses) || 0;
                totalSoldTwoPcs += Number(entry.soldTwoPcs) || 0;
                totalSoldKimonos += Number(entry.soldKimonos) || 0;
                
                if (!entry.soldDresses && entry.sold) {
                    totalSoldDresses += Number(entry.sold);
                }

                totalProfit += Number(entry.profit) || 0;
            });
            
            return {
                sold: totalSoldDresses + totalSoldTwoPcs + totalSoldKimonos,
                profit: totalProfit,
                entries: historyData.length,
                archiveEntries: archiveData.length
            };
        }

        function renderLayout(contentHTML) {
            const isAdmin = currentUser && currentUser.role === 'admin';
            const userToDisplay = managedUser || currentUser;
            const userName = userToDisplay ? userToDisplay.name : 'Guest';
            const userRole = userToDisplay ? userToDisplay.role.charAt(0).toUpperCase() + userToDisplay.role.slice(1) : '';

            // Navigation links for Admin
            const adminNavHTML = `
                <nav class="flex flex-col space-y-2 mt-4">
                    <button onclick="setView(VIEW_DASHBOARD); managedUser = null; toggleMobileMenu();" class="flex items-center gap-3 p-3 rounded-xl transition duration-150 ${currentView === VIEW_DASHBOARD && managedUser === null ? 'bg-indigo-700 text-white' : 'text-slate-200 hover:bg-indigo-700/50'}">
                        ${renderIcon('layout-dashboard', { class: 'w-5 h-5' })} 
                        <span class="font-medium">Admin Overview</span>
                    </button>
                    <button onclick="setView(VIEW_USERS); toggleMobileMenu();" class="flex items-center gap-3 p-3 rounded-xl transition duration-150 ${currentView === VIEW_USERS ? 'bg-indigo-700 text-white' : 'text-slate-200 hover:bg-indigo-700/50'}">
                        ${renderIcon('users', { class: 'w-5 h-5' })} 
                        <span class="font-medium">Staff Management</span>
                    </button>
                    <button onclick="setView(VIEW_PRESSURE); toggleMobileMenu();" class="flex items-center gap-3 p-3 rounded-xl transition duration-150 ${currentView === VIEW_PRESSURE ? 'bg-indigo-700 text-white' : 'text-slate-200 hover:bg-indigo-700/50'}">
                        ${renderIcon('target', { class: 'w-5 h-5' })} 
                        <span class="font-medium">Pressure Calculator</span>
                    </button>
                    <button onclick="showControllerModal(); toggleMobileMenu();" class="flex items-center gap-3 p-3 rounded-xl transition duration-150 text-slate-200 hover:bg-indigo-700/50">
                        ${renderIcon('clipboard-list', { class: 'w-5 h-5' })} 
                        <span class="font-medium">Controller Stock Log</span>
                    </button>
                    <div class="mt-4 border-t border-indigo-700 pt-4">
                        <p class="text-xs text-slate-400 font-semibold mb-2">Reports</p>
                        ${REPORT_TYPES.map(type => `
                            <button onclick="downloadMasterReport('${type}'); toggleMobileMenu();" class="flex items-center gap-3 p-2 text-sm rounded-xl transition duration-150 text-slate-300 hover:bg-indigo-700/50 w-full justify-start">
                                ${renderIcon('download', { class: 'w-4 h-4' })} Download ${type} Report
                            </button>
                        `).join('')}
                    </div>
                </nav>
            `;
            
            // Navigation links for Staff
            const staffNavHTML = `
                <nav class="flex flex-col space-y-2 mt-4">
                    <button onclick="setView(VIEW_DASHBOARD); managedUser = currentUser; toggleMobileMenu();" class="flex items-center gap-3 p-3 rounded-xl transition duration-150 ${currentView === VIEW_DASHBOARD ? 'bg-indigo-700 text-white' : 'text-slate-200 hover:bg-indigo-700/50'}">
                        ${renderIcon('layout-dashboard', { class: 'w-5 h-5' })} 
                        <span class="font-medium">My Dashboard</span>
                    </button>
                    <button onclick="showEntryModal(); toggleMobileMenu();" class="flex items-center gap-3 p-3 rounded-xl transition duration-150 text-slate-200 hover:bg-indigo-700/50">
                        ${renderIcon('plus-circle', { class: 'w-5 h-5' })} 
                        <span class="font-medium">New Sales Entry</span>
                    </button>
                    <button onclick="showBalanceModal(); toggleMobileMenu();" class="flex items-center gap-3 p-3 rounded-xl transition duration-150 text-slate-200 hover:bg-indigo-700/50">
                        ${renderIcon('rotate-cw', { class: 'w-5 h-5' })} 
                        <span class="font-medium">Set New Stock</span>
                    </button>
                </nav>
            `;

            // Sidebar HTML
            const sidebarHTML = `
                <!-- Desktop Sidebar -->
                <div class="hidden lg:block fixed h-full w-64 bg-indigo-800 text-white p-6 shadow-2xl">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-extrabold border-b border-indigo-700 pb-3">TRINAH DESIGNS</h2>
                    </div>
                    
                    <div class="mb-6 p-3 bg-indigo-700 rounded-xl">
                        <p class="font-semibold text-lg">${userName}</p>
                        <p class="text-sm text-indigo-300">${userRole} Account</p>
                        ${isAdmin && managedUser ? `
                            <p class="text-xs font-medium text-emerald-300 mt-1">Managing: ${managedUser.name}</p>
                        ` : ''}
                    </div>

                    ${isAdmin ? adminNavHTML : staffNavHTML}

                    <div class="absolute bottom-6 left-0 right-0 px-6">
                        <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow-md">
                            ${renderIcon('log-out', { class: 'w-5 h-5' })} Log Out
                        </button>
                    </div>
                </div>

                <!-- Mobile Menu Overlay -->
                <div id="mobile-menu-overlay" class="lg:hidden hidden fixed inset-0 bg-gray-900 opacity-50 z-40" onclick="toggleMobileMenu()"></div>

                <!-- Mobile Sidebar -->
                <div id="mobile-menu" class="lg:hidden fixed top-0 right-0 w-64 h-full bg-indigo-800 text-white p-6 shadow-2xl z-50 transform translate-x-full">
                    <div class="flex justify-between items-center mb-6 border-b border-indigo-700 pb-3">
                        <h2 class="text-xl font-extrabold">MENU</h2>
                        <button onclick="toggleMobileMenu()" class="p-1 text-slate-200 hover:text-white">
                            ${renderIcon('x', { class: 'w-6 h-6' })}
                        </button>
                    </div>
                    
                    <div class="mb-6 p-3 bg-indigo-700 rounded-xl">
                        <p class="font-semibold text-lg">${userName}</p>
                        <p class="text-sm text-indigo-300">${userRole} Account</p>
                        ${isAdmin && managedUser ? `
                            <p class="text-xs font-medium text-emerald-300 mt-1">Managing: ${managedUser.name}</p>
                        ` : ''}
                    </div>

                    ${isAdmin ? adminNavHTML : staffNavHTML}

                    <div class="mt-8">
                        <button onclick="handleLogout(); toggleMobileMenu();" class="w-full flex items-center justify-center gap-2 p-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition shadow-md">
                            ${renderIcon('log-out', { class: 'w-5 h-5' })} Log Out
                        </button>
                    </div>
                </div>
            `;
            
            // Main Content HTML
            const mainContentHTML = `
                <div class="lg:ml-64 flex flex-col min-h-screen bg-slate-100">
                    <!-- Top Bar for Mobile -->
                    <header class="lg:hidden sticky top-0 bg-white shadow-md p-4 flex justify-between items-center z-30">
                        <h1 class="text-xl font-extrabold text-indigo-700">Trinah Designs</h1>
                        <button onclick="toggleMobileMenu()" class="p-2 text-indigo-600 hover:bg-slate-100 rounded-lg">
                            ${renderIcon('menu', { class: 'w-6 h-6' })}
                        </button>
                    </header>
                    
                    <!-- Main Content Area -->
                    <main class="flex-grow">
                        ${contentHTML}
                    </main>
                    
                    <!-- Footer -->
                    <footer class="lg:ml-64 p-4 text-center text-xs text-slate-500 border-t border-slate-200 bg-white mt-auto">
                        &copy; ${new Date().getFullYear()} Trinah Designs Management System. All rights reserved.
                    </footer>
                </div>
            `;

            return sidebarHTML + mainContentHTML;
        }

        function renderApp() {
            if (!currentUser) {
                renderAuthScreen();
                return;
            }

            if (currentUser.role === 'admin' && !managedUser && currentView !== VIEW_PRESSURE) {
                renderAdminDashboard();
                return;
            }

            if (currentView === VIEW_USERS) {
                 renderUsersView();
                 return;
            }
            
            if (currentView === VIEW_PRESSURE) {
                 renderPressureView();
                 return;
            }

            // Default to user dashboard
            renderUserDashboard();
        }


        // --- Global Exports & Initializers ---
        window.renderApp = renderApp;
        window.handleLogin = handleLogin;
        window.handleLogout = handleLogout;
        window.handleAdminSetup = handleAdminSetup;
        window.handleLoginAttempt = handleLoginAttempt;
        window.toggleMobileMenu = toggleMobileMenu;
        window.closeModal = closeModal;
        window.showEntryModal = showEntryModal;
        window.handleEntrySave = handleEntrySave;
        window.handleDeleteEntry = handleDeleteEntry;
        window.showConfirmationModal = showConfirmationModal;
        window.handleFactoryReset = handleFactoryReset;
        window.manageUser = manageUser;
        window.setView = setView;
        
        // New Handlers
        window.handleSaveStaff = handleSaveStaff;
        window.handleDeleteStaff = handleDeleteStaff;
        window.handleProcurementSave = handleProcurementSave;
        window.handleDeleteProcurement = handleDeleteProcurement;
        window.handleProcurementDateChange = handleProcurementDateChange;
        window.showBalanceModal = showBalanceModal;
        window.handleBalanceSave = handleBalanceSave;
        window.addExpenseRow = addExpenseRow; 
        
        // Recovery Logic
        window.renderRecoveryScreen = renderRecoveryScreen;
        window.handleRecoveryStep1 = handleRecoveryStep1;
        window.handleRecoveryStep2 = handleRecoveryStep2;
        window.verifySystemPin = verifySystemPin;

        // New controller handlers
        window.showControllerModal = showControllerModal;
        window.handleControllerLogSave = handleControllerLogSave;
        window.handleDeleteControllerLog = handleDeleteControllerLog;
        
        // Pressure Calculator handlers
        window.setCurrentPressureStaff = setCurrentPressureStaff;
        window.showAddPressureStaffModal = showAddPressureStaffModal;
        window.handleAddPressureStaff = handleAddPressureStaff;
        window.deletePressureStaff = deletePressureStaff;
        window.showPressureLogModal = showPressureLogModal;
        window.handlePressureLogSave = handlePressureLogSave;
        window.handleDeletePressureLog = handleDeletePressureLog;
        window.addPressureExpenseRow = addPressureExpenseRow;


        window.onload = function() {
            // Load the current user session
            const sessionUser = localStorage.getItem(SESSION_KEY);
            if (sessionUser) {
                try {
                    handleLogin(JSON.parse(sessionUser));
                } catch(e) {
                    // If session data is corrupt, clear and go to auth screen
                    localStorage.removeItem(SESSION_KEY);
                    renderAuthScreen();
                }
            } else {
                renderAuthScreen();
            }
        };
    </script>
</body>
</html>
